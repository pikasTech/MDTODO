# R54 任务报告

## 任务内容

将任务状态标记从旧格式改为新格式：
- `[Processing]` → `[in_progress]`
- `[completed]` → `[completed]`

**只支持新格式**，旧标记不再识别。打开文件时自动将旧标记替换为新标记并保存文件。

## 修改文件

`src/parser/index.ts`

## 修改内容

### 1. 状态检测逻辑（第 249-252 行）

**只检测新标记格式**：

```typescript
// 判断是否完成（只支持 [completed]）
const completed = taskLine.includes('[completed]');
// 判断是否执行中（只支持 [in_progress]）
const processing = taskLine.includes('[in_progress]');
```

### 2. 标题提取逻辑（第 254-260 行）

只移除新标记格式：

```typescript
let title = content
  .replace(/\[completed\]/g, '')  // 移除 [completed]
  .replace(/\[in_progress\]/g, '')  // 移除 [in_progress]
  .replace(/(R\d+(?:\.\d+)*)/, '')  // 移除任务ID
  .replace(/^##?\s*/, '')  // 移除开头的 ##
  .trim();
```

### 3. 文件加载转换并保存（第 381-401 行）

打开文件时自动替换旧标记为新标记，并直接保存文件：

```typescript
async parseFile(uri: vscode.Uri): Promise<TodoFile> {
  const data = await vscode.workspace.fs.readFile(uri);
  const decoder = new TextDecoder('utf-8');
  let content = decoder.decode(data);

  // 【R54】自动转换旧标记为新标记，并直接保存文件
  const newContent = content
    .replace(/\[Processing\]/g, '[in_progress]')
    .replace(/\[Finished\]/g, '[completed]');

  // 如果有内容变更，直接保存文件
  if (newContent !== content) {
    const encoder = new TextEncoder();
    await vscode.workspace.fs.writeFile(uri, encoder.encode(newContent));
    content = newContent;
  }

  const tasks = this.parse(content, uri.fsPath);
  const textBlocks = this.parseTextBlocks(content);
  return { filePath: uri.fsPath, tasks, textBlocks };
}
```

## 效果

1. **只支持新格式**：`[in_progress]` 和 `[completed]`
2. **打开文件时自动替换并保存**：`[Processing]` → `[in_progress]`, `[completed]` → `[completed]`
3. **旧标记不再被识别**：如果文件中有旧标记，下次打开时会自动替换
