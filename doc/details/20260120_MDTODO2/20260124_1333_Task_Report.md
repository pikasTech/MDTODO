# R51.12 任务报告

## 任务描述

1. 跳转功能在跳转例如R1.3.2时，实际跳转到的是R1.3，需要修复，真正跳到R1.3.2
2. 双重跳转中，外层跳转后位于顶部（目前已经是这样），内层跳转后需要居中

## 问题分析

### 层级结构

```
R2 (顶级，可折叠/展开)
├── R2.1 (一级子任务)
├── R2.2 (一级子任务)
└── R2.2.1 (一级子任务，与R2.2并列)
```

**关键事实**：只有顶级任务（R1, R2, R3...）能被折叠，一级子任务（R2.1, R2.2, R2.2.1）不能被折叠，它们直接渲染在顶级任务下。

### 问题：parentId 计算错误

原代码使用 `slice(0, -1)` 来计算父任务ID：

```typescript
const parentId = taskId.split('.').slice(0, -1).join('.');
```

这导致：

| 任务ID | parentId（原代码） | 实际父任务 |
|--------|-------------------|-----------|
| R2 | 空 | - |
| R2.1 | R2 | R2 |
| R2.2 | R2 | R2 |
| R2.2.1 | R2.2 | **R2** |

**R2.2.1 的 parentId 被错误计算为 R2.2**，但 R2.2 不是可折叠的顶级任务，导致跳转判断出错。

## 解决方案

### 修改 `scrollToTask` 函数（src/webview/components/TaskList.tsx:654-657）

将 `slice(0, -1)` 改为 `slice(0, 2)`：

```typescript
// 原代码
const parentId = taskId.split('.').slice(0, -1).join('.');

// 修改后
const parentId = taskId.split('.').slice(0, 2).join('.');
```

修改后：

| 任务ID | parentId（修改后） | 实际父任务 |
|--------|-------------------|-----------|
| R2 | 空 | - |
| R2.1 | R2 | R2 |
| R2.2 | R2 | R2 |
| R2.2.1 | R2 | R2 |

现在所有一级子任务（R2.1, R2.2, R2.2.1）都正确检查顶级任务 R2 的展开状态。

## 关于居中需求

根据讨论，展开模式下所有任务统一使用顶部对齐（`block: 'start'`），不需要内层居中。折叠模式下也简化为只做一次滚动（顶部对齐），不再做双层滚动。

## 修改文件

- `src/webview/components/TaskList.tsx` - 修改 `scrollToTask` 函数的 parentId 计算逻辑

## 验证结果

- R2.2.1 正确检查 R2 的折叠状态
- 跳转 R2.2.1 时行为与 R2.1 一致
