# R34.2 执行记录

## 问题描述

R34.1 的任务1 "Tag名称改为当前文件名" 功能失效。webview面板左上角的标题没有正确显示当前打开的TODO文件名，而是显示默认标题或为空。

## 原因分析

问题出在 `extension.ts` 中的调用顺序：

```typescript
const provider = getWebviewProvider(targetFile);
provider.showPanel();  // 此时 this.currentFilePath 还未设置
await provider.loadFile(targetFile);  // loadFile 设置 currentFilePath，但不会更新标题
```

在 `webviewProvider.ts` 中：
- `showPanel()` 方法使用 `this.currentFilePath` 来获取文件名作为面板标题
- `loadFile()` 方法会设置 `this.currentFilePath = filePath`
- 但 `loadFile()` 只调用 `updateWebview()` 刷新内容，不会更新已存在面板的标题

因此，当 `showPanel()` 在 `loadFile()` 之前调用时，`currentFilePath` 为空，导致面板标题使用默认值。

## 修复方案

在 `webviewProvider.ts` 的 `loadFile()` 方法中，新增 `updatePanelTitle()` 调用，确保加载文件后更新面板标题。

### 修改内容

**文件**: `src/providers/webviewProvider.ts`

1. 新增 `updatePanelTitle()` 方法：

```typescript
/**
 * 【R34.2】更新面板标题为当前文件名
 */
private updatePanelTitle(): void {
  if (this.panel && this.currentFilePath) {
    const panelTitle = this.getFileNameFromPath(this.currentFilePath);
    this.panel.title = panelTitle;
  }
}
```

2. 修改 `loadFile()` 方法，在设置 `currentFilePath` 后调用 `updatePanelTitle()`：

```typescript
if (hasTodoFormat) {
  this.currentTasks = tasks;
  this.currentTextBlocks = textBlocks;
  this.currentFilePath = filePath;
  // 【R34.2】加载文件后更新面板标题
  this.updatePanelTitle();
  this.updateWebview();
  return true;
} else {
  // 格式不匹配时，仍显示文件名但任务列表为空
  this.currentTasks = [];
  this.currentFilePath = filePath;
  // 【R34.2】加载文件后更新面板标题
  this.updatePanelTitle();
  this.updateWebview();
  return false;
}
```

## 验证方法

1. 打开一个TODO文件（如20260120_MDTODO.md），webview标题应显示"20260120_MDTODO"
2. 打开另一个TODO文件，应创建一个新的webview面板，面板标题正确显示该文件名
3. 点击一个文件的MDTODO按钮切换到该文件，面板标题应正确更新
4. 关闭所有webview，重新打开应正常工作

## 编译验证

编译成功，无错误。

```
> vscode-mdtodo@0.0.2 compile
> tsc && webpack

webpack 5.104.1 compiled successfully in 3073 ms
webpack 5.104.1 compiled successfully in 3484 ms
```
