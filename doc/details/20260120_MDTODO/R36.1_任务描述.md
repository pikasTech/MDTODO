# R36.1 任务添加逻辑统一执行报告

## 任务目标

将新建任务和新建子任务的添加逻辑统一为公共函数，以新建任务的添加逻辑为准（带逗号）。

## 修改内容

### 1. 新增公共函数 `generateNewTaskContent`

在 `webviewProvider.ts` 中新增公共函数 `generateNewTaskContent`：

```typescript
/**
 * 生成新任务的内容模板
 * 【R36.1】统一主任务和子任务的添加逻辑
 * @param taskId 新任务ID
 * @param parentTaskId 父任务ID（如果有则为子任务）
 * @returns 新任务的内容模板字符串
 */
private generateNewTaskContent(taskId: string, parentTaskId?: string): string {
  // 构建报告文件路径
  const fileName = path.basename(this.currentFilePath, '.md');
  const reportPath = `./details/${fileName}/${taskId}_任务描述.md`;

  // 确定标题级别：主任务用 ##，子任务用 ###
  const headerLevel = parentTaskId ? '###' : '##';

  // 生成内容模板（带逗号）
  return `${headerLevel} ${taskId}\n\n, 完成任务后将详细报告写入[${taskId}](${reportPath})。`;
}
```

### 2. 修改 `handleAddTask` 函数

移除重复的任务内容生成逻辑，改为调用公共函数：

```typescript
// 【R36.1】使用公共函数生成任务内容
const newTaskContent = this.generateNewTaskContent(newId);
```

### 3. 修改 `handleAddSubTask` 函数

移除重复的任务内容生成逻辑，改为调用公共函数并传入父任务ID：

```typescript
// 【R36.1】使用公共函数生成任务内容（传入父任务ID以生成正确的标题级别）
const newTaskContent = this.generateNewTaskContent(newId, parentTaskId);
```

## 逻辑统一说明

修改前后的对比：

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 主任务标题级别 | `##` | `##`（公共函数生成） |
| 子任务标题级别 | `###` | `###`（公共函数生成） |
| 主任务内容模板 | 独立生成 | 公共函数生成 |
| 子任务内容模板 | 独立生成 | 公共函数生成 |
| 逗号格式 | 带逗号 | 带逗号（保持一致） |

## 公共函数逻辑

公共函数 `generateNewTaskContent` 的核心逻辑：
1. 根据 `parentTaskId` 参数判断是主任务还是子任务
2. 主任务使用 `##` 标题级别，子任务使用 `###` 标题级别
3. 生成统一的报告文件路径格式：`./details/{文件名}/{任务ID}_任务描述.md`
4. 生成统一的模板内容：`{标题} {任务ID}\n\n, 完成任务后将详细报告写入[{任务ID}]({报告路径})。`

## 修改文件

- `vscode-mdtodo/src/providers/webviewProvider.ts`
  - 新增：`generateNewTaskContent` 公共函数
  - 修改：`handleAddTask` 函数
  - 修改：`handleAddSubTask` 函数

## 验证建议

1. 测试添加主任务：验证生成的标题为 `##`，内容带逗号
2. 测试添加子任务：验证生成的标题为 `###`，内容带逗号
3. 验证两种方式生成的报告路径格式一致

## 总结

通过创建公共函数 `generateNewTaskContent`，成功统一了新建任务和新建子任务的添加逻辑。两个处理函数现在都调用同一个公共函数，确保了代码的一致性和可维护性。后续如需修改任务内容的生成逻辑，只需修改这一处即可。
