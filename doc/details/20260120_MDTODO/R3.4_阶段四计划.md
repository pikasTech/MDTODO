# 阶段四详细执行计划：Claude Code集成与任务执行

## 目标

实现任务执行功能，调用外部Claude Code进程，使用"start"命令开启新终端窗口。

## 前置条件

阶段三已完成，文件读写功能正常。

## 执行步骤

### 步骤4.1：实现Claude Code服务

创建 `src/services/claudeService.ts`：

```typescript
import * as vscode from 'vscode';
import { spawn, ChildProcess } from 'child_process';

export interface ExecutionResult {
  success: boolean;
  output: string;
  error?: string;
}

export class ClaudeService {
  private outputChannel: vscode.OutputChannel;
  private currentProcess: ChildProcess | undefined;

  constructor() {
    this.outputChannel = vscode.window.createOutputChannel('MDTODO Claude');
  }

  /**
   * 执行任务
   * @param todoFilePath TODO文件路径
   * @param taskId 任务ID（如 "R1", "R2.1"）
   */
  async executeTask(todoFilePath: string, taskId: string): Promise<ExecutionResult> {
    return new Promise((resolve) => {
      // 构建命令
      const command = 'cmd.exe';
      const args = ['/c', 'start', 'cmd.exe', '/k', `claude "execute ${todoFilePath} 中的 ${taskId} 任务"`];

      this.outputChannel.show();
      this.outputChannel.appendLine(`开始执行任务: ${taskId}`);
      this.outputChannel.appendLine(`命令: ${command} ${args.join(' ')}`);
      this.outputChannel.appendLine('---');

      // 启动进程（Windows使用start命令开新窗口）
      this.currentProcess = spawn('cmd.exe', ['/c', 'start', 'cmd.exe', '/k', `claude "execute ${todoFilePath} 中的 ${taskId} 任务"`], {
        detached: true,
        stdio: 'ignore',
        windowsHide: true
      });

      this.currentProcess.unref();

      // 由于使用start命令，父进程立即返回
      // 这里我们模拟返回成功
      resolve({
        success: true,
        output: `任务 ${taskId} 已提交执行，请查看新打开的终端窗口`
      });
    });
  }

  /**
   * 使用VSCode集成终端执行（备选方案）
   */
  async executeTaskInTerminal(todoFilePath: string, taskId: string): Promise<void> {
    const terminal = vscode.window.createTerminal('Claude Code');
    terminal.show();
    terminal.sendText(`claude "execute ${todoFilePath} 中的 ${taskId} 任务"`);
  }

  /**
   * 终止当前进程
   */
  terminate(): void {
    if (this.currentProcess) {
      this.currentProcess.kill();
      this.currentProcess = undefined;
    }
  }

  /**
   * 显示输出面板
   */
  showOutput(): void {
    this.outputChannel.show();
  }
}
```

### 步骤4.2：实现任务执行命令

在 `src/extension.ts` 中添加：

```typescript
import { ClaudeService } from './services/claudeService';

let claudeService: ClaudeService;

export function activate(context: vscode.ExtensionContext) {
  // 初始化服务
  claudeService = new ClaudeService();

  // ...

  // 注册任务执行命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.executeTask', async (task: TodoTask) => {
      // 确认执行
      const choice = await vscode.window.showInformationMessage(
        `确定要执行任务 ${task.id} 吗？`,
        { modal: true },
        '执行', '取消'
      );

      if (choice === '执行') {
        await claudeService.executeTask(task.filePath, task.id);
      }
    })
  );

  // 注册在终端执行命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.executeInTerminal', async (task: TodoTask) => {
      await claudeService.executeTaskInTerminal(task.filePath, task.id);
    })
  );
}
```

### 步骤4.3：配置package.json命令

更新 `package.json`：

```json
{
  "commands": [
    {
      "command": "mdtodo.executeTask",
      "title": "执行任务 (新窗口)"
    },
    {
      "command": "mdtodo.executeInTerminal",
      "title": "执行任务 (集成终端)"
    }
  ],
  "menus": {
    "treeView/item/context": [
      {
        "command": "mdtodo.executeTask",
        "when": "view == mdtodo-view",
        "group": "navigation"
      },
      {
        "command": "mdtodo.executeInTerminal",
        "when": "view == mdtodo-view",
        "group": "navigation"
      }
    ]
  }
}
```

### 步骤4.4：添加进度提示

```typescript
async function executeWithProgress(
  todoFilePath: string,
  taskId: string
): Promise<void> {
  await vscode.window.withProgress({
    location: vscode.ProgressLocation.Notification,
    title: `执行任务 ${taskId}`,
    cancellable: false
  }, async (progress) => {
    progress.report({ message: '启动Claude Code...' });

    await claudeService.executeTask(todoFilePath, taskId);

    progress.report({ message: '任务已提交' });
  });
}
```

### 步骤4.5：处理执行结果反馈

```typescript
// 在任务完成后检查结果
export async function checkExecutionStatus(taskId: string): Promise<void> {
  // 检查是否有执行结果文件
  const resultFile = vscode.Uri.joinPath(
    vscode.workspace.workspaceFolders?.[0].uri || vscode.Uri.file(''),
    'doc',
    'review',
    'details',
    '20260120_MDTODO',
    `R${taskId.replace('.', '_')}_执行结果.md`
  );

  try {
    const doc = await vscode.workspace.openTextDocument(resultFile);
    await vscode.window.showTextDocument(doc);
  } catch {
    // 文件不存在，可能任务还在执行中
  }
}
```

### 步骤4.6：跨平台适配

对于Mac/Linux，需要适配不同的启动命令：

```typescript
import { platform } from 'os';

export class ClaudeService {
  async executeTask(todoFilePath: string, taskId: string): Promise<ExecutionResult> {
    const os = platform();

    if (os === 'win32') {
      // Windows: 使用start命令
      return this.executeOnWindows(todoFilePath, taskId);
    } else if (os === 'darwin') {
      // macOS: 使用open命令
      return this.executeOnMac(todoFilePath, taskId);
    } else {
      // Linux: 直接执行或使用xterm
      return this.executeOnLinux(todoFilePath, taskId);
    }
  }

  private async executeOnWindows(todoFilePath: string, taskId: string): Promise<ExecutionResult> {
    const command = 'cmd.exe';
    const args = ['/c', 'start', 'cmd.exe', '/k', `claude "execute ${todoFilePath} 中的 ${taskId} 任务"`];

    spawn(command, args, {
      detached: true,
      stdio: 'ignore',
      windowsHide: true
    });

    return { success: true, output: '任务已提交执行' };
  }

  private async executeOnMac(todoFilePath: string, taskId: string): Promise<ExecutionResult> {
    spawn('open', ['-a', 'Terminal', `claude "execute ${todoFilePath} 中的 ${taskId} 任务"`], {
      detached: true,
      stdio: 'ignore'
    });

    return { success: true, output: '任务已提交执行' };
  }

  private async executeOnLinux(todoFilePath: string, taskId: string): Promise<ExecutionResult> {
    spawn('xterm', ['-e', 'claude', `execute ${todoFilePath} 中的 ${taskId} 任务`], {
      detached: true,
      stdio: 'ignore'
    });

    return { success: true, output: '任务已提交执行' };
  }
}
```

## 验收标准

- [ ] 点击任务可触发Claude Code执行
- [ ] 新终端窗口正常打开
- [ ] 任务指令正确传递
- [ ] 支持跨平台运行

## 预计产出

- Claude服务：`src/services/claudeService.ts`
- 更新：`src/extension.ts`
- 更新：`package.json`
