# R22.6 多行编辑修复执行

## 问题描述

1. **误删子任务问题**：编辑父任务（如 `## R12`）后，其子任务（如 `### R12.1`）被错误删除
2. **回车丢失问题**：编辑任务后，文件末尾的回车符丢失

## 问题根因分析

### 问题1：误删子任务

原代码在计算删除范围时：
```javascript
// 找到任务内容的结束位置（下一个同级或更高级别任务之前）
let contentEndIndex = lines.length;
for (let i = taskLineIndex + 1; i < lines.length; i++) {
  const line = lines[i].trim();
  if (line.match(/^##+\s+/) && line.match(/R\d+(?:\.\d+)*/)) {
    const nextMatch = line.match(/^(#+)/);
    const nextLevel = nextMatch ? nextMatch[1].length : 2;
    if (nextLevel <= taskLevel) {  // 问题：子任务（###）的 level=3 > 2，不会停止
      contentEndIndex = i;
      break;
    }
  }
}

// 计算需要删除的行数
let deleteCount = contentEndIndex - firstContentLineIndex;  // 问题：包含了子任务
```

问题在于：
- 对于 `## R12`（level=2），子任务 `### R12.1`（level=3）不会被识别为"下一个任务"
- 因此 `contentEndIndex` 会越过子任务，直到找到同级任务 `## R13`
- `deleteCount` 计算包含了子任务所在的行，导致子任务被删除

### 问题2：回车丢失

```javascript
const newContent = lines.join('\n');  // 不会在末尾添加回车
```

`Array.prototype.join('\n')` 不会在结果末尾添加额外的换行符，如果原始内容以换行符结尾，结果会丢失该换行符。

## 解决方案

### 修复后的逻辑

1. **查找内容结束位置**：保持使用 `nextLevel <= taskLevel`，用于确定任务内容的总体范围

2. **查找第一个内容行**：跳过空行和子任务标题行
   ```javascript
   for (let i = taskLineIndex + 1; i < contentEndIndex; i++) {
     const trimmed = lines[i].trim();
     if (trimmed === '') continue;  // 跳过空行
     if (trimmed.match(/^#+\s+/) && trimmed.match(/R\d+(?:\.\d+)*/)) continue;  // 跳过子任务标题
     firstContentLineIndex = i;
     break;
   }
   ```

3. **重新计算描述内容的结束位置**：从第一个内容行开始，查找下一个任务标题
   ```javascript
   let descriptionEndIndex = contentEndIndex;
   if (firstContentLineIndex !== -1) {
     for (let i = firstContentLineIndex; i < contentEndIndex; i++) {
       const trimmed = lines[i]?.trim() || '';
       if (trimmed.match(/^#+\s+/) && trimmed.match(/R\d+(?:\.\d+)*/)) {
         descriptionEndIndex = i;
         break;
       }
     }
   }
   let deleteCount = firstContentLineIndex !== -1 ? descriptionEndIndex - firstContentLineIndex : 0;
   ```

4. **保留文件末尾的回车**：
   ```javascript
   const endsWithNewline = content.endsWith('\n');
   // ... 编辑操作 ...
   let newContent = lines.join('\n');
   if (endsWithNewline && !newContent.endsWith('\n')) {
     newContent += '\n';
   }
   ```

## 修改的文件

1. `vscode-mdtodo/test/multilineEdit.test.ts` - 添加单元测试复现问题并验证修复
2. `vscode-mdtodo/src/providers/webviewProvider.ts` - 应用修复到实际代码

## 测试验证

添加了以下测试用例：

1. **误删子任务测试**：
   - 编辑带子任务的父任务不应删除子任务
   - 编辑带多行内容的父任务不应删除子任务
   - 编辑无子任务的父任务应该正常工作

2. **回车丢失测试**：
   - 文件末尾有回车时编辑不应丢失回车
   - 多行内容编辑后应该保留文件末尾回车

所有测试用例均通过。

## 修复效果

- 编辑 `## R12` 时，子任务 `### R12.1`、`### R12.2` 等不会被删除
- 文件末尾的回车符在编辑后得以保留
