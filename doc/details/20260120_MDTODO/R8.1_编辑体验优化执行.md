# R8.1 新任务编辑优化执行体验记录

## 任务描述

添加任务或者子任务，进入编辑模式后，编辑栏里面应当是空的，并且应当直接让键盘光标进入到里面。这样用户直接就能打字，而不是多点击一次。

## 修改文件列表

| 文件 | 修改内容 |
|------|---------|
| `src/webview/components/TaskList.tsx` | 添加自动聚焦逻辑和新任务空内容判断 |
| `src/providers/webviewProvider.ts` | 修改任务创建逻辑，新任务使用空标题 |

## 详细修改

### 1. TaskList.tsx 修改

**新增 ref 和状态：**

```typescript
const titleInputRef = React.useRef<HTMLDivElement>(null);
const wasInEditMode = React.useRef<boolean>(false);
```

**新增新任务判断：**

```typescript
// Check if this is a newly added task (empty title and just entered edit mode)
const isNewTask = task.title.trim() === '' && isEditMode;
```

**新增自动聚焦 useEffect：**

```typescript
// Auto-focus when entering edit mode
React.useEffect(() => {
  if (isEditMode && !wasInEditMode.current && titleInputRef.current) {
    titleInputRef.current.focus();
  }
  wasInEditMode.current = isEditMode;
}, [isEditMode]);
```

**添加 ref 到 contentEditable 元素：**

```typescript
React.createElement('div', {
  ref: titleInputRef,
  className: `task-title ${isEditMode ? 'edit-mode' : ''}`,
  contentEditable: isEditMode,
  onBlur: (e: React.FocusEvent<HTMLDivElement>) => handleTitleBlur(e, task.id),
  onKeyDown: handleTitleKeyDown,
  dangerouslySetInnerHTML: { __html: isNewTask ? '' : renderContent() },
})
```

### 2. webviewProvider.ts 修改

**修改添加任务内容（handleAddTask）：**

```typescript
// 之前：
const newTaskContent = `## ${newId}\n\n任务内容待补充。\n`;

// 之后：
const newTaskContent = `## ${newId}\n\n`;
```

**修改添加子任务内容（handleAddSubTask）：**

```typescript
// 之前：
const newTaskContent = `### ${newId}\n\n子任务内容待补充。\n`;

// 之后：
const newTaskContent = `### ${newId}\n\n`;
```

## 功能说明

### 功能1：自动聚焦

- 点击"+添加任务"或"+子任务"后，新任务自动进入编辑模式
- 编辑框自动获取焦点，光标直接定位到输入位置
- 用户无需额外点击即可直接输入任务标题

### 功能2：新任务空内容

- 新添加的任务和子任务使用空标题
- 编辑框初始内容为空，用户直接输入即可
- 避免了之前需要先删除占位符文本的不便体验

## 构建命令

```bash
npm.cmd run compile
```

## 测试步骤

1. 在 VSCode 中重新加载插件（或者重启 VSCode）
2. 打开一个 TODO 文件
3. 点击右下角的浮动"+ 添加任务"按钮
4. 观察新任务是否自动进入编辑模式，光标是否自动定位
5. 直接输入任务内容
6. 点击某个任务的"+ 子任务"按钮
7. 观察新子任务是否自动进入编辑模式并可立即输入
