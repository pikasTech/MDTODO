# R23.1 编号列表编辑修复（回滚修复）

## 问题描述

R23 修复的问题又重现了，似乎是意外回滚造成的。

如同（1. 2. ）这样的编号在编辑时会消失，这意味着编辑时没有真正获得最原始的文本。

## 问题分析

通过分析代码发现，R23 的修复方案是正确的：
1. `parser/index.ts` 中 `parseTask` 函数正确添加了 `rawContent` 参数用于保存原始内容
2. `TaskList.tsx` 中编辑时正确使用了 `rawContent` 字段

但是问题仍然存在，原因是：**`webviewProvider.ts` 中的 `serializeTasks` 方法没有传递 `rawContent` 字段到 webview**。

虽然 parser 正确设置了 `rawContent`，TaskList 也正确使用了它，但数据从 extension 传递到 webview 的过程中，`serializeTasks` 方法遗漏了这个字段，导致 webview 接收到的任务对象中 `rawContent` 为 `undefined`。

## 修复方案

修改 `webviewProvider.ts` 中的 `serializeTasks` 方法，添加 `rawContent: task.rawContent` 字段传递：

```typescript
private serializeTasks(tasks: TodoTask[]): any[] {
  return tasks.map(task => ({
    id: task.id,
    title: task.title,
    description: task.description,
    rawContent: task.rawContent,  // 【修复R23.1】添加 rawContent 传递
    completed: task.completed,
    processing: task.processing,
    children: task.children.length > 0 ? this.serializeTasks(task.children) : [],
    lineNumber: task.lineNumber,
    hasChildren: task.children.length > 0,
    level: this.getTaskLevel(task.id)
  }));
}
```

## 修改的文件

1. **src/providers/webviewProvider.ts** - 在 `serializeTasks` 方法中添加 `rawContent` 字段传递
2. **test/numberedListEdit.test.ts** - 添加 R23.1 修复验证测试

## 测试验证

运行编号列表编辑测试：
```bash
npx jest numberedListEdit
```

测试结果：
```
PASS test/numberedListEdit.test.ts
  R23 编号列表编辑测试
    问题复现
      √ 带编号列表的任务内容在解析时编号会被移除
      √ 修复后：带编号列表的任务内容应该保留编号
    编辑时获取原始内容
      √ 编辑时应该获取原始的markdown内容
      √ 编辑时应该保留括号编号格式 (1) (2)
    实际场景测试
      √ 模拟完整的编辑流程
    R23.1 修复验证：serializeTasks 传递 rawContent
      √ serializeTasks 应该传递 rawContent 字段到webview
      √ 修复前：serializeTasks 不传递 rawContent 导致编辑时编号丢失

Tests:       7 passed, 7 total
```

## 构建验证

```bash
npm run compile  # 编译成功
npx jest numberedListEdit  # 测试通过
```
