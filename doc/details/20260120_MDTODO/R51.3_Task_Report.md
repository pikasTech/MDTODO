# R51.3 任务报告：子任务块滚动阴影实现

## 任务描述

当任务块的子任务块里面有滚动条的时候，任务块应该向子任务块投影一个阴影，提示用户这个地方是被遮挡了，可以滚动上去，或者滚动下去。如果滚动到顶部那么顶部不应该有阴影，滚动到底部应该底部没有阴影，阴影暗示的是被遮挡了，可以滚动来查看的意思。

## 实现方案

### 1. CSS 样式实现

在 `src/webview/components/TaskList.css` 中添加了滚动阴影样式：

```css
/* 滚动阴影样式 */
.children.collapsed-preview::before,
.children.collapsed-preview::after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  height: 20px;
  pointer-events: none;
  z-index: 5;
  transition: opacity 0.15s ease;
}

/* 顶部阴影 - 当内容可以向上滚动时显示 */
.children.collapsed-preview::before {
  top: 0;
  background: linear-gradient(to bottom, rgba(30, 30, 30, 0.9), transparent);
  opacity: 0;
}

.children.collapsed-preview.can-scroll-up::before {
  opacity: 1;
}

/* 底部阴影 - 当内容可以向下滚动时显示 */
.children.collapsed-preview::after {
  bottom: 0;
  background: linear-gradient(to top, rgba(30, 30, 30, 0.9), transparent);
  opacity: 0;
}

.children.collapsed-preview.can-scroll-down::after {
  opacity: 1;
}
```

### 2. JavaScript 逻辑实现

在 `src/webview/components/TaskList.tsx` 的 `TaskItem` 组件中：

1. 添加滚动状态跟踪：
```tsx
const [canScrollUp, setCanScrollUp] = React.useState(false);
const [canScrollDown, setCanScrollDown] = React.useState(false);
```

2. 添加更新阴影状态的回调函数：
```tsx
const updateScrollShadows = React.useCallback(() => {
  if (childrenRef.current) {
    const element = childrenRef.current;
    const scrollTop = element.scrollTop;
    const scrollHeight = element.scrollHeight;
    const clientHeight = element.clientHeight;

    // 可以向上滚动：scrollTop > 0
    setCanScrollUp(scrollTop > 0);
    // 可以向下滚动：scrollTop + clientHeight < scrollHeight
    setCanScrollDown(scrollTop + clientHeight < scrollHeight - 1);
  }
}, []);
```

3. 添加滚动事件监听：
```tsx
React.useEffect(() => {
  const element = childrenRef.current;
  if (!element) return;

  // 初始更新阴影状态
  updateScrollShadows();

  // 滚动到底部以显示最后两个子任务（收起状态）
  if (!isExpanded && task.children && task.children.length > 2) {
    element.scrollTop = element.scrollHeight;
  }

  const handleScroll = () => {
    updateScrollShadows();
  };

  element.addEventListener('scroll', handleScroll, { passive: true });
  return () => {
    element.removeEventListener('scroll', handleScroll);
  };
}, [isExpanded, showChildrenCount, task.children, updateScrollShadows]);
```

4. 更新子任务容器的类名：
```tsx
className: `children${!isExpanded ? ' collapsed-preview' : ''}${canScrollUp ? ' can-scroll-up' : ''}${canScrollDown ? ' can-scroll-down' : ''}`
```

## 行为说明

- **顶部阴影**：当子任务容器可以向上滚动时显示（即滚动位置 > 0）
- **底部阴影**：当子任务容器可以向下滚动时显示（即滚动位置未到底）
- **无滚动时**：当内容没有超出容器范围时，不显示任何阴影
- **滚动到顶部**：顶部阴影消失，底部阴影（如果有内容）显示
- **滚动到底部**：底部阴影消失，顶部阴影（如果有内容）显示
- **中间位置**：顶部和底部阴影同时显示，提示用户可以向两个方向滚动

## 文件修改

1. `src/webview/components/TaskList.css` - 添加滚动阴影样式
2. `src/webview/components/TaskList.tsx` - 添加滚动状态跟踪和阴影类名切换逻辑

## 测试方法

1. 打开一个有很多子任务的任务（如 R1）
2. 收起该任务（点击折叠按钮）
3. 滚动子任务区域，观察阴影效果：
   - 滚动到顶部：顶部阴影消失，底部阴影显示
   - 滚动到底部：底部阴影消失，顶部阴影显示
   - 在中间位置：顶部和底部阴影同时显示
4. 展开任务后，阴影不再显示（因为没有滚动条）
