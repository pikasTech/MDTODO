# R8 功能增强执行记录

## 任务描述

1. "添加任务" 的按钮应当随时可见而不是仅仅处于 webview 的最上边，可以考虑使其浮动，这样不管滚动到哪里都可以添加。
2. 点击"+子任务" 或者 "添加任务" 后，自动滚动到对应的子任务或者任务，聚焦并使其处于编辑模式。

## 修改文件列表

| 文件 | 修改内容 |
|------|---------|
| `src/providers/webviewProvider.ts` | 添加 `notifyNewTask()` 方法，在添加任务后通知 webview 新任务ID |
| `src/webview/components/TaskList.tsx` | 添加滚动和聚焦逻辑，处理 `newTaskAdded` 消息 |
| `src/webview/components/TaskList.css` | 添加浮动按钮样式 |

## 详细修改

### 1. webviewProvider.ts 修改

添加 `notifyNewTask()` 方法用于通知 webview 新添加的任务ID：

```typescript
/**
 * 通知webview新添加的任务ID，用于滚动和聚焦
 */
private notifyNewTask(taskId: string): void {
  if (this.panel) {
    this.panel.webview.postMessage({
      type: 'newTaskAdded',
      taskId: taskId
    });
  }
}
```

在 `handleAddTask()` 和 `handleAddSubTask()` 中调用此方法。

### 2. TaskList.tsx 修改

**新增状态和 ref：**

```typescript
// 用于存储新添加的任务ID，在tasks更新后触发滚动
const [pendingScrollTaskId, setPendingScrollTaskId] = React.useState<string | null>(null);
const taskListRef = React.useRef<HTMLUListElement>(null);
```

**新增消息处理：**

```typescript
} else if (message.type === 'newTaskAdded') {
  // 设置待滚动的任务ID，tasks更新后会触发滚动
  setPendingScrollTaskId(message.taskId);
  // 确保父任务展开
  const parentId = message.taskId.split('.').slice(0, -1).join('.');
  if (parentId) {
    setExpandedTasks(prev => new Set([...prev, parentId]));
  }
}
```

**新增滚动和聚焦 effect：**

```typescript
// 当有待滚动的任务ID时，滚动到该任务并进入编辑模式
React.useEffect(() => {
  if (pendingScrollTaskId) {
    const taskElement = document.querySelector(`[data-task-id="${pendingScrollTaskId}"]`);
    if (taskElement) {
      taskElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // 进入编辑模式
      setEditModes(prev => ({ ...prev, [pendingScrollTaskId]: true }));
      // 清除待滚动标记
      setPendingScrollTaskId(null);
    }
  }
}, [pendingScrollTaskId]);
```

**新增浮动按钮 JSX：**

```jsx
// 浮动添加任务按钮
React.createElement('div', { className: 'floating-actions' },
  React.createElement('button', {
    className: 'btn btn-primary floating-add-btn',
    onClick: handleAddTask,
    title: '添加新任务'
  }, '+ 添加任务')
)
```

移除了原来的 toolbar 中的 "+ 添加任务" 按钮。

### 3. TaskList.css 修改

```css
/* 浮动操作按钮区域 */
.floating-actions {
  position: fixed;
  bottom: 60px;
  right: 20px;
  z-index: 100;
  display: flex;
  gap: 8px;
}

.floating-add-btn {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: all 0.2s ease;
}

.floating-add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
}

.floating-add-btn:active {
  transform: translateY(0);
}
```

## 功能说明

### 功能1：浮动"添加任务"按钮

- "+ 添加任务" 按钮现在固定显示在页面右下角
- 按钮位置不随页面滚动而变化
- 带有悬浮阴影效果，鼠标悬停时上浮
- 点击按钮可直接添加新任务

### 功能2：自动滚动和聚焦

- 点击"+子任务"或"添加任务"后：
  1. 系统在文件中创建新任务
  2. 重新加载任务列表
  3. Webview 收到 `newTaskAdded` 消息
  4. 自动滚动到新任务位置（平滑滚动，居中显示）
  5. 自动进入编辑模式

- 对于子任务，会自动展开父任务
- 滚动完成后自动清除待滚动标记

## 构建命令

```bash
npm.cmd run compile
```

## 测试步骤

1. 在 VSCode 中重新加载插件（或者重启 VSCode）
2. 打开一个 TODO 文件
3. 滚动任务列表到任意位置
4. 点击右下角的浮动"+ 添加任务"按钮
5. 观察是否自动滚动到新任务并进入编辑模式
6. 点击某个任务的"+ 子任务"按钮
7. 观察是否自动滚动到新子任务并进入编辑模式
