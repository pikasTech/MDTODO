# R22.3 多行编辑修复执行记录

## 任务描述

多行编辑问题已经处理了很久，希望不要再卡在这里了：
1. 在编辑模式下也应该使用成熟的支持多行的文本编辑库而不是自己做一个
2. 在进入编辑模式的时候，也应该从原始的md中再提取出待编辑的文本，而不是从非编辑模式渲染过的文本中转换为待编辑的文本，避免渲染过程影响编辑

## 问题分析

之前的实现使用 `contentEditable` div 配合 `dangerouslySetInnerHTML` 和 `<br>` 标签来模拟多行编辑：
- 问题1：`contentEditable` 不是成熟的多行编辑解决方案
- 问题2：使用 innerHTML/innerText 提取内容时会丢失或混淆换行符
- 问题3：从渲染后的HTML转换回原始文本会引入各种问题

## 解决方案

### 1. 使用原生 `<textarea>` 替代 `contentEditable`

`<textarea>` 是浏览器原生支持的多行文本编辑组件，天然支持：
- 换行符（`\n`）的正确处理
- 复制粘贴多行内容
- 撤销/重做功能
- 选区和高亮

### 2. 从原始 task.title 直接初始化编辑内容

在进入编辑模式时，直接使用从 md 文件解析的原始 `task.title`：
- 使用 `useState` (`editValue`) 管理编辑状态
- 使用 `useEffect` 在进入编辑模式时从 `task.title` 初始化
- 确保编辑的是原始内容，而非渲染后的HTML

## 代码变更

### TaskList.tsx

1. **替换 ref 类型**：
   ```typescript
   // 之前
   const titleInputRef = React.useRef<HTMLDivElement>(null);
   // 之后
   const titleInputRef = React.useRef<HTMLTextAreaElement>(null);
   ```

2. **添加编辑状态管理**：
   ```typescript
   const [editValue, setEditValue] = React.useState(task.title);

   // 进入编辑模式时从原始内容初始化
   React.useEffect(() => {
     if (isEditMode) {
       setEditValue(task.title);
     }
   }, [isEditMode, task.title]);
   ```

3. **使用 textarea 原生事件**：
   ```typescript
   // 使用 onChange 实时更新编辑值
   const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
     setEditValue(e.target.value);
   };

   // 使用 onBlur 保存（Enter完成，Escape取消）
   const handleTitleBlur = (e: React.FocusEvent<HTMLTextAreaElement>, taskId: string) => {
     const newTitle = e.currentTarget.value.trim();
     if (newTitle) {
       onSaveTitle(taskId, newTitle);
     }
   };
   ```

4. **替换渲染逻辑**：
   ```typescript
   // 编辑模式：使用textarea原生value
   isEditMode
     ? React.createElement('textarea', {
         ref: titleInputRef,
         className: 'task-title-edit',
         value: editValue,
         onChange: handleChange,
         onBlur: handleTitleBlur,
         onKeyDown: handleTitleKeyDown,
       })
   // 非编辑模式：使用marked渲染
     : React.createElement('div', {
         className: 'task-title',
         dangerouslySetInnerHTML: { __html: renderContent() }
       })
   ```

### TaskList.css

新增 `.task-title-edit` 样式：
```css
.task-title-edit {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  background-color: #1e1e1e;
  border: 1px solid #3c3c3c;
  border-radius: 3px;
  color: #e0e0e0;
  padding: 8px 12px;
  width: 100%;
  min-height: 60px;
  resize: vertical;
  outline: none;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.task-title-edit:focus {
  border-color: #007acc;
  box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
}
```

## 验证结果

- 编译成功：`npm run compile` 无错误
- 多行内容编辑功能正常工作
- Enter 键完成编辑
- Escape 键取消编辑（恢复原始内容）
- 复制粘贴多行内容正常
- 原始换行符在保存后正确保留

## 总结

通过使用原生 `<textarea>` 替代自定义的 `contentEditable` 实现：
1. 利用了成熟、可靠的多行编辑组件
2. 避免了在 HTML 和文本之间转换导致的各种问题
3. 直接从原始 md 解析内容初始化编辑，确保数据一致性
