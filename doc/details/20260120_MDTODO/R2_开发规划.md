# VSCODE插件开发规划

## 1 项目概述

### 1.1 项目目标

开发一个VSCODE插件，功能是渲染类似 `doc\review\20260108_TODO.md` 的md文件为带子任务的TODO列表界面。核心功能包括：任务树形展示、展开折叠、状态标记、实时预览、编辑功能和Claude Code集成任务执行。

### 1.2 功能需求清单

根据总需求，插件需实现以下功能：

1. **界面渲染**：将Markdown格式的TODO文件渲染为树形列表界面
2. **层级展示**：支持多级任务嵌套，主任务和子任务清晰区分
3. **展开折叠**：每个任务项可点击"+"展开子任务列表
4. **状态标记**：每个任务可点击"✓"标记完成状态
5. **状态持久化**：完成状态保存回原md文件
6. **实时预览**：监听文件变化，实时更新界面
7. **任务编辑**：点击任务进入编辑状态，修改内容后保存
8. **任务执行**：点击运行按钮触发Claude Code执行任务
9. **进程管理**：使用"start"命令开启新终端窗口执行

## 2 开发阶段划分

### 2.1 阶段一：项目初始化与基础框架

**目标**：搭建开发环境，创建项目基础结构，配置构建工具

**主要任务**：
- 初始化VSCODE插件项目（TypeScript）
- 配置Webpack/esbuild构建工具
- 创建基础目录结构
- 实现插件入口和激活逻辑

**交付物**：
- 可运行的插件骨架
- 构建配置完成

### 2.2 阶段二：核心TODO列表功能

**目标**：实现TreeView界面，解析Markdown文件，显示任务列表

**主要任务**：
- 实现Markdown解析器
- 创建TreeView数据提供者
- 实现任务树形展示
- 添加展开折叠功能

**交付物**：
- 可显示任务列表的TreeView
- Markdown解析模块

### 2.3 阶段三：文件读写与状态同步

**目标**：实现文件读取、状态保存、实时监听功能

**主要任务**：
- 实现TODO文件读取
- 实现状态保存（完成标记写入文件）
- 添加文件变化监听
- 实现实时预览同步

**交付物**：
- 文件读写模块
- 状态同步功能

### 2.4 阶段四：Claude Code集成与任务执行

**目标**：实现任务执行功能，调用外部Claude Code进程

**主要任务**：
- 实现Claude Code调用接口
- 创建终端执行进程
- 实现参数传递（"execute {path} 中的 RXX 任务"）
- 实现执行状态反馈

**交付物**：
- 任务执行功能
- 终端集成

### 2.5 阶段五：测试优化与功能完善

**目标**：完善功能细节，优化用户体验，全面测试

**主要任务**：
- 实现任务编辑功能
- 优化UI交互细节
- 添加错误处理
- 完整功能测试

**交付物**：
- 完整可用的插件
- 测试报告

## 3 模块分解

### 3.1 核心模块

#### 3.1.1 插件入口模块（extension.ts）

**职责**：插件生命周期管理，激活/停用逻辑

**接口**：
- activate()：插件激活入口
- deactivate()：插件停用清理
- 注册所有命令和视图

#### 3.1.2 Markdown解析模块（parser.ts）

**职责**：解析TODO文件，提取任务结构

**接口**：
- parseFile(uri)：解析文件返回任务树
- parseContent(content)：解析文本内容
- updateTaskStatus(content, taskId, status)：更新任务状态
- serializeTask(task)：序列化为Markdown格式

**数据结构**：
```typescript
interface TodoTask {
  id: string;           // 任务编号，如 "R1", "R2.1"
  title: string;        // 任务标题
  description: string;  // 任务描述
  completed: boolean;   // 完成状态
  children: TodoTask[]; // 子任务列表
  parent?: TodoTask;    // 父任务引用
  lineNumber: number;   // 在文件中的行号
}
```

### 3.2 视图模块

#### 3.2.1 TreeView数据提供者（treeDataProvider.ts）

**职责**：提供TreeView所需的数据

**接口**：
- getChildren(parent?)：获取子节点
- getTreeItem(node)：获取TreeItem
- refresh()：刷新视图

#### 3.2.2 TreeView命令处理器（treeCommands.ts）

**职责**：处理TreeView中的用户交互

**命令**：
- mdtodo.toggleExpand：展开/折叠任务
- mdtodo.toggleComplete：切换完成状态
- mdtodo.editTask：编辑任务内容
- mdtodo.executeTask：执行任务

### 3.3 服务模块

#### 3.3.1 文件服务（fileService.ts）

**职责**：文件读写操作

**接口**：
- readFile(uri)：读取文件内容
- writeFile(uri, content)：写入文件
- watchFile(uri, callback)：监听文件变化

#### 3.3.2 Claude Code服务（claudeService.ts）

**职责**：Claude Code进程管理

**接口**：
- executeTask(todoFilePath, taskId)：执行任务
- getOutput()：获取执行输出
- terminate()：终止进程

### 3.4 WebView模块（可选）

**职责**：提供更丰富的编辑界面

**组件**：
- webviewProvider.ts：WebView内容提供者
- index.html：WebView页面
- main.ts：WebView交互逻辑

## 4 技术架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    VSCODE 插件宿主                           │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    extension.ts                       │  │
│  │         (插件入口，生命周期管理，命令注册)              │  │
│  └───────────────────────────────────────────────────────┘  │
│                          │                                  │
│          ┌───────────────┼───────────────┐                  │
│          ▼               ▼               ▼                  │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐     │
│  │ TreeView模块  │ │ 文件服务模块  │ │ Claude服务    │     │
│  │ treeProvider  │ │ fileService   │ │ claudeService │     │
│  │ treeCommands  │ │               │ │               │     │
│  └───────────────┘ └───────────────┘ └───────────────┘     │
│                          │                                  │
│                          ▼                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   parser.ts                           │  │
│  │              (Markdown解析与序列化)                    │  │
│  └───────────────────────────────────────────────────────┘  │
│                          │                                  │
│                          ▼                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                 VSCODE Workspace API                  │  │
│  │              (文件读写，事件监听，终端)                 │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 5 文件目录结构

```
vscode-mdtodo/
├── package.json              # 插件配置
├── tsconfig.json             # TypeScript配置
├── webpack.config.js         # 构建配置（可选）
├── src/
│   ├── extension.ts          # 插件入口
│   ├── parser/
│   │   ├── index.ts          # 解析器入口
│   │   ├── tokenizer.ts      # Markdown词法分析
│   │   └── taskBuilder.ts    # 任务树构建
│   ├── providers/
│   │   ├── treeDataProvider.ts   # TreeView数据提供者
│   │   └── treeViewCommand.ts    # TreeView命令处理
│   ├── services/
│   │   ├── fileService.ts    # 文件服务
│   │   └── claudeService.ts  # Claude Code服务
│   └── types/
│       └── index.ts          # 类型定义
├── resources/
│   ├── icons/                # 图标资源
│   │   ├── expand.svg
│   │   ├── collapse.svg
│   │   ├── completed.svg
│   │   └── execute.svg
│   └── webview/              # WebView资源（可选）
│       ├── index.html
│       └── styles.css
├── test/
│   └── parser.test.ts        # 解析器测试
└── README.md                 # 项目说明
```

## 6 关键依赖

### 6.1 核心依赖

- `vscode`：VSCODE扩展API类型定义

### 6.2 开发依赖

- `typescript`：TypeScript编译
- `webpack`/`esbuild`：代码打包
- `@types/vscode`：VSCODE类型定义
- `jest`/`vitest`：单元测试

### 6.3 可选依赖

- `marked`：Markdown解析（如需更完整的Markdown支持）
- `front-matter`：解析文件头部元数据

## 7 里程碑

| 里程碑 | 阶段 | 目标 | 验收标准 |
|-------|------|------|---------|
| M1 | 阶段一 | 基础框架 | 插件可加载，TreeView可见 |
| M2 | 阶段二 | 核心功能 | 任务列表显示，展开折叠正常 |
| M3 | 阶段三 | 数据持久化 | 完成状态保存，文件同步 |
| M4 | 阶段四 | 任务执行 | Claude Code可触发执行 |
| M5 | 阶段五 | 功能完善 | 全部功能可用，稳定运行 |

## 8 风险与应对

### 8.1 技术风险

1. **Markdown解析复杂度**：TODO格式可能有多种变体
   - 应对：先实现基础解析，预留扩展接口

2. **文件同步冲突**：多编辑器同时修改同一文件
   - 应对：实现乐观锁机制，保存前检查版本

3. **进程执行跨平台**：Windows/Mac/Linux命令差异
   - 应对：使用VSCODE Terminal API，屏蔽平台差异

### 8.2 进度风险

1. **需求变更**：功能范围可能扩展
   - 应对：模块间解耦，便于后续扩展

## 9 下一步行动

1. 执行R3：编写各阶段详细执行计划
2. 执行R3.1：项目初始化与基础框架详细计划
3. 执行R4.1：开始阶段一开发
