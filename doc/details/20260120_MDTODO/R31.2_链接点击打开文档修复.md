# R31.2 链接点击打开文档修复执行记录

## 任务描述

R31.1 的任务依然没有真正实现，点击链接后仍然显示的通知是"选中任务"而不是跳转了。

## 问题分析

通过查阅 VSCode 插件开发文档，发现 `handleOpenLink` 方法存在以下问题：

1. **相对路径解析错误**：使用 `vscode.Uri.file(url)` 直接将相对路径当作绝对路径，导致无法正确打开文件
2. **URL 编码问题**：marked 渲染的链接包含中文时会被 URL 编码（如 `本地打包实现.md` → `%E6%9C%AC%E5%9C%B0%E6%89%93%E5%8C%85%E5%AE%9E%E7%8E%B0.md`），需要正确解码
3. **双重编码**：有时会出现双重 URL 编码（`%25`），需要多次解码
4. **marked 链接转换**：marked 默认会将相对链接转换为基于当前文档的完整 URL

## 修复方案

### 1. 修改 webviewProvider.ts - handleOpenLink 方法

```typescript
private async handleOpenLink(url: string): Promise<void> {
  try {
    console.log('[MDTODO] handleOpenLink 收到 URL:', url);

    if (url.startsWith('http://') || url.startsWith('https://')) {
      // 网页链接：在外部浏览器中打开
      await vscode.env.openExternal(vscode.Uri.parse(url));
      console.log('[MDTODO] 已打开网页链接:', url);
    } else {
      // 处理 file:// URL 协议
      if (url.startsWith('file://')) {
        // 移除 file:// 前缀
        url = url.slice(7);
      }

      // 处理可能的双重 URL 编码
      // 如果包含 %25（编码的 %），说明被编码了两次
      let decodedUrl = decodeURIComponent(url);
      if (decodedUrl !== decodedUrl.toLowerCase() || decodedUrl.includes('%25')) {
        // 尝试再次解码
        decodedUrl = decodeURIComponent(decodedUrl);
      }
      console.log('[MDTODO] 解码后的 URL:', decodedUrl);

      if (decodedUrl.startsWith('./') || decodedUrl.startsWith('../')) {
        // 相对路径：基于当前文件路径解析
        if (!this.currentFilePath) {
          vscode.window.showWarningMessage('无法确定当前文件路径');
          return;
        }

        // 获取当前文件的目录
        const currentDir = path.dirname(this.currentFilePath);
        // 解析相对路径为绝对路径
        const absolutePath = path.resolve(currentDir, decodedUrl);
        console.log('[MDTODO] 相对路径解析:', decodedUrl, '->', absolutePath);

        const uri = vscode.Uri.file(absolutePath);
        await vscode.window.showTextDocument(uri);
        console.log('[MDTODO] 已打开文档:', absolutePath);
      } else {
        // 绝对路径或其他情况
        const uri = vscode.Uri.file(decodedUrl);
        await vscode.window.showTextDocument(uri);
        console.log('[MDTODO] 已打开绝对路径:', decodedUrl);
      }
    }
  } catch (error) {
    console.error('[MDTODO] 打开链接失败:', error);
    vscode.window.showErrorMessage(`无法打开链接: ${error}`);
  }
}
```

### 2. 修改 TaskList.tsx - 配置 marked 保持原始链接

```typescript
// 配置 marked 保持相对链接不变
const renderer = new marked.Renderer();
renderer.link = (href: string | null, title: string | null, text: string) => {
  // href 可能为 null，需要处理
  if (href === null) {
    return `<a href="#" title="${title || ''}">${text}</a>`;
  }
  // 直接返回原始 href，不进行任何转换
  return `<a href="${href}" title="${title || ''}">${text}</a>`;
};
marked.use({ renderer });
```

### 3. 修复 TaskItem 组件的作用域问题

将 `handleTaskContentClick` 作为 prop 传递给 TaskItem，避免作用域错误。

## 关键改进

1. **正确解析相对路径**：使用 `path.resolve()` 基于当前文件目录解析
2. **URL 编码处理**：使用 `decodeURIComponent()` 解码，支持双重编码
3. **处理 file:// 协议**：正确移除前缀
4. **保持 marked 原始链接**：配置渲染器不转换链接
5. **添加详细日志**：方便调试和追踪问题

## 验证方法

1. 在任务内容中添加相对路径链接，如：`[测试文档](./test.md)`
2. 点击链接，应能在 VSCode 中打开对应文档
3. 检查控制台日志确认路径解析正确

## 执行构建

```bash
cd vscode-mdtodo
npm run compile
```
