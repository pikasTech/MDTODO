# R12.4 换行符数量修复

## 问题描述

现在添加的 `\n` 过多了，多了一个。

## 问题分析

原代码在 `handleSaveTitle` 中处理换行符时存在问题：

1. 当任务标题和内容之间没有空行时，直接用 `\n\n${newTitle}` 替换内容行
2. 但原内容行本身可能已经以换行符结尾，导致多出一个换行符

例如：
- 原文件：`## R12.4\n任务内容\n`
- 编辑后变成：`## R12.4\n\n\n任务内容`（多了一个空行）

## 修复内容

**文件**: `vscode-mdtodo/src/providers/webviewProvider.ts`

### 1. 新内容行插入（contentLineIndex === -1）

根据现有换行符情况智能添加：

```typescript
if (contentLineIndex === -1) {
  contentLineIndex = taskLineIndex + 1;
  // 检查任务标题行末尾是否已有换行，以及下一行是否已有换行
  const taskLineEndsWithNewline = lines[taskLineIndex].endsWith('\n');
  const nextLineHasNewline = lines[contentLineIndex]?.endsWith('\n');
  if (taskLineEndsWithNewline && nextLineHasNewline) {
    // 两个换行符都已存在，直接插入内容
    lines.splice(contentLineIndex, 0, newTitle);
  } else if (taskLineEndsWithNewline || nextLineHasNewline) {
    // 只有一个换行符，补一个
    lines.splice(contentLineIndex, 0, `\n${newTitle}`);
  } else {
    // 需要两个换行符
    lines.splice(contentLineIndex, 0, `${newTitle}\n\n`);
  }
}
```

### 2. 已有内容行更新（contentLineIndex !== -1）

根据任务标题行是否已有换行符来决定：

```typescript
if (contentLineIndex === taskLineIndex + 1) {
  // 检查任务标题行末尾是否已有换行
  const taskLineEndsWithNewline = lines[taskLineIndex].endsWith('\n');
  if (taskLineEndsWithNewline) {
    lines[contentLineIndex] = `\n${newTitle}`;
  } else {
    lines[contentLineIndex] = `\n\n${newTitle}`;
  }
}
```

### 3. 额外修复：executeJavaScript -> postMessage

将 `executeJavaScript`（不存在于 VSCode Webview API）改为 `postMessage`：

```typescript
// 调用 webview 的 refreshTaskTitle 方法来更新单个任务
if (this.panel) {
  this.panel.webview.postMessage({
    type: 'refreshTaskTitle',
    taskId: taskId,
    title: newTitle
  });
}
```

## 构建验证

```bash
cd vscode-mdtodo
npm run compile
# 构建成功
```

## 验证步骤

1. 在 VSCode 中打开插件项目
2. 重新加载窗口（Ctrl+Shift+P -> "Reload Window"）
3. 打开一个 TODO 文件（如 20260120_MDTODO.md）
4. 双击一个任务进入编辑模式
5. 修改内容，按回车键
6. 验证 md 文件中任务标题和内容之间只有一个空行

## 状态

- [x] 换行符数量修复完成
- [x] API 调用方式修复完成
- [x] 构建验证通过
