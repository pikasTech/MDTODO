# R22.5 多行内容编辑修复执行

## 问题描述

进入编辑状态时显示内容正确，但多行内容回写 markdown 时存在重复问题。原因是将多行内容替换到原来 markdown 的单行时，原来的除第一行外的其他行被保留，导致内容重复。

## 问题根因

`handleSaveTitle` 方法（`vscode-mdtodo/src/providers/webviewProvider.ts:189-297`）只更新了第一个内容行：

```typescript
// 找到内容行
contentLineIndex = i;
lines[contentLineIndex] = newTitle;  // 只更新了这一行
break;
```

当任务原来有多行内容时（如3行），只替换了第1行，第2、3行旧内容仍然保留。

## 修复方案

修改 `handleSaveTitle` 方法，正确计算需要替换的内容行范围：

1. 找到任务内容的结束位置（下一个同级或更高级别任务之前）
2. 查找第一个内容行的位置（跳过空行）
3. 计算需要删除的行数
4. 使用 `splice` 一次性删除旧内容并插入新内容

## 修改文件

- `vscode-mdtodo/src/providers/webviewProvider.ts` - `handleSaveTitle` 方法

## 关键代码变更

```typescript
// 修复前：只更新第一行
contentLineIndex = i;
lines[contentLineIndex] = newTitle;
break;

// 修复后：计算内容范围并完整替换
// 找到任务内容的结束位置
let contentEndIndex = lines.length;
for (let i = taskLineIndex + 1; i < lines.length; i++) {
  const line = lines[i].trim();
  if (line.match(/^##+\s+/) && line.match(/R\d+(?:\.\d+)*/)) {
    const nextMatch = line.match(/^(#+)/);
    const nextLevel = nextMatch ? nextMatch[1].length : 2;
    if (nextLevel <= taskLevel) {
      contentEndIndex = i;
      break;
    }
  }
}

// 查找第一个内容行
let firstContentLineIndex = -1;
for (let i = taskLineIndex + 1; i < contentEndIndex; i++) {
  if (lines[i].trim() !== '') {
    firstContentLineIndex = i;
    break;
  }
}

// 计算删除行数并替换
let deleteCount = contentEndIndex - firstContentLineIndex;
if (deleteCount < 0) deleteCount = 0;
lines.splice(firstContentLineIndex, deleteCount, newTitle);
```

## 单元测试

新建 `vscode-mdtodo/test/multilineEdit.test.ts`，包含 7 个测试用例：

| 测试用例 | 描述 |
|---------|------|
| 问题：单行内容编辑为多行内容 | 验证单行改多行的基本场景 |
| 问题：原有多行内容编辑时旧内容残留 | **真正复现bug**，原有多行时旧内容残留 |
| 修复后：单行内容编辑为多行内容 | 验证修复后正确性 |
| 多行内容编辑为另一多行内容 | 多行改多行场景 |
| 多行内容编辑为单行内容 | 多行改单行场景 |
| 无内容任务添加内容 | 空内容添加新内容 |
| 任务内容末尾有空行 | 处理末尾空行 |

## 测试结果

```
PASS test/multilineEdit.test.ts
  多行内容编辑测试
    多行内容编辑问题复现
      √ 问题：单行内容编辑为多行内容会导致重复
      √ 问题：原有多行内容编辑时旧内容残留（真正复现bug）
      √ 修复后：单行内容编辑为多行内容应该正确替换
      √ 多行内容编辑为另一多行内容应该正确替换
      √ 多行内容编辑为单行内容应该正确替换
      √ 无内容任务添加内容应该正确插入
      √ 任务内容末尾有空行应该正确处理

Test Suites: 6 passed, 6 total
Tests:       2 skipped, 84 passed, 86 total
```

所有 84 个测试通过，修复无副作用。
