# 阶段三详细执行计划：文件读写与状态同步

## 目标

实现TODO文件读取、状态保存、文件变化监听，完成完成标记与文件的同步。

## 前置条件

阶段二已完成，任务列表可正常显示。

## 执行步骤

### 步骤3.1：实现文件服务

创建 `src/services/fileService.ts`：

```typescript
import * as vscode from 'vscode';

export class FileService {
  /**
   * 读取文件内容
   */
  async readFile(uri: vscode.Uri): Promise<string> {
    try {
      const data = await vscode.workspace.fs.readFile(uri);
      const decoder = new TextDecoder('utf-8');
      return decoder.decode(data);
    } catch (error) {
      console.error('读取文件失败:', error);
      throw error;
    }
  }

  /**
   * 写入文件内容
   */
  async writeFile(uri: vscode.Uri, content: string): Promise<void> {
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(content);
      await vscode.workspace.fs.writeFile(uri, data);
    } catch (error) {
      console.error('写入文件失败:', error);
      throw error;
    }
  }

  /**
   * 监听文件变化
   */
  watchFile(
    uri: vscode.Uri,
    callback: (e: vscode.FileChangeEvent[]) => void
  ): vscode.Disposable {
    const watcher = vscode.workspace.createFileSystemWatcher(
      uri.fsPath,
      false,
      false,
      false
    );

    watcher.onDidChange(callback);

    return new vscode.Disposable(() => {
      watcher.dispose();
    });
  }

  /**
   * 获取当前工作区的TODO文件
   */
  async findTodoFiles(): Promise<vscode.Uri[]> {
    const pattern = new vscode.RelativePattern('**/*TODO*.md');
    const files = await vscode.workspace.findFiles(pattern);
    return files;
  }
}
```

### 步骤3.2：实现状态管理器

创建 `src/services/statusService.ts`：

```typescript
import * as vscode from 'vscode';
import { FileService } from './fileService';
import { TodoTask } from '../types';

export class StatusService {
  constructor(
    private fileService: FileService,
    private context: vscode.ExtensionContext
  ) {}

  /**
   * 标记任务完成
   */
  async markComplete(filePath: string, taskId: string): Promise<void> {
    const content = await this.fileService.readFile(vscode.Uri.file(filePath));

    // 替换任务标题，添加 [Finished]
    const updatedContent = content.replace(
      new RegExp(`^(##?\\s*${taskId}(?:[^\\n]*))`, 'm'),
      (match) => {
        if (match.includes('[Finished]')) {
          return match; // 已经完成
        }
        return match + ' [Finished]';
      }
    );

    await this.fileService.writeFile(vscode.Uri.file(filePath), updatedContent);
  }

  /**
   * 取消任务完成状态
   */
  async unmarkComplete(filePath: string, taskId: string): Promise<void> {
    const content = await this.fileService.readFile(vscode.Uri.file(filePath));

    const updatedContent = content.replace(
      new RegExp(`^(##?\\s*${taskId}(?:[^\\n]*))\\[Finished\\]`, 'm'),
      '$1'
    );

    await this.fileService.writeFile(vscode.Uri.file(filePath), updatedContent);
  }

  /**
   * 保存全局状态（用户设置）
   */
  saveGlobalState<T>(key: string, value: T): void {
    this.context.globalState.update(`mdtodo.${key}`, value);
  }

  /**
   * 读取全局状态
   */
  getGlobalState<T>(key: string): T | undefined {
    return this.context.globalState.get(`mdtodo.${key}`);
  }
}
```

### 步骤3.3：实现文件监听

在 `src/extension.ts` 中添加：

```typescript
import { FileService } from './services/fileService';
import { StatusService } from './services/statusService';

let fileService: FileService;
let statusService: StatusService;
let fileWatcher: vscode.Disposable | undefined;

export function activate(context: vscode.ExtensionContext) {
  // 初始化服务
  fileService = new FileService();
  statusService = new StatusService(fileService, context);

  // 注册文件监听
  setupFileWatcher(context);

  // ...
}

function setupFileWatcher(context: vscode.ExtensionContext): void {
  // 监听TODO文件变化
  const todoPattern = new vscode.RelativePattern('**/*TODO*.md');

  const watcher = vscode.workspace.createFileSystemWatcher(
    todoPattern,
    false,
    false,
    false
  );

  // 文件变化时刷新TreeView
  watcher.onDidChange(async (uri) => {
    const content = await fileService.readFile(uri);
    const tasks = parser.parse(content, uri.fsPath);
    treeDataProvider.refresh(tasks, uri.fsPath);
  });

  context.subscriptions.push(watcher);
}
```

### 步骤3.4：实现打开TODO文件命令

```typescript
export function activate(context: vscode.ExtensionContext) {
  // ...

  // 注册打开TODO文件命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.openFile', async () => {
      const files = await fileService.findTodoFiles();

      if (files.length === 0) {
        vscode.window.showInformationMessage('未找到TODO文件');
        return;
      }

      if (files.length === 1) {
        // 只有一个文件，直接打开
        await openTodoFile(files[0]);
      } else {
        // 多个文件，让用户选择
        const selected = await vscode.window.showQuickPick(
          files.map(f => ({
            label: vscode.workspace.asRelativePath(f),
            uri: f
          })),
          { placeHolder: '选择TODO文件' }
        );

        if (selected) {
          await openTodoFile(selected.uri);
        }
      }
    })
  );
}

async function openTodoFile(uri: vscode.Uri): Promise<void> {
  // 打开文件
  const doc = await vscode.window.showTextDocument(uri);

  // 解析并显示
  const content = await fileService.readFile(uri);
  const tasks = parser.parse(content, uri.fsPath);
  treeDataProvider.refresh(tasks, uri.fsPath);
}
```

### 步骤3.5：实现完成/取消完成命令

```typescript
export function activate(context: vscode.ExtensionContext) {
  // ...

  // 标记完成命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.markComplete', async (task: TodoTask) => {
      await statusService.markComplete(task.filePath, task.id);
      // 刷新视图
      await refreshCurrentView();
    })
  );

  // 取消完成命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.markIncomplete', async (task: TodoTask) => {
      await statusService.unmarkComplete(task.filePath, task.id);
      // 刷新视图
      await refreshCurrentView();
    })
  );
}

async function refreshCurrentView(): Promise<void> {
  const files = await fileService.findTodoFiles();
  if (files.length > 0) {
    const content = await fileService.readFile(files[0]);
    const tasks = parser.parse(content, files[0].fsPath);
    treeDataProvider.refresh(tasks, files[0].fsPath);
  }
}
```

### 步骤3.6：添加工具栏按钮

在 `package.json` 中添加菜单项：

```json
{
  "menus": {
    "view/title": [
      {
        "command": "mdtodo.openFile",
        "group": "navigation",
        "when": "view == mdtodo-view"
      }
    ],
    "treeView/item/context": [
      {
        "command": "mdtodo.markComplete",
        "when": "view == mdtodo-view && viewItem == task",
        "group": "inline"
      }
    ]
  }
}
```

## 验收标准

- [ ] 可以打开并读取TODO文件
- [ ] 标记完成状态后文件内容更新
- [ ] 文件外部修改后视图自动刷新
- [ ] 支持多个TODO文件选择

## 预计产出

- 文件服务：`src/services/fileService.ts`
- 状态服务：`src/services/statusService.ts`
- 更新：`src/extension.ts`
