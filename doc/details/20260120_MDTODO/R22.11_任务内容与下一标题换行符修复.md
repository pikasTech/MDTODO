# R22.11 任务内容与下一标题间换行符修复执行记录

## 问题描述

R22.8 的期望效果又失效了，编辑任务后，任务内容块和下一个任务标题之间的两个 `\n` 变成了 1 个 `\n`。

**期望格式**（markdown 语法要求）：
```markdown
## R1 任务一

这是第一行内容

## R2 任务二
```

**实际结果**：编辑后变成
```markdown
## R1 任务一

这是第一行内容
## R2 任务二
```

任务内容块和下一个任务标题之间只有一个换行符，而不是两个。

## 问题根因分析

1. **代码逻辑问题**：在 `handleSaveTitle` 方法中，替换内容块后没有确保在任务内容和下一个任务标题之间有足够的换行符。

2. **换行符处理理解偏差**：之前尝试通过添加两个空字符串来获得两个换行符，但 `join('\n')` 的行为是只在元素之间添加一个换行符。

   - `['a', '', 'b'].join('\n')` = `'a\n\nb'`（两个换行符，正确）
   - `['a', '', 'b', ''].join('\n')` = `'a\n\nb\n'`（只有1个换行符在末尾）

3. **关键发现**：在内容后添加一个空字符串（不是两个），然后让下一个任务直接复制到结果中，可以正确获得两个换行符。

## 修复方案

### 核心思路

1. 在任务内容后添加一个空行
2. 复制同级任务时，下一个任务标题直接跟在空行后面
3. `join('\n')` 会产生：...内容 + '\n' + '' + '\n' + 下一个任务 = 两个换行符

### 具体修改

**修改文件**：`vscode-mdtodo/src/providers/webviewProvider.ts`

```typescript
// 添加新内容（如果 newTitle 非空）
if (newTitle.trim()) {
  // 确保任务标题和内容之间有一个空行
  // ...（原有逻辑保持不变）

  // 添加新内容行
  newLines.push(newTitle);

  // 【修复R22.11】在内容后添加一个空行，确保内容块和下一个任务标题之间有两个换行符
  // 结构：任务内容后跟一个空行，然后下一个任务
  // join('\n') 会产生：...内容\n\n下一个任务...
  newLines.push('');

  // 如果有子任务，复制子任务内容
  if (subtaskStartIndex !== -1 && subtaskStartIndex < contentEndIndex) {
    // 复制子任务内容（从子任务开始到同级任务之前）
    for (let i = subtaskStartIndex; i < contentEndIndex; i++) {
      newLines.push(lines[i]);
    }
  }
}
```

## 单元测试

新增 R22.11 测试用例：

```typescript
describe('R22.11 任务内容与下一标题间换行符测试', () => {
  test('R22.11: 编辑后任务内容块和下一个任务标题之间应该有两个换行符', () => {
    const content = `## R1 任务一

这是第一行内容
这是第二行内容

## R2 任务二`;

    const result = simulateHandleSaveTitleForR22(content, 'R1', '编辑后的内容');

    // 【核心验证】任务内容块和下一个任务标题之间应该有两个换行符
    const r1ToR2Match = result.match(/编辑后的内容\n\n## R2/);
    expect(r1ToR2Match).not.toBeNull();
  });

  test('R22.11: 单行内容编辑后也应该保持两个换行符', () => {
    // ... 测试单行内容编辑
  });

  test('R22.11: 连续编辑应该保持正确的换行符结构', () => {
    // ... 测试连续编辑
  });

  test('R22.11: 编辑最后一个任务时', () => {
    // ... 测试最后一个任务的边界情况
  });
});
```

## 验证结果

- 所有 10 个单元测试通过（6 个 R22.10 测试 + 4 个 R22.11 测试）
- 编辑后任务标题和内容之间保持两个换行符
- 编辑后任务内容和下一个任务标题之间保持两个换行符
- 连续编辑不会导致换行符累积或丢失

## 修改文件清单

| 文件 | 修改内容 |
|-----|---------|
| `vscode-mdtodo/src/providers/webviewProvider.ts` | 在 `handleSaveTitle` 方法中添加内容后的空行处理逻辑 |
| `vscode-mdtodo/test/multiline-edit.test.ts` | 添加 R22.11 测试用例，验证换行符结构 |
| `doc/review/20260120_MDTODO.md` | 更新 R22.11 状态为 [completed] |
