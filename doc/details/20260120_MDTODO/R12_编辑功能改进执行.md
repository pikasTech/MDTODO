# R12 编辑功能改进执行记录

## 任务概述

改进编辑功能：
1. 双击任务进入编辑模式
2. 编辑模式完成后正确同步到 md 文件
3. 在编辑模式下回车完成编辑

## 执行时间

2026-01-21

## 修改文件

1. `vscode-mdtodo/src/webview/components/TaskList.tsx`
2. `vscode-mdtodo/src/providers/webviewProvider.ts`

## 修改内容

### 1. 双击任务进入编辑模式

**文件**: `TaskList.tsx`

**修改内容**:
- 添加 `handleDoubleClick` 函数用于双击进入编辑模式
- 将 `onDoubleClick` 事件传递给 `TaskItem` 组件
- 在 `task-card` 元素上添加 `onDoubleClick` 事件处理器

**关键代码变更**:
```typescript
// 添加双击处理函数
const handleDoubleClick = (taskId: string) => {
  setEditModes((prev) => ({
    ...prev,
    [taskId]: true,
  }));
};

// 在 task-card 上添加双击事件
React.createElement('div', {
  className: 'task-card',
  onDoubleClick: () => onDoubleClick(task.id),
}, ...
```

### 2. 实现 handleSaveTitle 完整逻辑

**文件**: `webviewProvider.ts`

**修改内容**:
- 重写 `handleSaveTitle` 方法，实现完整的文件更新逻辑
- 读取 md 文件内容
- 精确查找任务行（避免部分 ID 匹配问题，如 R1 误匹配 R10）
- 保留原始任务 ID 和状态标记（如 `[Finished]`），只更新标题内容
- 写入更新后的内容到文件
- 重新加载文件刷新显示

**关键代码变更**:
```typescript
private async handleSaveTitle(taskId: string, newTitle: string): Promise<void> {
  if (!this.currentFilePath) {
    vscode.window.showWarningMessage('请先打开一个TODO文件');
    return;
  }

  try {
    const fileService = new FileService();
    const content = await fileService.readFile(vscode.Uri.file(this.currentFilePath));
    const lines = content.split('\n');

    // 找到任务所在的行（使用精确匹配）
    let taskLineIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      const taskPattern = new RegExp(`^##+\\s+[^\\n]*\\b${taskId.replace(/\./g, '\\.')}(?:[)\\s]|$)`);
      if (taskPattern.test(line)) {
        taskLineIndex = i;
        break;
      }
    }

    if (taskLineIndex === -1) {
      vscode.window.showWarningMessage(`未找到任务 ${taskId}`);
      return;
    }

    // 更新任务标题行，保留原始格式
    const originalLine = lines[taskLineIndex];
    const match = originalLine.match(/^(#+)\s+(R\d+(?:\.\d+)*)(.*)$/i);

    if (match) {
      const [, hashes, id, rest] = match;
      lines[taskLineIndex] = `${hashes} ${id}${rest} ${newTitle}`;
    }

    const newContent = lines.join('\n');
    await fileService.writeFile(vscode.Uri.file(this.currentFilePath), newContent);

    // 重新加载文件
    await this.loadFile(this.currentFilePath);
    vscode.window.showInformationMessage(`任务 ${taskId} 标题已更新`);
  } catch (error: any) {
    vscode.window.showErrorMessage(`保存标题失败: ${error.message}`);
  }
}
```

### 3. 回车完成编辑功能（已存在）

**文件**: `TaskList.tsx`

**说明**: 回车完成编辑功能已在之前的版本中实现，通过 `handleTitleKeyDown` 函数处理：

```typescript
const handleTitleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
  const target = e.currentTarget as HTMLDivElement;
  if (e.key === 'Enter') {
    e.preventDefault();
    target.blur();  // 触发 onBlur -> handleTitleBlur -> onSaveTitle
  }
  if (e.key === 'Escape') {
    target.blur();
  }
};
```

## 测试建议

1. **双击测试**: 双击任务卡片，验证是否进入编辑模式
2. **编辑保存测试**:
   - 点击"编辑"按钮或双击任务进入编辑模式
   - 修改标题内容
   - 点击"完成"按钮
   - 验证 md 文件中标题是否正确更新
3. **回车测试**:
   - 进入编辑模式
   - 修改内容后按回车
   - 验证是否保存成功
4. **边界测试**:
   - 带有 `[Finished]` 状态的任务
   - 嵌套子任务（R12.1 等）
   - 长标题内容

## 注意事项

1. 文件路径必须正确设置，否则无法保存
2. 使用精确匹配避免 ID 部分匹配问题
3. 保留原始格式（标题级别 `#` 数量、状态标记等）
