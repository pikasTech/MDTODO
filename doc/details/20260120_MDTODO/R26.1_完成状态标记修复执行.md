# R26.1 完成状态标记修复执行记录

## 问题描述

R26 修复完成后，完成状态标记功能又不能使用了。点击复选框后只显示通知消息，但没有实际修改 markdown 文件中的 `[Finished]` 标记。

## 问题分析

查看代码发现 `handleMarkComplete` 方法（第682-687行）仍然只显示通知消息：

```typescript
private async handleMarkComplete(taskId: string): Promise<void> {
  vscode.window.showInformationMessage(`任务 ${taskId} 已标记完成`);
}
```

这说明 R26 的修复可能被意外回滚或覆盖了。

## 修复方案

参考 `markTaskAsProcessing` 方法的实现模式，实现完整的 `handleMarkComplete` 和 `markTaskAsFinished` 方法：

1. **修改 `handleMarkComplete`**：获取当前任务状态，切换完成状态，刷新显示
2. **新增 `markTaskAsFinished`**：实现添加/移除 `[Finished]` 标记的逻辑

## 代码变更

### 文件：`vscode-mdtodo/src/providers/webviewProvider.ts`

#### 1. 修改 `handleMarkComplete` 方法

```typescript
/**
 * 处理标记完成
 * 切换任务的完成状态：已完成的点击后取消完成，未完成的点击后标记完成
 */
private async handleMarkComplete(taskId: string): Promise<void> {
  if (!this.currentFilePath) {
    vscode.window.showWarningMessage('请先打开一个TODO文件');
    return;
  }

  // 获取当前任务状态
  const task = this.findTask(this.currentTasks, taskId);
  if (!task) {
    vscode.window.showWarningMessage(`未找到任务 ${taskId}`);
    return;
  }

  // 切换完成状态：如果已完成则移除标记，否则添加标记
  const isComplete = !task.completed;
  await this.markTaskAsFinished(taskId, isComplete);

  // 重新加载文件并刷新显示
  await this.loadFile(this.currentFilePath);

  vscode.window.showInformationMessage(`任务 ${taskId} 已${isComplete ? '标记完成' : '取消完成'}`);
}
```

#### 2. 新增 `markTaskAsFinished` 方法

```typescript
/**
 * 设置任务的 [Finished] 状态
 * 添加或移除 [Finished] 标记，支持处理 [Processing] 标记
 */
private async markTaskAsFinished(taskId: string, isFinished: boolean): Promise<void> {
  const fileService = new FileService();
  const content = await fileService.readFile(vscode.Uri.file(this.currentFilePath));
  const lines = content.split('\n');

  // 找到任务所在的行（必须是 ## 或 ### 开头的任务标题行）
  let taskLineIndex = -1;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    // 必须匹配 ## 或 ### 开头的任务标题行，使用精确匹配避免匹配到描述行
    // 格式如: ## R26, ### R26.1, ## R26 [Finished], ## R26 [Processing]
    const taskHeaderPattern = new RegExp(`^#{2,3}\\s+[^\\n]*\\b${taskId.replace(/\./g, '\\.')}(?:[)\\s]|$)`);
    if (taskHeaderPattern.test(line)) {
      taskLineIndex = i;
      break;
    }
  }

  if (taskLineIndex === -1) {
    console.warn(`[MDTODO] 未找到任务 ${taskId}，无法设置 Finished 状态`);
    return;
  }

  const line = lines[taskLineIndex];
  const hasFinished = line.includes('[Finished]');
  const hasProcessing = line.includes('[Processing]');

  // 如果状态已经是我们要设置的状态，不做修改
  if (isFinished && hasFinished) return;
  if (!isFinished && !hasFinished) return;

  // 如果要设置为已完成，但任务正在进行中，提示用户
  if (isFinished && hasProcessing) {
    vscode.window.showWarningMessage(`任务 ${taskId} 正在执行中，请先等待执行完成`);
    return;
  }

  // 添加或移除 [Finished] 标记
  if (isFinished) {
    // 在任务ID后添加 [Finished]，在可能存在的 [Processing] 之前
    const taskIdPattern = new RegExp(`(${taskId.replace(/\./g, '\\.')})(\\s*\\[)`);
    if (taskIdPattern.test(line)) {
      lines[taskLineIndex] = line.replace(taskIdPattern, '$1 [Finished]$2');
    } else {
      lines[taskLineIndex] = line.replace(taskIdPattern, '$1 [Finished]$2');
      if (lines[taskLineIndex] === line) {
        const simplePattern = new RegExp(`(${taskId.replace(/\./g, '\\.')})(\\s*)$`);
        lines[taskLineIndex] = line.replace(simplePattern, '$1 [Finished]$2');
      }
    }
  } else {
    // 移除 [Finished] 标记
    lines[taskLineIndex] = line.replace(/\s*\[Finished\]/, '');
  }

  const newContent = lines.join('\n');
  await fileService.writeFile(vscode.Uri.file(this.currentFilePath), newContent);
  console.log(`[MDTODO] 任务 ${taskId} Finished状态设置为: ${isFinished}`);
}
```

## 功能说明

1. **状态切换**：点击未完成任务的复选框会添加 `[Finished]` 标记，点击已完成任务的复选框会移除该标记
2. **任务保护**：如果任务正在执行中（ `[Processing]`），无法标记为完成
3. **自动刷新**：标记操作完成后自动重新加载文件并刷新 webview 显示
4. **精确匹配**：使用正则表达式确保只匹配任务标题行，避免误匹配描述行

## 验证步骤

1. 打开一个 TODO 文件
2. 点击任务的复选框
3. 检查文件中的任务标题是否正确添加/移除了 `[Finished]` 标记
4. 验证 webview 中的任务完成状态是否正确更新
