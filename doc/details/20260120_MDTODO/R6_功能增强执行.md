# R6 执行报告：Webview 功能增强

## 任务概述

1. 为 webview 增加添加TODO、删除TODO、添加子TODO等功能
2. 默认全部展开TODO，并增加全部展开和全部收起的按钮

## 执行时间

2026-01-21

## 修改的文件

### 1. src/webview/components/TaskList.tsx

**新增功能：**

- `handleAddTask()` - 添加新任务
- `handleDeleteTask(taskId)` - 删除任务（带确认对话框）
- `handleAddSubTask(taskId)` - 添加子任务
- `handleExpandAll()` - 展开所有任务
- `handleCollapseAll()` - 收起所有任务

**修改内容：**

1. 添加了默认展开所有任务的逻辑：
   ```typescript
   // 默认展开所有任务
   const allTaskIds = getAllTaskIds(message.tasks || []);
   setExpandedTasks(new Set(allTaskIds));
   ```

2. 工具栏新增按钮：
   - `全部展开` - 展开所有任务
   - `全部收起` - 收起所有任务
   - `+ 添加任务` - 添加新任务

3. 每个任务卡片新增按钮：
   - `+子任务` - 在当前任务下添加子任务
   - `删除` - 删除当前任务

4. 任务层级支持：子任务自动使用 `###` 级别（父任务用 `##`）

### 2. src/webview/components/TaskList.css

新增样式：
- `.toolbar` - 工具栏样式
- `.delete-btn` - 删除按钮样式（红色）

### 3. src/providers/webviewProvider.ts

**新增消息处理：**
- `addTask` - 添加新任务
- `deleteTask` - 删除任务
- `addSubTask` - 添加子任务

**新增方法：**
- `handleAddTask()` - 处理添加任务逻辑
- `handleDeleteTask(taskId)` - 处理删除任务逻辑
- `handleAddSubTask(parentTaskId)` - 处理添加子任务逻辑
- `getAllTaskIds(tasks)` - 获取所有任务ID
- `generateNewTaskId(existingIds, parentId?)` - 生成新的任务编号

**任务编号生成规则：**
- 主任务：R1, R2, R3...（自动递增）
- 子任务：R1.1, R1.2, R2.1...（在父任务下递增）

## 功能说明

### 添加任务
1. 点击 `+ 添加任务` 按钮
2. 弹出输入框，输入任务标题
3. 自动生成任务ID（如 R7）
4. 新任务添加到文件末尾

### 删除任务
1. 点击任务卡片的 `删除` 按钮
2. 弹出确认对话框
3. 确认后删除任务及其所有内容

### 添加子任务
1. 点击任务卡片的 `+子任务` 按钮
2. 弹出输入框，输入子任务标题
3. 自动生成子任务ID（如 R1.3）
4. 子任务插入到父任务下方

### 展开/收起
- 页面加载时自动展开所有任务
- `全部展开` - 展开所有任务
- `全部收起` - 收起所有任务
- 单个任务可通过展开图标单独折叠

## 编译结果

```
webpack 5.104.1 compiled successfully
```

## 后续建议

1. 可考虑添加任务拖拽排序功能
2. 可添加批量操作功能（批量删除、批量完成）
3. 可添加任务搜索/过滤功能
