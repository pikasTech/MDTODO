# R5 独立视图实现修改记录

## 任务概述

将插件从TreeView侧边栏显示改为独立Webview面板视图，支持全屏显示、任务操作和Claude Code集成。

## 修改时间

2026-01-20

## 修改文件列表

| 文件 | 操作 | 说明 |
|------|------|------|
| `src/providers/webviewProvider.ts` | 新增 | 独立Webview面板提供者 |
| `src/extension.ts` | 修改 | 移除TreeView，使用WebviewProvider |
| `package.json` | 修改 | 更新配置，移除TreeView，新增命令 |

## 详细修改说明

### 1. 新增 `src/providers/webviewProvider.ts`

创建了全新的Webview面板提供者类，功能包括：

- **独立窗口显示**：使用 `vscode.window.createWebviewPanel` 创建可全屏的独立面板
- **任务树渲染**：HTML/CSS/JS实现的任务列表界面，支持层级展示
- **交互功能**：
  - 点击任务显示详情
  - 展开/折叠子任务
  - 标记任务完成
  - 使用Claude Code执行任务
- **实时同步**：支持文件监听和自动刷新
- **消息通信**：VSCode与Webview双向消息传递

Webview界面特性：
- 暗色主题，与VSCode风格一致
- 平滑动画效果
- 任务统计显示
- 文件路径显示

### 2. 修改 `src/extension.ts`

主要变更：
- 移除 `TodoTreeDataProvider` 导入和使用
- 新增 `TodoWebviewProvider` 导入和使用
- 移除TreeView创建代码
- 注册新命令：`mdtodo.openView`、`mdtodo.refresh`、`mdtodo.executeTask`
- 启动时自动打开独立视图

### 3. 修改 `package.json`

配置变更：
- 移除 `viewsContainers` 和 `views` 配置（删除侧边栏）
- 移除 `menus.view/title` 配置
- 新增命令配置：
  - `mdtodo.openView`：打开独立视图
  - `mdtodo.openFile`：打开TODO文件
  - `mdtodo.refresh`：刷新任务列表
  - `mdtodo.executeTask`：使用Claude执行任务
- 更新 `activationEvents` 为 `onCommand:mdtodo.openView`
- 版本号升级至 0.0.2

## 界面功能对比

| 功能 | TreeView（旧） | Webview（新） |
|------|---------------|---------------|
| 显示位置 | 侧边栏 | 独立面板（可全屏） |
| 布局 | 受限宽度 | 自适应宽度 |
| 交互 | 有限 | 丰富（点击、按钮） |
| 样式 | 系统主题 | 自定义暗色主题 |
| Claude集成 | 需手动调用 | 一键执行 |

## 命令清单

| 命令ID | 名称 | 说明 |
|--------|------|------|
| `mdtodo.openView` | 打开MDTODO独立视图 | 打开或聚焦独立任务管理视图 |
| `mdtodo.openFile` | 打开TODO文件 | 选择并加载TODO文件 |
| `mdtodo.refresh` | 刷新任务列表 | 重新解析当前文件 |
| `mdtodo.executeTask` | 使用Claude执行任务 | 通过Claude Code执行选中任务 |

## 使用方式

1. **启动插件**：执行命令 `mdtodo.openView` 或从命令面板选择"打开MDTODO独立视图"
2. **自动加载**：插件启动时自动查找并加载第一个TODO文件
3. **任务操作**：
   - 点击任务查看详情
   - 点击展开图标展开/折叠子任务
   - 点击"Claude执行"按钮启动Claude Code执行任务
   - 点击"刷新"按钮更新任务列表
4. **打开文件**：点击"打开文件"按钮可切换其他TODO文件

## 技术实现要点

1. **Webview面板**：`vscode.WebviewPanel` 提供独立窗口体验
2. **消息通信**：`webview.postMessage` 和 `onDidReceiveMessage` 实现双向通信
3. **状态持久**：`retainContextWhenHidden` 确保面板隐藏时状态不丢失
4. **文件监听**：继续使用 `FileSystemWatcher` 实时同步文件变化
5. **动态渲染**：JavaScript动态生成任务树HTML

## 后续优化建议

1. 添加任务详情面板显示任务描述和链接
2. 支持在Webview中直接编辑任务状态
3. 添加任务进度统计和可视化
4. 支持多文件切换标签页
5. 添加工具栏自定义功能
