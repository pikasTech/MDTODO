# 阶段二详细执行计划：核心TODO列表功能

## 目标

实现TreeView界面，解析Markdown文件，显示任务列表，支持展开折叠。

## 前置条件

阶段一已完成，插件项目可正常加载。

## 执行步骤

### 步骤2.1：定义类型

创建 `src/types/index.ts`：

```typescript
export interface TodoTask {
  id: string;           // 任务编号，如 "R1", "R2.1"
  title: string;        // 任务标题
  description: string;  // 任务描述（不含链接部分）
  completed: boolean;   // 完成状态
  children: TodoTask[]; // 子任务列表
  parent?: TodoTask;    // 父任务引用
  lineNumber: number;   // 在文件中的行号
  filePath: string;     // 所属文件路径
}

export interface TodoFile {
  filePath: string;
  tasks: TodoTask[];
}
```

### 步骤2.2：实现Markdown解析器

创建 `src/parser/tokenizer.ts`：

```typescript
export interface Token {
  type: 'heading' | 'task' | 'link' | 'text' | 'empty';
  content: string;
  level: number;        // 用于heading
  lineNumber: number;
}

export class Tokenizer {
  private lines: string[];

  constructor(content: string) {
    this.lines = content.split('\n');
  }

  tokenize(): Token[] {
    const tokens: Token[] = [];

    for (let i = 0; i < this.lines.length; i++) {
      const line = this.lines[i];
      const trimmed = line.trim();

      if (trimmed.startsWith('#')) {
        // 标题
        const level = this.countHashes(trimmed);
        tokens.push({
          type: 'heading',
          content: trimmed,
          level,
          lineNumber: i
        });
      } else if (trimmed.match(/^##?\s/)) {
        // 任务项（R1, R1.1等）
        tokens.push({
          type: 'task',
          content: trimmed,
          level: trimmed.startsWith('##') ? 2 : 1,
          lineNumber: i
        });
      } else {
        tokens.push({
          type: 'text',
          content: line,
          level: 0,
          lineNumber: i
        });
      }
    }

    return tokens;
  }

  private countHashes(str: string): number {
    let count = 0;
    for (const char of str) {
      if (char === '#') count++;
      else break;
    }
    return count;
  }
}
```

### 步骤2.3：实现任务树构建器

创建 `src/parser/taskBuilder.ts`：

```typescript
import { Tokenizer } from './tokenizer';
import { TodoTask } from '../types';

export class TaskBuilder {
  private tokenizer: Tokenizer;

  constructor(content: string) {
    this.tokenizer = new Tokenizer(content);
  }

  build(filePath: string): TodoTask[] {
    const tokens = this.tokenizer.tokenize();
    const rootTasks: TodoTask[] = [];
    const stack: { task: TodoTask; level: number }[] = [];

    for (const token of tokens) {
      if (token.type === 'task') {
        const task = this.parseTask(token, filePath);

        // 处理嵌套关系
        while (stack.length > 0 && stack[stack.length - 1].level >= token.level) {
          stack.pop();
        }

        if (stack.length > 0) {
          stack[stack.length - 1].task.children.push(task);
        } else {
          rootTasks.push(task);
        }

        stack.push({ task, level: token.level });
      }
    }

    return rootTasks;
  }

  private parseTask(token: any, filePath: string): TodoTask {
    const content = token.content;

    // 提取任务编号（R1, R2.1等）
    const idMatch = content.match(/##?\s*(R\d+(?:\.\d+)*)/);
    const id = idMatch ? idMatch[1] : '';

    // 提取标题（去掉任务编号和链接）
    let title = content
      .replace(/^##?\s*[^:]+:\s*/, '')  // 去掉 "R1:"
      .replace(/\[[^\]]+\]\([^)]+\)/g, '')  // 去掉 [链接]
      .trim();

    // 判断是否完成
    const completed = content.includes('[Finished]');

    return {
      id,
      title,
      description: title,
      completed,
      children: [],
      lineNumber: token.lineNumber,
      filePath
    };
  }
}
```

### 步骤2.4：创建Parser入口

创建 `src/parser/index.ts`：

```typescript
import { TaskBuilder } from './taskBuilder';
import { TodoTask, TodoFile } from '../types';

export class TodoParser {
  parse(content: string, filePath: string): TodoTask[] {
    const builder = new TaskBuilder(content);
    return builder.build(filePath);
  }

  parseFile(uri: vscode.Uri): Promise<TodoFile> {
    // 读取文件并解析
  }
}
```

### 步骤2.5：创建TreeView数据提供者

创建 `src/providers/treeDataProvider.ts`：

```typescript
import * as vscode from 'vscode';
import { TodoTask } from '../types';

export class TodoTreeDataProvider implements vscode.TreeDataProvider<TodoTask> {
  private _onDidChangeTreeData = new vscode.EventEmitter<TodoTask | undefined>();
  readonly onDidChangeTreeData = this._onDidChangeTreeData.event;

  private tasks: TodoTask[] = [];
  private filePath: string = '';

  constructor(private context: vscode.ExtensionContext) {}

  refresh(tasks: TodoTask[], filePath: string): void {
    this.tasks = tasks;
    this.filePath = filePath;
    this._onDidChangeTreeData.fire(undefined);
  }

  getTreeItem(element: TodoTask): vscode.TreeItem {
    const treeItem = new vscode.TreeItem(
      element.title,
      element.children.length > 0
        ? vscode.TreeItemCollapsibleState.Collapsed
        : vscode.TreeItemCollapsibleState.None
    );

    treeItem.id = element.id;
    treeItem.description = element.completed ? '✓ 已完成' : undefined;
    treeItem.contextValue = element.children.length > 0 ? 'parentTask' : 'task';

    // 添加命令
    treeItem.command = {
      command: 'mdtodo.selectTask',
      title: '选择',
      arguments: [element]
    };

    return treeItem;
  }

  getChildren(element?: TodoTask): vscode.ProviderResult<TodoTask[]> {
    if (!element) {
      return this.tasks;
    }
    return element.children;
  }

  getParent(element: TodoTask): vscode.ProviderResult<TodoTask> {
    return element.parent;
  }
}
```

### 步骤2.6：注册TreeView

更新 `src/extension.ts`：

```typescript
import { TodoTreeDataProvider } from './providers/treeDataProvider';
import { TodoParser } from './parser';

let treeDataProvider: TodoTreeDataProvider;
let parser: TodoParser;

export function activate(context: vscode.ExtensionContext) {
  // 初始化解析器和TreeView
  parser = new TodoParser();
  treeDataProvider = new TodoTreeDataProvider(context);

  // 注册TreeView
  const treeView = vscode.window.createTreeView('mdtodo-view', {
    treeDataProvider,
    showCollapseAll: true
  });

  context.subscriptions.push(treeView);

  // 注册命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.selectTask', (task) => {
      // 处理任务选择
    })
  );

  // 注册打开TODO文件命令
  context.subscriptions.push(
    vscode.commands.registerCommand('mdtodo.openFile', async () => {
      // 打开TODO文件
    })
  );
}
```

### 步骤2.7：配置package.json

在 `package.json` 中添加：

```json
{
  "contributes": {
    "viewsContainers": {
      "activitybar": [
        {
          "id": "mdtodo-container",
          "title": "MDTODO",
          "icon": "resources/icons/icon.svg"
        }
      ]
    },
    "views": {
      "mdtodo-container": [
        {
          "type": "tree",
          "id": "mdtodo-view",
          "name": "任务列表"
        }
      ]
    },
    "commands": [
      {
        "command": "mdtodo.openFile",
        "title": "打开TODO文件"
      }
    ]
  },
  "activationEvents": [
    "onView:mdtodo-view"
  ]
}
```

## 验收标准

- [ ] TreeView在侧边栏显示
- [ ] Markdown文件解析正确
- [ ] 任务列表以树形结构展示
- [ ] 展开折叠功能正常

## 预计产出

- 解析器模块：`src/parser/`
- TreeView提供者：`src/providers/treeDataProvider.ts`
- 更新：`src/extension.ts`
