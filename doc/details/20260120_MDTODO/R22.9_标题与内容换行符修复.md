# R22.9 标题与内容换行符修复执行记录

## 问题描述

R22.8 的修复是有效的，但存在新问题：RXX 标题行和内容行的第一行之间也应当是 2 个 `\n`，现在只有一个。

**期望格式**（markdown 语法要求）：
```markdown
## R1

第一行内容

## R2
```

**当前问题**：编辑后变成
```markdown
## R1
第一行内容

## R2
```

## 问题根因分析

R22.8 的修复确保了任务内容末尾和下一个任务标题之间有两个换行符，但没有处理任务标题和内容第一行之间的换行符。

当前代码的逻辑：
```typescript
// 新内容后添加一个换行符
const contentWithNewline = isLastTask ? newTitle : newTitle + '\n';

// 删除原有内容并插入新内容
lines.splice(taskLineIndex + 1, deleteCount, contentWithNewline);

let newContent = lines.join('\n');
```

这样会产生：`## R1\n内容\n\n## R2`，但期望是 `## R1\n\n内容\n\n## R2`。

## 修复方案

### 核心思路

1. **在新内容前添加一个空行**（`\n`），这样 `lines.join('\n')` 时会产生两个换行符
2. **同时确保内容后也有空行**（与下一个任务分隔）

### 具体修改

```typescript
// 【修复R22.9】在内容前添加一个空行，确保标题和内容之间有两个换行符
// markdown格式要求：标题和内容之间需要有一个空行（两个换行符）
// 结构：## R1\n\n第一行内容\n\n## R2
const isLastTask = descriptionEndIndex >= lines.length;

// 新内容前加一个换行符，确保标题和内容之间有两个换行符
// 插入内容 = 空行 + 新内容
const contentWithNewline = '\n' + newTitle;

// 删除原有内容并插入新内容
if (firstContentLineIndex !== -1) {
  lines.splice(taskLineIndex + 1, deleteCount, contentWithNewline);
} else {
  lines.splice(taskLineIndex + 1, 0, contentWithNewline);
}

let newContent = lines.join('\n');

// 【修复R22.9】如果不是最后一个任务，确保内容后有一个空行（与下一个任务分隔）
if (!isLastTask) {
  const titleEndPos = newContent.indexOf(newTitle) + newTitle.length;
  const afterContent = newContent.substring(titleEndPos);
  if (!afterContent.startsWith('\n\n')) {
    newContent = newContent.substring(0, titleEndPos) + '\n\n' + afterContent.substring(1);
  }
}
```

## 单元测试

新增 R22.9 标题与内容之间换行符测试用例：

```typescript
describe('R22.9 标题与内容之间换行符问题', () => {
  test('编辑后任务标题和内容之间应该有两个换行符', () => {
    // 验证：R1 标题和新内容之间应该有两个换行符
    expect(result).toContain('## R1\n\n新的第一行内容');
  });

  test('从无内容到有内容时标题和内容之间应该有两个换行符', () => {
    // 验证：R1 标题和新内容之间应该有两个换行符
    expect(result).toContain('## R1\n\n新添加的内容');
  });

  test('原始内容只有一个换行符时，编辑后应该变成两个', () => {
    // 验证：编辑后 R1 标题和新内容之间应该有两个换行符
    expect(result).toContain('## R1\n\n新的单行内容');
  });

  test('连续编辑应该保持正确的换行符结构', () => {
    // 验证：每次编辑后标题和内容之间都应该有两个换行符
    expect(content).toContain('## R1\n\nR1第二次编辑');
  });
});
```

## 验证结果

- 所有 99 个单元测试通过（2 个跳过）
- 新增的 4 个 R22.9 测试全部通过
- R22.8 的 4 个测试仍然通过
- 编辑后标题和内容之间正确保留两个换行符
- 连续编辑不会导致换行符累积增加

## 修改文件清单

| 文件 | 修改内容 |
|-----|---------|
| `vscode-mdtodo/src/providers/webviewProvider.ts` | 修复 `handleSaveTitle` 方法中的换行符处理逻辑 |
| `vscode-mdtodo/test/multilineEdit.test.ts` | 添加 R22.9 测试用例，更新 `saveTitleCurrent` 和 `saveTitleFixed` 函数 |
| `doc/review/20260120_MDTODO.md` | 更新 R22.9 状态为 [Finished] |
