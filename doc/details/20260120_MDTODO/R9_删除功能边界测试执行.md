## R9 删除功能边界测试执行

### 任务目标

删除功能存在误删问题，需要对删除功能进行全面的边界测试，确保鲁棒地解析和编辑 .md 文件。

### 发现的问题

经过深入分析 `webviewProvider.ts` 中的 `handleDeleteTask` 函数，发现以下两个主要问题：

#### 问题 1：任务 ID 部分匹配

**原代码** (行 437)：
```typescript
if (line.match(/^##+\s+/) && line.includes(taskId)) {
```

**问题**：使用 `line.includes(taskId)` 会导致部分匹配问题。例如：
- 删除 R1 时，可能错误匹配 `## R4.1`（因为 R4.1 包含字符 "R1"）

#### 问题 2：边界检测跳过已完成任务

**原代码** (行 445)：
```typescript
if (nextLine.match(/^##+\s+/) && !nextLine.includes('[completed]')) {
```

**问题**：边界检测时跳过带有 `[completed]` 标记的任务，导致：
- 删除包含已完成子任务（如 R3 包含 R3.1-R3.5）时，可能只删除到第一个非 Finished 任务
- 实际上应该基于层级（`##` vs `###`）来判断边界，而非 `[completed]` 状态

### 测试用例

创建了 `vscode-mdtodo/test/delete.test.ts` 测试文件，包含以下测试场景：

#### 基础删除功能
- 删除 R1 任务应正确识别位置
- 删除 R5 任务（已完成任务）
- 删除 R6 任务（独立视图）
- 删除 R8 任务（功能增强需求）

#### 层级边界测试
- 正确识别任务的层级（`##` vs `###`）
- 删除顶层任务应包含所有子任务内容
- 删除 R4.1 应包含其所有子任务

#### 边界情况测试
- 删除第一个任务 R1
- 删除最后一个任务 R11
- 连续删除多个任务

#### 特殊内容测试
- 删除包含链接的任务 R2
- 删除包含子任务的任务 R4.1
- 删除包含中英文混合的任务

#### 结构完整性测试
- 删除后相邻任务之间空行应保留
- 多次删除后文件结构仍有效

#### 性能与稳定性测试
- 删除操作应在合理时间内完成
- 删除不存在的任务应抛出错误
- 删除 R1 应只删除 R1 不影响 R10 R11

#### Bug 修复验证测试
- 验证原始函数删除 R3 时边界检测不完整
- 验证修复后的函数正确包含所有子任务 R3.1-R3.3
- 验证删除 R6 后的内容应正确保留 R7

### 测试结果

```
Test Suites: 4 passed, 4 total
Tests:       2 skipped, 66 passed, 68 total
```

其中 R9 相关测试全部通过（24 个测试）。

### 修复方案

修改 `webviewProvider.ts` 中的 `handleDeleteTask` 函数：

#### 修复 1：精确任务 ID 匹配

```typescript
// 修复前
if (line.match(/^##+\s+/) && line.includes(taskId)) {

// 修复后
const taskPattern = new RegExp(`^##+\\s+[^\\n]*\\b${taskId.replace(/\./g, '\\.')}(?:[)\\s]|$)`);
if (taskPattern.test(line)) {
```

#### 修复 2：基于层级判断边界

```typescript
// 修复前
if (nextLine.match(/^##+\s+/) && !nextLine.includes('[completed]')) {

// 修复后
if (nextLine.match(/^##+\s+/) && nextLine.match(/R\d+(?:\.\d+)*/)) {
```

### 测试文件

- 测试文件：`vscode-mdtodo/test/delete.test.ts`
- 测试用例文件：`vscode-mdtodo/test/fixtures/test_mdtodo.md`（复制自 `doc/review/20260120_MDTODO.md`）

### 验证方法

运行以下命令执行测试：

```bash
cd vscode-mdtodo
npm test
```

或仅运行删除相关测试：

```bash
npm test -- --testPathPatterns="delete"
```
