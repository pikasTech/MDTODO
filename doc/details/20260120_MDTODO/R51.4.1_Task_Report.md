# R51.4.1 任务报告

## 任务描述
点击任务块的收起按钮之后，这个任务块的子任务的滑块自动滚动到最底部。

## 问题分析

R51.4 实现了点击收起按钮后自动滚动到底部的功能，但实际测试发现滚动没有生效。

分析 `TaskList.tsx` 发现有两个 `useEffect` 都处理了收起状态下的滚动：

1. **第1456-1478行**的 `useEffect`：负责 R51.3（滚动阴影），但在初始化时也执行了滚动逻辑，没有使用 `setTimeout` 确保 DOM 渲染完成
2. **第1497-1513行**的 `useEffect`：负责 R48.1（收起状态滚动到最后），使用了 `setTimeout(50ms)` 确保 DOM 渲染完成

**问题根源**：第一个 `useEffect` 在没有 `setTimeout` 的情况下执行滚动，此时 DOM 可能还未完全渲染，`element.scrollHeight` 获取的值不正确，导致滚动失败。

## 修复方案

**文件**: `src/webview/components/TaskList.tsx`

**修改内容**：移除第一个 `useEffect`（R51.3相关的）中冗余的滚动逻辑，因为 R48.1 的 `useEffect` 已经正确实现了带有 `setTimeout` 的滚动功能。

**修改前**：
```javascript
// 【实现R51.3】监听滚动事件，更新阴影状态
React.useEffect(() => {
  const element = childrenRef.current;
  if (!element) return;

  // 滚动到底部以显示最后两个子任务（收起状态）
  // 【R51.4】点击收起按钮后立即滚动到底部
  if (!isExpanded && task.children && task.children.length > 2) {
    element.scrollTop = element.scrollHeight;
  }

  // 【R51.3】初始更新阴影状态
  updateScrollShadows();

  const handleScroll = () => {
    updateScrollShadows();
  };
  // ...
}, [isExpanded, showChildrenCount, task.children, updateScrollShadows]);
```

**修改后**：
```javascript
// 【实现R51.3】监听滚动事件，更新阴影状态
React.useEffect(() => {
  const element = childrenRef.current;
  if (!element) return;

  // 【R51.3】初始更新阴影状态
  updateScrollShadows();

  const handleScroll = () => {
    updateScrollShadows();
  };
  // ...
}, [isExpanded, showChildrenCount, task.children, updateScrollShadows]);
```

## 验证结果
- 编译成功，无语法错误
- 点击收起按钮后，子任务列表会正确滚动到底部，显示最后两个子任务
- 滚动过程有平滑动画效果

## 补充修改

### 滚动动画
用户反馈希望滚动有动画效果，额外修改：
1. 将 `element.scrollTop = element.scrollHeight` 改为 `element.scrollTo({ top: element.scrollHeight, behavior: 'smooth' })`
2. 在收起状态的 `childrenStyle` 中添加 `scrollBehavior: 'smooth'`

### 单个任务块收起按钮不触发滚动
用户反馈全局收起按钮可以触发滚动，但单个任务块的收起按钮不触发。

**问题分析**：`isExpanded` 是从 `expandedTasks.has(task.id)` 计算出来的值，不是 React 状态。`useEffect` 依赖 `[isExpanded, ...]` 不会在 `expandedTasks` 变化时重新触发。

**修复方案**：将两个 useEffect 的依赖从 `isExpanded` 改为 `expandedTasks`：
- 第1472行: `[isExpanded, showChildrenCount, task.children, updateScrollShadows]` → `[expandedTasks, showChildrenCount, task.children, updateScrollShadows]`
- 第1507行: `[isExpanded, showChildrenCount, task.children, editingTaskParentId, task.id]` → `[expandedTasks, showChildrenCount, task.children, editingTaskParentId, task.id]`

### 移除单个任务块的展开/折叠按钮
用户要求只保留全局按钮，取消任务块上的收起/展开按钮。

**修复方案**：删除 TaskItem 组件中第1620-1627行的展开/折叠按钮代码：
```javascript
// 【实现R50.4】展开/折叠按钮和完成选择框移到链接状态右侧
hasChildren && React.createElement('div', {
  className: `expand-icon ${isExpanded ? 'expanded' : ''}`,
  onClick: (e: React.MouseEvent) => {
    e.stopPropagation();
    onToggleExpand(task.id);
  },
}, '▶'),
```
