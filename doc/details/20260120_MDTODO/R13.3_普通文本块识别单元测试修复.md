# R13.3 普通文本块识别单元测试修复

## 任务描述

为普通文本块识别功能添加单元测试，确保复现问题并在单元测试中修复。使用当前文档（20260120_MDTODO.md）作为测试数据。

## 问题分析

### 问题1：空行处理逻辑错误

原有实现将空行作为文本块分隔符，导致文档被错误地分割成多个文本块。

**原有代码：**
```typescript
// 空行：如果在文本块中，结束当前块
else {
  if (inTextBlock && currentBlockLines.length > 0) {
    textBlocks.push({...});
    currentBlockLines = [];
    inTextBlock = false;
    blockStartLine = -1;
  }
}
```

**修复方案：**
```typescript
// 空行：保留在当前文本块中（不作为分隔符）
else {
  if (inTextBlock) {
    currentBlockLines.push(line);
  }
}
```

### 问题2：RXX识别正则过于宽松

原有正则 `/R\d+(?:\.\d+)*/i` 会错误匹配链接中的RXX（如 `[R1](./path)`）。

**修复方案：**
```typescript
// 使用正向前瞻确保RXX后面是空格、]或行尾
return /^(#{1,6}\s+)?R\d+(?:\.\d+)*(?=[\s\]]|$)/i.test(content);
```

### 问题3：任务描述被误识别为文本块

任务描述（第一个RXX任务之后的内容）不应该作为文本块。

**修复方案：**
使用 `foundFirstTask` 标记，只在遇到第一个RXX任务之前收集文本块内容。

### 问题4：代码块后空行导致文本块无法开始

当代码块后面是空行，然后才到文本内容时，文本块无法正确开始。

**修复方案：**
```typescript
// 如果不在文本块中，但遇到了空行，也开始一个文本块
else if (!foundFirstTask && !inCodeBlock) {
  inTextBlock = true;
  blockStartLine = i;
}
```

## 测试用例设计

创建了 `test/parseTextBlocks.test.ts` 文件，包含11个测试用例：

### Basic text block parsing
1. 解析第一个RXX任务之前的文本为单个块
2. 代码块内容不应包含在文本块中
3. 处理任务之间的多个文本块

### Real document parsing (20260120_MDTODO.md)
1. 正确解析实际文档
2. 第一个文本块应包含R1之前的所有内容
3. 正确识别RXX任务边界
4. 文本块不应包含任务内容

### Edge cases
1. 只有RXX任务时无文本块
2. 只有开头文本时正确解析
3. 处理嵌套代码块
4. 正确处理空行

## 测试结果

修复前：文档被解析为71个文本块
修复后：文档被正确解析为1个文本块

**所有11个测试用例通过：**
- Basic text block parsing: 3/3
- Real document parsing: 4/4
- Edge cases: 4/4

## 修改文件

1. `src/parser/index.ts` - `parseTextBlocks` 方法和 `hasRxxId` 函数
2. `test/parseTextBlocks.test.ts` - 新增单元测试文件

## 验证

运行所有测试确认没有破坏其他功能：
```
npm test
# Test Suites: 5 passed, 5 total
# Tests:       77 passed, 79 total
```

## 执行日期

2026-01-21
