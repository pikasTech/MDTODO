# R47.1 定期刷新调试日志增强执行报告

## 任务描述

没有看到R47的定期刷新生效，需要添加更多的调试日志来诊断问题。
**扩展需求**：文件无变化时也要定时刷新任务块内链接的可用状态，例如链接的文件新创建了，那么这个周期扫描应该要扫到。

## 修改内容

### 1. `showPanel` 方法添加日志

在 `src/providers/webviewProvider.ts:39-105` 的 `showPanel` 方法中添加了以下日志：

- 调用时记录传入的 filePath 和现有的 currentFilePath
- 当 panel 已存在时，记录更新标题和数据
- 当 panel 不存在时，记录创建新 panel
- **关键修复**：在 panel 已存在的情况下也调用 `startPeriodicRefresh()`，确保定时器始终监测正确的文件

### 2. `startPeriodicRefresh` 方法添加详细日志

在 `src/providers/webviewProvider.ts:107-135` 中添加了以下日志：

- 方法被调用时记录
- 记录 currentFilePath 值
- 记录 panel 是否存在
- 记录 refreshTimer 当前状态
- 只有在 currentFilePath 有效时才启动定时器
- 启动后记录监测的文件路径

### 3. `stopPeriodicRefresh` 方法添加日志

在 `src/providers/webviewProvider.ts:137-149` 中添加了以下日志：

- 方法被调用时记录
- 记录 refreshTimer 当前状态

### 4. `recordCurrentFileContent` 方法添加详细日志

在 `src/providers/webviewProvider.ts:151-175` 中添加了以下日志：

- 方法被调用时记录
- 记录 currentFilePath 值
- 记录文件是否存在
- 记录文件内容长度

### 5. `checkAndRefresh` 方法添加详细日志并支持链接状态更新

在 `src/providers/webviewProvider.ts:178-227` 中：

- 添加了定时器每次触发时的详细日志
- 文件无变化时也调用链接状态检查

### 6. 新增 `checkAndUpdateLinkStatus` 方法

在 `src/providers/webviewProvider.ts:229-280` 中新增：

- 遍历所有任务，检查链接状态是否有变化
- 如果有变化则刷新 webview 显示
- 用于定期检测新创建的链接文件

### 7. 新增 `calculateLinkStatsForTask` 方法

在 `src/providers/webviewProvider.ts:282-313` 中新增：

- 从任务原始内容中提取所有 markdown 链接
- 检查每个链接对应的文件是否存在
- 返回链接数量和存在数量

### 8. 新增 `resolveLinkPath` 方法

在 `src/providers/webviewProvider.ts:315-339` 中新增：

- 解析链接为绝对路径
- 支持相对路径（基于当前文件路径解析）
- 支持 file:// 协议和 URL 编码

## 关键发现与修复

### 问题1：panel已存在时未重启定时器

在原始代码中，当 `showPanel` 检测到 panel 已存在时（`if (this.panel)` 分支），只更新了标题和数据，没有调用 `startPeriodicRefresh()`。这可能导致：
- 首次加载后定时器正常启动
- 但后续切换文件或更新数据时，定时器没有正确重启或更新监测路径

**修复**：在 panel 已存在的分支中也调用 `startPeriodicRefresh()`，确保定时器始终监测正确的文件。

### 问题2：缺少详细的状态日志

原始代码只记录了"启动定时器"和"停止定时器"这样的简单日志，无法诊断：
- currentFilePath 是否正确
- 文件是否存在
- 文件内容对比结果
- 为什么没有触发刷新

**修复**：添加了完整的状态跟踪日志，每个关键步骤都有记录。

### 问题3：定期刷新不检测链接文件状态

原始代码只检测主文件内容是否有变化，如果主文件无变化则不执行任何操作。这导致：
- 即使任务中引用的链接文件被创建或删除，webview 中显示的链接状态图标也不会更新

**修复**：修改 `checkAndRefresh` 方法，在主文件无变化时也调用 `checkAndUpdateLinkStatus()` 来检查所有任务的链接状态。

## 如何使用调试日志验证

1. 在 VSCode 中以调试模式启动插件
2. 打开一个 TODO 文件
3. 在控制台（Debug Console）中查看以下日志：
   - `[MDTODO-R47.1] showPanel() 被调用`
   - `[MDTODO-R47.1] 已启动定期刷新定时器（5秒周期）`
4. 每5秒应该看到：
   - `[MDTODO-R47.1] checkAndRefresh() 定时器触发执行`
   - `[MDTODO-R47.1] 文件是否有变化: true/false`
   - `[MDTODO-R47.1] 开始检查链接状态...`
5. 如果在外部编辑器（如 Typora）中修改文件并保存：
   - 5秒内应该看到 `[MDTODO-R47.1] 检测到文件变化，自动刷新...`
6. 如果创建了一个新的链接文件（被任务引用）：
   - 5秒内应该看到 `[MDTODO-R47.1] 任务 Rxx 链接状态变化: 0/1 -> 1/1`
   - webview 中该任务的链接状态图标应该更新

## 日志前缀说明

所有新增日志都使用 `[MDTODO-R47.1]` 前缀，便于在控制台中过滤和搜索。

## 后续步骤

根据调试日志的结果，可能需要进一步修复以下问题：
1. 如果 `currentFilePath` 为空：检查文件加载逻辑
2. 如果文件不存在：检查路径解析
3. 如果 `lastFileContent` 长度始终为0：检查 `recordCurrentFileContent` 是否正确执行
4. 如果 `hasChanges` 始终为 false：检查文件内容对比逻辑
