# 阶段五详细执行计划：测试优化与功能完善

## 目标

完善功能细节，优化用户体验，添加错误处理，完成全面测试。

## 前置条件

阶段四已完成，核心功能可用。

## 执行步骤

### 步骤5.1：实现任务编辑功能

创建 `src/webview/taskEditor.ts`：

```typescript
import * as vscode from 'vscode';
import { TodoTask } from '../types';

export class TaskEditor {
  /**
   * 编辑任务标题
   */
  async editTitle(task: TodoTask): Promise<void> {
    const newTitle = await vscode.window.showInputBox({
      prompt: '输入新的任务标题',
      value: task.title,
      validateInput: (value) => {
        if (!value.trim()) {
          return '标题不能为空';
        }
        return undefined;
      }
    });

    if (newTitle && newTitle !== task.title) {
      await this.updateTaskTitle(task, newTitle);
    }
  }

  /**
   * 编辑任务描述
   */
  async editDescription(task: TodoTask): Promise<void> {
    // 使用文档编辑器编辑
    const doc = await vscode.workspace.openTextDocument(task.filePath);
    const editor = await vscode.window.showTextDocument(doc);

    // 跳转到任务所在行
    const position = new vscode.Position(task.lineNumber, 0);
    editor.selections = [new vscode.Selection(position, position)];
    editor.revealRange(new vscode.Range(position, position));
  }

  private async updateTaskTitle(task: TodoTask, newTitle: string): Promise<void> {
    // 读取文件
    const content = await vscode.workspace.fs.readFile(
      vscode.Uri.file(task.filePath)
    );
    const decoder = new TextDecoder('utf-8');
    let text = decoder.decode(content);

    // 替换标题
    const lines = text.split('\n');
    if (lines[task.lineNumber]) {
      const line = lines[task.lineNumber];
      // 提取任务编号部分
      const taskIdMatch = line.match(/^(##?\s*R\d+(?:\.\d+)*)/);
      if (taskIdMatch) {
        lines[task.lineNumber] = `${taskIdMatch[1]} ${newTitle}`;
        text = lines.join('\n');

        // 写回文件
        const encoder = new TextEncoder();
        await vscode.workspace.fs.writeFile(
          vscode.Uri.file(task.filePath),
          encoder.encode(text)
        );
      }
    }
  }
}
```

### 步骤5.2：添加WebView编辑器（可选增强）

创建 `src/providers/webviewProvider.ts`：

```typescript
import * as vscode from 'vscode';

export class TaskWebviewProvider {
  private panel: vscode.WebviewPanel | undefined;

  constructor(private context: vscode.ExtensionContext) {}

  /**
   * 创建或显示WebView面板
   */
  createOrShow(content: string): void {
    if (this.panel) {
      this.panel.reveal(vscode.ViewColumn.One);
      this.panel.webview.html = this.getHtml(content);
      return;
    }

    this.panel = vscode.window.createWebviewPanel(
      'taskEditor',
      '编辑任务',
      vscode.ViewColumn.One,
      {
        enableScripts: true,
        retainContextWhenHidden: true
      }
    );

    this.panel.webview.html = this.getHtml(content);

    this.panel.onDidDispose(() => {
      this.panel = undefined;
    });

    this.panel.webview.onDidReceiveMessage((message) => {
      this.handleMessage(message);
    });
  }

  private getHtml(content: string): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: var(--vscode-font-family); padding: 20px; }
          textarea { width: 100%; min-height: 200px; }
        </style>
      </head>
      <body>
        <h2>任务详情</h2>
        <textarea id="content">${content}</textarea>
        <button onclick="save()">保存</button>
        <script>
          const vscode = acquireVsCodeApi();

          function save() {
            const content = document.getElementById('content').value;
            vscode.postMessage({ type: 'save', content });
          }
        </script>
      </body>
      </html>
    `;
  }

  private handleMessage(message: any): void {
    switch (message.type) {
      case 'save':
        // 保存内容
        break;
    }
  }
}
```

### 步骤5.3：增强错误处理

```typescript
// 创建错误处理服务
export class ErrorHandler {
  private outputChannel: vscode.OutputChannel;

  constructor() {
    this.outputChannel = vscode.window.createOutputChannel('MDTODO Errors');
  }

  handle(error: Error, context: string): void {
    const message = `[${context}] ${error.message}`;
    console.error(message, error);

    // 显示错误通知
    vscode.window.showErrorMessage(`MDTODO错误: ${error.message}`);

    // 输出到通道
    this.outputChannel.appendLine(message);
    this.outputChannel.appendLine(error.stack || '');
    this.outputChannel.show();
  }

  async showRetryDialog(error: Error): Promise<boolean> {
    const choice = await vscode.window.showErrorMessage(
      `操作失败: ${error.message}`,
      { modal: true },
      '重试', '取消'
    );
    return choice === '重试';
  }
}
```

### 步骤5.4：添加单元测试

创建 `test/parser.test.ts`：

```typescript
import * as assert from 'assert';
import { TaskBuilder } from '../src/parser/taskBuilder';
import { TodoTask } from '../src/types';

suite('Parser Tests', () => {
  test('Should parse single task', () => {
    const content = `
# 总需求

## R1

任务一内容。
    `.trim();

    const builder = new TaskBuilder(content);
    const tasks = builder.build('/test/TODO.md');

    assert.strictEqual(tasks.length, 1);
    assert.strictEqual(tasks[0].id, 'R1');
  });

  test('Should parse nested tasks', () => {
    const content = `
## R1

主任务

### R1.1

子任务1

### R1.2

子任务2
    `.trim();

    const builder = new TaskBuilder(content);
    const tasks = builder.build('/test/TODO.md');

    assert.strictEqual(tasks.length, 1);
    assert.strictEqual(tasks[0].children.length, 2);
  });

  test('Should detect completed task', () => {
    const content = `
## R1 [completed]

已完成任务
    `.trim();

    const builder = new TaskBuilder(content);
    const tasks = builder.build('/test/TODO.md');

    assert.strictEqual(tasks[0].completed, true);
  });
});
```

配置 `tsconfig.json` 测试相关配置：

```json
{
  "compilerOptions": {
    "outDir": "out",
    "rootDir": "src",
    "types": ["vscode", "node", "mocha"]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "out", "test"]
}
```

### 步骤5.5：优化用户体验

#### 5.5.1 添加状态栏显示

```typescript
export function activate(context: vscode.ExtensionContext) {
  // 创建状态栏项
  const statusBar = vscode.window.createStatusBarItem(
    'mdtodo.status',
    vscode.StatusBarAlignment.Right,
    100
  );

  statusBar.text = '$(checklist) MDTODO';
  statusBar.tooltip = '点击打开TODO列表';
  statusBar.command = 'mdtodo.openFile';

  statusBar.show();
  context.subscriptions.push(statusBar);
}
```

#### 5.5.2 添加快捷键

在 `package.json` 中添加：

```json
{
  "keybindings": [
    {
      "command": "mdtodo.openFile",
      "key": "Ctrl+Shift+T",
      "when": "editorTextFocus"
    }
  ]
}
```

#### 5.5.3 添加进度指示

```typescript
async function loadTasksWithProgress(): Promise<void> {
  await vscode.window.withProgress({
    location: vscode.ProgressLocation.Treeview,
    title: '加载任务',
    cancellable: false
  }, async (progress) => {
    progress.report({ increment: 0 });
    // 加载任务...
    progress.report({ increment: 50 });
    // 完成
    progress.report({ increment: 100 });
  });
}
```

### 步骤5.6：完善文档

- 编写 `README.md`：安装说明、使用指南
- 编写 `CHANGEL.md`：版本更新日志
- 添加截图示例

### 步骤5.7：最终测试清单

- [ ] 插件加载正常
- [ ] TreeView显示正确
- [ ] 展开折叠功能正常
- [ ] 文件读取正确
- [ ] 完成状态可保存
- [ ] 文件变化自动刷新
- [ ] 任务执行可触发Claude Code
- [ ] 跨平台兼容（Windows/Mac/Linux）
- [ ] 错误提示清晰
- [ ] 单元测试通过

## 验收标准

- [ ] 所有核心功能可用
- [ ] 错误处理完善
- [ ] 单元测试通过
- [ ] 文档完整

## 预计产出

- 编辑功能模块
- 单元测试
- README文档
- 错误处理增强
