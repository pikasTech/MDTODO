# R12.3.1 编辑模式切换修复

## 任务内容

回车后依然没有切换到webview的非编辑模式。

## 问题分析

之前 R12.3 的修复方案存在时序问题：

1. 用户按回车 → `handleTitleBlur` → 调用 `handleSaveComplete` 清除编辑模式
2. Extension 处理 `saveTitle` → 写文件 → `loadFile` → 发送 `updateTasks` 消息
3. `updateTasks` 消息处理会检查 `editingTaskIdsRef` 并恢复编辑模式
4. 由于时序问题，`editingTaskIds` 还没及时同步到 ref，导致编辑模式被错误恢复

核心问题：`loadFile` 会触发全量任务刷新，覆盖之前的编辑模式状态。

## 解决方案

修改保存流程，保存成功后**不重新加载整个文件**，而是只刷新单个任务的内容：

1. Extension 保存成功后，通过 `executeJavaScript` 调用 webview 的 `refreshTaskTitle` 方法
2. Webview 收到消息后，只更新指定任务的内容，不触发全量状态刷新
3. 这样 `handleSaveComplete` 清除的编辑状态不会被覆盖

## 修改内容

### 1. webviewProvider.ts

**文件**: `vscode-mdtodo/src/providers/webviewProvider.ts`

```typescript
const newContent = lines.join('\n');
await fileService.writeFile(vscode.Uri.file(this.currentFilePath), newContent);

// 调用 webview 的 refreshTaskTitle 方法来更新单个任务
if (this.panel) {
  this.panel.webview.executeJavaScript(`
    if (window.MDTODO && window.MDTODO.refreshTaskTitle) {
      window.MDTODO.refreshTaskTitle('${taskId}', '${newTitle.replace(/'/g, "\\'")}');
    }
  `);
}

vscode.window.showInformationMessage(`任务 ${taskId} 内容已更新`);
```

### 2. index.tsx

**文件**: `vscode-mdtodo/src/webview/index.tsx`

添加 `refreshTaskTitle` 和 `updateTaskState` 全局方法：

```typescript
// 刷新单个任务标题的方法（通过全局变量暴露给外部）
window.MDTODO.refreshTaskTitle = (taskId: string, newTitle: string) => {
  // 发送消息通知 TaskList 刷新单个任务
  if (vscodeApi) {
    vscodeApi.postMessage({ type: 'refreshTaskTitle', taskId, newTitle });
  }
};

// 刷新单个任务的状态更新函数（将在 TaskList 中注册）
window.MDTODO.updateTaskState = null;
```

### 3. TaskList.tsx

**文件**: `vscode-mdtodo/src/webview/components/TaskList.tsx`

添加 `handleRefreshTaskTitle` 方法：

```typescript
// 刷新单个任务标题（外部调用）
const handleRefreshTaskTitle = (taskId: string, newTitle: string) => {
  console.log('[Webview] handleRefreshTaskTitle:', taskId, newTitle);
  setTasks((prevTasks) => {
    const updateTask = (taskList: Task[]): Task[] => {
      return taskList.map((task) => {
        if (task.id === taskId) {
          return { ...task, title: newTitle };
        }
        if (task.children && task.children.length > 0) {
          return { ...task, children: updateTask(task.children) };
        }
        return task;
      });
    };
    return updateTask(prevTasks);
  });
  // 确保任务展开
  setExpandedTasks((prev) => new Set(prev).add(taskId));
};
```

在消息处理中添加 `refreshTaskTitle` 消息处理：

```typescript
} else if (message.type === 'refreshTaskTitle') {
  // 刷新单个任务标题
  handleRefreshTaskTitle(message.taskId, message.newTitle);
}
```

注册 `updateTaskState` 到 `window.MDTODO`：

```typescript
// 注册 updateTaskState 到 window.MDTODO，供外部调用
if (typeof window !== 'undefined') {
  if (typeof window.MDTODO === 'undefined') {
    window.MDTODO = {};
  }
  window.MDTODO.updateTaskState = (taskId: string, newTitle: string) => {
    handleRefreshTaskTitle(taskId, newTitle);
  };
}
```

## 构建验证

```bash
cd vscode-mdtodo
npm.cmd run compile
# 构建成功
# extension.js 23.9 KiB
# bundle.js 64.2 KiB
```

## 验证步骤

1. 在 VSCode 中打开插件项目
2. 重新加载窗口（Ctrl+Shift+P -> "Reload Window"）
3. 打开一个 TODO 文件（如 20260120_MDTODO.md）
4. 双击一个任务进入编辑模式
5. 修改内容，按回车键
6. 验证：
   - md 文件中任务内容正确更新
   - 编辑完成后 webui 自动切换到非编辑模式（不再停留在编辑状态）

## 测试修复

测试时发现两个 bug：

1. **TaskItem 中 `handleSaveComplete` 未定义**
   - 原因：TaskItem 调用的是 `handleSaveComplete` 但 prop 名称是 `onSaveComplete`
   - 修复：将 `handleSaveComplete(taskId)` 改为 `onSaveComplete && onSaveComplete(taskId)`

2. **`newTitle` 为 undefined**
   - 原因：webviewProvider.ts 发送的字段名是 `title`，但 webview 期望的是 `newTitle`
   - 修复：将 `title: newTitle` 改为 `newTitle: newTitle`

## 状态

- [x] 问题分析完成
- [x] 解决方案设计完成
- [x] webviewProvider.ts 修改完成（改用 postMessage 发送 refreshTaskTitle）
- [x] index.tsx 修改完成
- [x] TaskList.tsx 修改完成
- [x] 构建验证通过
- [x] Bug修复1：TaskItem 中调用 onSaveComplete
- [x] Bug修复2：修正字段名为 newTitle
