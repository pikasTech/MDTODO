# R34.1 执行记录

## 任务要求

1. **Tag名称改为当前文件名**：webview面板左上角的标题应显示当前打开的TODO文件名（不带.md后缀）
2. **多webview支持**：点击MDTODO按钮时，如果当前md文件未在MDTODO webview中加载，则创建一个新的webview，而不是将已有的其他MD的webview页面跳转为新的md的webview页面

## 修改内容

### 1. webviewProvider.ts 修改

**修改位置**：`src/providers/webviewProvider.ts`

**新增方法**：`getFileNameFromPath()`
- 从文件路径提取文件名，自动移除.md后缀
- 如果没有文件路径，返回默认标题"MDTODO 任务管理"

**修改方法**：`showPanel()`
- 添加 `getFileNameFromPath()` 方法调用，将文件名作为面板标题
- 当面板已存在时，更新面板标题为当前文件名

```typescript
private getFileNameFromPath(filePath: string): string {
  if (!filePath) return 'MDTODO 任务管理';
  const baseName = path.basename(filePath);
  // 移除 .md 后缀
  return baseName.replace(/\.md$/i, '');
}
```

### 2. extension.ts 修改

**修改位置**：`src/extension.ts`

**新增内容**：

1. **webviewProviders Map**：使用 `Map<string, TodoWebviewProvider>` 管理多个provider，每个文件路径对应一个

2. **getWebviewProvider(filePath) 函数**：获取或创建指定文件的webview provider
   - 查找已存在的provider（大小写不敏感比对）
   - 不存在时创建新的provider

3. **getExtensionContext() 函数**：获取保存的extension context

4. **isWebviewOpenForFile(filePath) 函数**：检查指定文件的webview是否已打开

**修改命令**：

1. **mdtodo.openView**：使用 `getWebviewProvider()` 获取provider
2. **mdtodo.openFile**：使用 `getWebviewProvider()` 获取provider
3. **mdtodo.refresh**：使用 `getWebviewProvider()` 获取provider
4. **mdtodo.openFromPreview**：核心修改
   - 检查当前文件是否已在webview中显示
   - 如果已显示，直接切换到该面板并刷新
   - 如果未显示，创建新的webview面板

**修改文件监听器**：
- 监听文件变化时，找到对应文件的provider并刷新

**修改 deactivate()**：
- 清理所有webview provider

## 实现效果

1. **Tag名称显示**：webview面板标题现在显示当前打开的TODO文件名，如 "20260120_MDTODO"

2. **多webview支持**：
   - 每个TODO文件对应一个独立的webview面板
   - 点击一个文件的MDTODO按钮会打开该文件的webview
   - 点击另一个文件的MDTODO按钮会创建新的webview面板
   - 已打开的文件再次点击会切换到该面板并刷新内容

## 验证方法

1. 打开一个TODO文件（如20260120_MDTODO.md），webview标题应显示"20260120_MDTODO"
2. 打开另一个TODO文件，应创建一个新的webview面板
3. 再次点击第一个文件的MDTODO按钮，应切换到该面板
4. 关闭所有webview，重新打开应正常工作
