# R7 执行日志：Claude 命令工作路径与相对路径

## 执行时间

2026-01-21

## 需求说明

点击 Claude 执行的时候：
1. claude 命令行窗口的工作路径应该是当前 vscode 窗口的路径
2. 传入的 TODO 路径应当是一个相对路径

## 实现内容

### 修改文件

`src/services/claudeService.ts`

### 新增功能

1. **获取工作区路径函数** (`getWorkspaceFolderPath`)
   - 使用 `vscode.workspace.workspaceFolders` 获取当前工作区根路径
   - 返回第一个工作区的 URI 路径

2. **路径转换函数** (`toRelativePath`)
   - 使用 `path.relative()` 将绝对路径转换为相对路径
   - 统一使用正斜杠 `/` 替换反斜杠 `\`，确保跨平台兼容性

### 修改逻辑

#### executeTask 方法

```typescript
// 获取工作区路径作为工作目录
const workspacePath = getWorkspaceFolderPath();
let relativePath = todoFilePath;

if (workspacePath) {
  // 转换为相对路径
  relativePath = toRelativePath(todoFilePath, workspacePath);
  this.outputChannel.appendLine(`工作区: ${workspacePath}`);
  this.outputChannel.appendLine(`相对路径: ${relativePath}`);
}

// 设置 spawn 选项，使用工作区路径作为工作目录
const spawnOptions: any = {
  detached: true,
  stdio: 'ignore',
  windowsHide: true
};

// 如果有工作区路径，设置工作目录
if (workspacePath) {
  spawnOptions.cwd = workspacePath;
}
```

#### executeTaskInTerminal 方法

同样添加了相对路径转换逻辑，确保集成终端中也使用相对路径。

### 路径转换示例

假设工作区路径为 `D:\Work\big-paper2`：

| 绝对路径 | 相对路径 |
|---------|---------|
| `D:\Work\big-paper2\doc\review\20260120_MDTODO.md` | `doc/review/20260120_MDTODO.md` |
| `D:\Work\big-paper2\vscode-mdtodo\src\extension.ts` | `vscode-mdtodo/src/extension.ts` |

## 命令示例

修改前：
```
claude "execute D:\Work\big-paper2\doc\review\20260120_MDTODO.md 中的 R7 任务"
```

修改后：
```
claude "execute doc/review/20260120_MDTODO.md 中的 R7 任务"
```

## 执行结果

✅ 编译成功
✅ 工作区路径正确获取
✅ 相对路径正确计算
✅ spawn 选项正确设置 `cwd`

## 下一步

在 VS Code 中加载插件进行实际测试，验证：
1. 新终端窗口是否在工作区路径下打开
2. 相对路径是否正确传递给 Claude
