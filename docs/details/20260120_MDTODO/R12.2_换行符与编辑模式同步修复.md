# R12.2 换行符与编辑模式同步修复

## 任务内容

1. RXX 换行要加2个\n\n，这是 markdown 语法规定的
2. 回车后确实编辑了md文件，但是webui仍然没有切换到非编辑模式，webui也要同步切换

## 修复内容

### 1. 换行符修复

**文件**: `vscode-mdtodo/src/providers/webviewProvider.ts`

**问题**: 在 `handleSaveTitle` 中，当任务原来没有内容行时，添加新内容行没有在末尾添加换行符 `\n\n`。

**修复**: 在任务标题后添加新内容行时，在内容末尾添加 `\n\n`，符合 markdown 语法规定（任务标题和内容之间需要有空行）。

```typescript
// 修复前
if (contentLineIndex === -1) {
  contentLineIndex = taskLineIndex + 1;
  lines.splice(contentLineIndex, 0, newTitle);
}

// 修复后
if (contentLineIndex === -1) {
  contentLineIndex = taskLineIndex + 1;
  // RXX 换行要加2个\n\n，这是 markdown 语法规定的
  lines.splice(contentLineIndex, 0, `${newTitle}\n\n`);
}
```

### 2. 编辑模式同步切换修复

**文件**: `vscode-mdtodo/src/webview/index.tsx` 和 `vscode-mdtodo/src/webview/components/TaskList.tsx`

**问题**: 编辑完成后 webui 没有同步切换到非编辑模式。

**原因分析**:
1. `saveCompleteCallback` 在 `init()` 调用时可能还未被设置（因为 `useEffect` 是异步执行的）
2. `TaskList` 中通过 `useEffect` 注册回调的逻辑存在闭包问题

**修复方案**:
1. 在 `index.tsx` 中定义 `handleSaveComplete` 函数，直接引用 `saveCompleteCallback`
2. 在 `init()` 中将 `handleSaveComplete` 传递给 `TaskList`
3. 简化 `TaskList` 中的逻辑，`handleSaveComplete` 同时更新本地状态和调用外部回调

**index.tsx 修改**:
```typescript
// 在组件外部定义，避免闭包问题
const handleSaveComplete = (taskId: string) => {
  if (saveCompleteCallback) {
    saveCompleteCallback(taskId);
  }
};

// init() 中传递
React.createElement(TaskList, {
  vscodeApi,
  onSaveComplete: handleSaveComplete  // 使用外部定义的函数
})
```

**TaskList.tsx 修改**:
```typescript
// 保存完成后退出编辑模式的处理函数
const handleSaveComplete = (taskId: string) => {
  setEditModes((prev) => ({
    ...prev,
    [taskId]: false,
  }));
  // 同时调用外部回调（用于同步状态）
  if (onSaveComplete) {
    onSaveComplete(taskId);
  }
};
```

## 构建验证

```bash
cd vscode-mdtodo
npm.cmd run compile
# 构建成功
```

## 验证步骤

1. 在 VSCode 中打开插件项目
2. 重新加载窗口（Ctrl+Shift+P -> "Reload Window"）
3. 打开一个 TODO 文件
4. 双击一个没有内容行的任务进入编辑模式
5. 输入内容，按回车键
6. 验证：
   - md 文件中任务标题和内容之间有空行
   - 编辑完成后 webui 自动切换到非编辑模式

## 状态

- [x] 换行符修复完成
- [x] 编辑模式同步切换修复完成
- [x] 构建验证通过
