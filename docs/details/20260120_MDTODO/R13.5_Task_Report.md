# R13.5 执行报告：普通文本块双击修改功能

## 任务目标

普通文本块也应当能双击修改，普通文本块应该复用任务内容块的渲染和修改逻辑，抽离出公共模块。

## 实现内容

### 1. 类型定义更新

**文件**: `src/types/index.ts`

为 `TextBlock` 接口添加了 `rawContent` 字段，用于存储原始内容供编辑时使用：

```typescript
export interface TextBlock {
  id: string;           // 文本块唯一标识
  content: string;      // 文本块内容（用于显示，经过格式化处理）
  rawContent: string;   // 原始内容（用于编辑，保留所有格式）
  lineNumber: number;   // 在文件中的行号
}
```

### 2. Parser 更新

**文件**: `src/parser/index.ts`

在 `parseTextBlocks` 方法中保存原始内容：

```typescript
textBlocks.push({
  id: `text-${blockStartLine}`,
  content: currentBlockLines.join('\n').trim(),
  rawContent: currentBlockLines.join('\n'),  // 保留原始换行和格式
  lineNumber: blockStartLine
});
```

### 3. WebviewProvider 更新

**文件**: `src/providers/webviewProvider.ts`

添加了 `saveTextBlock` 消息处理和 `handleSaveTextBlock` 方法：

- 在 `handleMessage` 中添加了 `case 'saveTextBlock'`
- 新增 `handleSaveTextBlock` 方法处理普通文本块的保存逻辑

### 4. TaskList 组件更新

**文件**: `src/webview/components/TaskList.tsx`

#### 4.1 新增状态

```typescript
// 【R13.5】普通文本块编辑状态
const [textBlockEditModes, setTextBlockEditModes] = React.useState<Record<string, boolean>>({});
```

#### 4.2 新增处理函数

- `handleTextBlockDoubleClick`: 双击进入编辑模式
- `handleSaveTextBlock`: 保存文本块内容
- `handleCancelTextBlockEdit`: 取消编辑

#### 4.3 抽离公共组件 EditableContentBlock

创建了可复用的 `EditableContentBlock` 组件，复用任务内容块的编辑逻辑：

```typescript
const EditableContentBlock: React.FC<{
  content: string;           // 显示用内容
  rawContent: string;        // 编辑用原始内容
  isEditMode: boolean;       // 是否编辑模式
  onToggleEdit: () => void;  // 切换编辑模式
  onSave: (content: string) => void;   // 保存回调
  onCancel: () => void;      // 取消回调
}> = ({ content, rawContent, isEditMode, onToggleEdit, onSave, onCancel }) => {
  // ... 实现代码
}
```

该组件支持：
- 非编辑模式：使用 marked 渲染 Markdown
- 编辑模式：使用原生 textarea，支持多行编辑
- 自动聚焦并定位光标到开头
- Enter 保存，Escape 取消
- 动态高度调整（与任务编辑保持一致）

#### 4.4 更新 renderTextBlocks 函数

使用 `EditableContentBlock` 组件重构，支持双击编辑：

```typescript
const renderTextBlocks = () => {
  // ...
  return React.createElement('div', { className: 'text-blocks' },
    textBlocks.map((block) => {
      const isEditMode = textBlockEditModes[block.id] || false;
      return React.createElement('div', {
        key: block.id,
        className: 'text-block',
        'data-block-id': block.id,
        onDoubleClick: () => handleTextBlockDoubleClick(block.id),
        // ...
      },
        React.createElement(EditableContentBlock, {
          content: block.content,
          rawContent: block.rawContent,
          isEditMode: isEditMode,
          onToggleEdit: () => handleTextBlockDoubleClick(block.id),
          onSave: (content: string) => handleSaveTextBlock(block.id, content),
          onCancel: () => handleCancelTextBlockEdit(block.id)
        })
      );
    })
  );
};
```

### 5. CSS 样式更新

**文件**: `src/webview/components/TaskList.css`

添加了普通文本块的样式：

- `.text-block`: 文本块容器样式
- `.textblock-content`: 内容显示区域样式
- `.textblock-content-edit`: 编辑模式 textarea 样式
- Markdown 渲染元素的样式（与任务内容保持一致）

## 功能特点

1. **双击编辑**：普通文本块支持双击进入编辑模式
2. **复用逻辑**：使用 `EditableContentBlock` 公共组件，与任务内容编辑逻辑保持一致
3. **编辑体验**：
   - Enter 键保存
   - Escape 键取消
   - 自动聚焦并定位光标到开头
   - 动态高度调整
4. **Markdown 渲染**：非编辑模式下使用 marked 渲染 Markdown 内容
5. **链接点击**：支持点击文本块中的链接打开文档

## 测试验证

编译验证通过：

```
webpack 5.104.1 compiled successfully in 3137 ms
```

## 总结

R13.5 任务已完成，实现了以下目标：

1. ✅ 普通文本块支持双击修改
2. ✅ 抽离出 `EditableContentBlock` 公共组件
3. ✅ 复用任务内容块的渲染和修改逻辑
4. ✅ 保持了与任务编辑一致的用户体验
