# R30.4 完整打包安装更新脚本实现

## 任务目标

修改 `install.bat` 脚本，使其包含完整的打包、安装、更新全过程。无论任何时候运行 `install.bat` 都应该重新打包并安装更新最新的插件。

## 修改内容

### 脚本流程变化

**修改前（2步流程）**：
1. 检查 VSIX 文件是否存在
2. 安装扩展

**修改后（4步完整流程）**：
1. 构建项目 (`npm.cmd run compile`)
2. 打包 VSIX (`npx vsce package`)
3. 卸载旧版本（如果存在）
4. 安装/更新新版本

### 核心改进

1. **自动打包**：每次运行都会重新编译并打包，确保使用最新代码
2. **先卸载后安装**：通过 `--uninstall-extension` 先卸载旧版本，再安装新版本，确保更新完全
3. **版本号自动更新**：由于每次都是重新打包，版本号会由 `vsce package` 自动处理

## 脚本代码

```batch
@echo off
chcp 65001 >nul
echo ============================================
echo VSCode MDTODO Plugin Install Script
echo ============================================
echo.

cd /d "%~dp0"
setlocal

echo [1/4] Building project...
echo.
call npm.cmd run compile
if errorlevel 1 (
    echo ERROR: Build failed!
    exit /b 1
)
echo Build completed.
echo.

echo [2/4] Packaging VSIX...
echo.
call npx vsce package --allow-missing-repository
if errorlevel 1 (
    echo ERROR: Packaging failed!
    exit /b 1
)
echo Packaging completed.
echo.

set VSIX_FILE=vscode-mdtodo-0.0.2.vsix

if not exist "%VSIX_FILE%" (
    echo ERROR: %VSIX_FILE% not found after packaging!
    exit /b 1
)
echo VSIX file generated: %VSIX_FILE%
echo.

echo [3/4] Uninstalling old version (if exists)...
echo.
code --uninstall-extension mdtodo.vscode-mdtodo --force 2>nul
echo Done.
echo.

echo [4/4] Installing extension...
echo.
call code --install-extension "%VSIX_FILE%" --force
if errorlevel 1 (
    echo ERROR: Installation failed!
    echo Please make sure VSCode is installed and 'code' command is available.
    echo You can add VSCode to PATH by:
    echo   1. Open VSCode
    echo   2. Press Ctrl+Shift+P
    echo   3. Type "Shell Command: Install 'code' command in PATH"
    exit /b 1
)
echo Installation completed.
echo.

echo ============================================
echo Install Complete!
echo ============================================
echo.
echo The MDTODO plugin has been built and installed successfully!
echo.

endlocal
pause
```

## 关键实现细节

### 1. 卸载旧版本

```batch
code --uninstall-extension mdtodo.vscode-mdtodo --force 2>nul
```

- 使用 `--force` 标志强制卸载
- `2>nul` 抑制错误输出（如果旧版本不存在则静默处理）
- 确保安装新版本前环境干净

### 2. 错误处理

- 每个步骤都有独立的错误检测
- 编译失败、打包失败、安装失败都会终止脚本并返回错误码
- 增加了打包后 VSIX 文件存在性检查

## 使用方法

### 方式一：双击运行（推荐）

1. 双击 `vscode-mdtodo\install.bat`
2. 等待构建、打包、安装完成
3. 重启 VSCode（如果之前已打开）

### 方式二：命令行运行

```bash
cd vscode-mdtodo
install.bat
```

## 注意事项

1. **确保 `code` 命令可用**：如果 `code` 命令不在 PATH 中，需要先在 VSCode 中执行 "Shell Command: Install 'code' command in PATH"
2. **VSCode 需要重启**：安装扩展后，需要重启 VSCode 才能使用新安装的插件
3. **首次安装 vs 升级更新**：
   - 首次安装：脚本会完成完整流程
   - 升级更新：脚本会先卸载旧版本，再安装新版本
4. **完全重装**：每次运行都会重新编译代码，确保使用最新版本

## 文件清单

| 文件 | 说明 |
|------|------|
| `pack.bat` | 独立打包脚本，仅打包不安装 |
| `install.bat` | 完整安装脚本，包含打包、安装、更新全过程 |

## 总结

R30.4 任务完成，`install.bat` 现在实现了：

- ✅ 每次运行自动重新打包
- ✅ 自动卸载旧版本
- ✅ 自动安装/更新新版本
- ✅ 完整的错误处理和状态提示
- ✅ 一键完成打包安装更新全过程
