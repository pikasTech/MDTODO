# R17.1 Processing状态检测与标记修复

## 需求描述

1. 错误匹配到了任务内容部分的 `[Processing]` 而非与 RXX 同行的 `[Processing]`，只有和 RXX 同行的 `[Processing]` 才是有效的。
2. 点击 Claude 执行后没有正确给 RXX 添加 `[Processing]`。

## 问题分析

### 问题1：解析器错误匹配描述行中的 [Processing]

**原代码位置**: `src/parser/index.ts` 的 `parseTask` 方法

**问题原因**:
- `getFullTaskContent` 方法返回的是任务行 + 任务描述行的合并内容
- 使用 `content.includes('[Processing]')` 会错误地检测到任务描述行中的 `[Processing]` 文本
- 例如：任务 `## R17.1` 的描述行包含 "1.错误匹配到了任务内容部分的[Processing]" 时，会被错误识别为执行中状态

### 问题2：添加 [Processing] 标记的正则和逻辑问题

**原代码位置**: `src/providers/webviewProvider.ts` 的 `markTaskAsProcessing` 方法

**问题原因**:
- 原正则表达式 `^##+\\s+[^\\n]*\\b${taskId}` 可能匹配到描述行中包含任务ID的文本
- 原替换逻辑 `line.replace(/(\]\s*)$/, ' [Processing]$1')` 假设行末有 `]`，但实际任务行格式是 `### R17.1`，行末是任务ID

## 修复内容

### 1. 解析器修复

**文件**: `src/parser/index.ts`

**修改内容**:
- 在 `parseTask` 方法中，提取任务行（第一个换行符之前的内容）
- 只检测任务行中的 `[completed]` 和 `[Processing]`，不检测描述行

```typescript
// 只检测任务行（第一个换行符之前）中是否包含 [completed] 和 [Processing]
const firstNewlineIndex = content.indexOf('\n');
const taskLine = firstNewlineIndex === -1 ? content : content.substring(0, firstNewlineIndex);

// 判断是否完成
const completed = taskLine.includes('[completed]');
// 判断是否执行中（只检测任务行，不检测描述行）
const processing = taskLine.includes('[Processing]');
```

### 2. 任务行匹配修复

**文件**: `src/providers/webviewProvider.ts`

**修改内容**:
- 修改正则表达式，明确要求匹配 `##` 或 `###` 开头的任务标题行
- 使用 `^#{2,3}\\s+` 确保只匹配标题行，不匹配描述行

```typescript
// 必须匹配 ## 或 ### 开头的任务标题行，使用精确匹配避免匹配到描述行
// 格式如: ## R17, ### R17.1, ## R17 [completed]
const taskHeaderPattern = new RegExp(`^#{2,3}\\s+[^\\n]*\\b${taskId.replace(/\./g, '\\.')}(?:[)\\s]|$)`);
```

### 3. 标记添加逻辑修复

**文件**: `src/providers/webviewProvider.ts`

**修改内容**:
- 正确识别任务ID的位置
- 在任务ID后、其他标记（如 `[completed]`）之前添加 `[Processing]`
- 支持两种场景：有其他标记时插在标记前，无其他标记时直接追加在ID后

```typescript
// 任务行格式如: ## R17, ### R17.1, ## R17 [completed]
// [Processing] 应该添加在任务ID之后，其他标记之前
if (isProcessing) {
  // 在任务ID后添加 [Processing]，在可能存在的 [completed] 之前
  const taskIdPattern = new RegExp(`(${taskId.replace(/\./g, '\\.')})(\\s*\\[)`);
  if (taskIdPattern.test(line)) {
    // 有其他标记（如 [completed]），在ID和标记之间插入
    lines[taskLineIndex] = line.replace(taskIdPattern, '$1 [Processing]$2');
  } else {
    // 没有其他标记，直接在ID后添加
    const simplePattern = new RegExp(`(${taskId.replace(/\./g, '\\.')})(\\s*)$`);
    lines[taskLineIndex] = line.replace(simplePattern, '$1 [Processing]$2');
  }
} else {
  // 移除 [Processing] 标记
  lines[taskLineIndex] = line.replace(/\s*\[Processing\]/, '');
}
```

## 修复效果

1. **正确识别 Processing 状态**：
   - 任务描述行中的 `[Processing]` 文本不再被误识别为执行中状态
   - 只有任务标题行（`## RXX` 或 `### RXX.X`）中的 `[Processing]` 才会被识别

2. **正确添加 Processing 标记**：
   - 点击 Claude 执行后，正确地在任务标题行添加 `[Processing]` 标记
   - 标记格式：`## R17.1 [Processing]`
   - 如果任务已有 `[completed]` 标记，则不添加 `[Processing]`

3. **筛选功能正常工作**：
   - "进行中"筛选只显示任务标题中包含 `[Processing]` 的任务
   - 任务描述中包含 `[Processing]` 文本的任务不会被错误筛选

## 测试方法

1. 打开包含 `[Processing]` 文本的任务描述的 TODO 文件
2. 验证任务描述中的 `[Processing]` 文本不会被识别为执行中状态
3. 点击任务的 "Claude 执行" 按钮
4. 验证：
   - 任务标题行正确添加 `[Processing]` 标记
   - WebUI 正确显示执行中状态（橙色边框、闪烁徽章）
   - 文件中任务标题变为 `## R17.1 [Processing]`
5. 使用 "进行中" 筛选，验证只有正确标记的任务显示
