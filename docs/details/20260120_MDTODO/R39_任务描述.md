# R39 任务：支持自动检测文档链接存在性

## 任务目标

支持自动检测每个 ITEM 中提到的文档链接是否真实存在，在 ITEM 上显示一个图标和存在的链接文档数量（例如 0/1，2/2），根据是否多存在，图表的颜色要有变化。

## 实现内容

### 1. 类型定义修改

**文件**: `src/types/index.ts`

在 `TodoTask` 接口中添加了链接统计字段：
```typescript
export interface TodoTask {
  // ... 原有字段
  linkCount: number;    // 任务中提到的链接总数
  linkExists: number;   // 存在的链接数量
}
```

### 2. 解析器修改

**文件**: `src/parser/index.ts`

添加了三个方法来处理链接检测：

1. **`extractLinks(content: string): string[]`**
   - 从任务内容中提取所有 Markdown 链接
   - 支持格式: `[文本](链接地址)`
   - 排除锚点链接（以 `#` 开头）和 `mailto` 链接

2. **`checkLinkExists(link: string, baseFilePath: string): boolean`**
   - 检测链接是否指向真实存在的文件
   - 支持相对路径和绝对路径
   - 处理 `file://` 协议和 URL 编码
   - 基于当前任务文件路径解析相对路径

3. **`calculateLinkStats(content: string, filePath: string)`**
   - 计算任务的链接统计信息
   - 返回 `{ linkCount, linkExists }`

在 `parseTask` 方法中调用 `calculateLinkStats` 来计算每个任务的链接统计。

### 3. WebView 修改

**文件**: `src/webview/components/TaskList.tsx`

1. **Task 接口更新**: 添加 `linkCount` 和 `linkExists` 字段

2. **TaskItem 组件更新**: 在任务 ID 后面添加链接状态图标
   - 仅当 `linkCount > 0` 时显示
   - 图标使用 SVG 绘制（类似链接图标）
   - 显示格式: `${linkExists}/${linkCount}`
   - 添加 title 属性显示详细提示信息

### 4. 样式修改

**文件**: `src/webview/components/TaskList.css`

添加了链接状态图标样式：
- `.link-status-icon`: 基础样式
- `.link-complete`: 全部链接存在时的样式（绿色）
- `.link-partial`: 部分链接存在时的样式（黄色/橙色）
- `.link-count`: 链接计数文字样式

## 效果展示

### 链接存在情况
- **全部存在 (2/2)**: 绿色背景 + 绿色边框 + 绿色文字
- **部分存在 (1/2)**: 黄色背景 + 橙色边框 + 黄色文字
- **全部缺失 (0/1)**: 部分存在样式（黄色/橙色）

### 图标说明
- 链接状态图标显示在任务 ID 后面
- 鼠标悬停时显示 tooltip: `链接检查: ${linkExists}/${linkCount} 个链接存在`

## 依赖说明

解析器使用 Node.js 的 `fs` 和 `path` 模块来检查文件是否存在：
- `fs.existsSync()`: 同步检查文件是否存在
- `path.resolve()`: 解析相对路径为绝对路径

## 注意事项

1. 链接检测是同步操作，对于大量任务可能会有性能影响
2. 相对路径基于当前 TODO 文件所在目录解析
3. 支持 Windows 和 Unix 系统的路径格式
4. 排除锚点链接和邮件链接
