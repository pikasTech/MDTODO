# R37.3 快速导航按钮实现执行报告

## 任务概述

根据 R37.3 任务要求，为 MDTODO 插件添加快速导航功能按钮，包括：
1. 快速到顶部按钮
2. 快速到底部按钮
3. 跳转到下一个未完成任务按钮（循环）

## 实现内容

### 1. 添加状态变量

在 TaskList.tsx 中添加了 `lastJumpIndex` 状态变量，用于记录跳转到下一个未完成任务的当前位置：

```typescript
// 【实现R37.3】跳转到下一个未完成任务的当前位置记录
const [lastJumpIndex, setLastJumpIndex] = React.useState(-1);
```

### 2. 实现三个处理函数

#### 2.1 handleScrollToTop - 滚动到顶部

```typescript
const handleScrollToTop = () => {
  // 防抖检查
  if (buttonCooldown) {
    console.log('[Webview] 顶部按钮防抖，跳过重复点击');
    return;
  }
  const container = document.querySelector('.task-container');
  if (container) {
    container.scrollTo({ top: 0, behavior: 'smooth' });
  }
  // 设置防抖状态
  setButtonCooldown(true);
  setCooldownMessage('顶部');
  setTimeout(() => {
    setButtonCooldown(false);
    setCooldownMessage(null);
  }, BUTTON_COOLDOWN);
};
```

#### 2.2 handleScrollToBottom - 滚动到底部

```typescript
const handleScrollToBottom = () => {
  // 防抖检查
  if (buttonCooldown) {
    console.log('[Webview】底部按钮防抖，跳过重复点击');
    return;
  }
  const container = document.querySelector('.task-container');
  if (container) {
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
  }
  // 设置防抖状态
  setButtonCooldown(true);
  setCooldownMessage('底部');
  setTimeout(() => {
    setButtonCooldown(false);
    setCooldownMessage(null);
  }, BUTTON_COOLDOWN);
};
```

#### 2.3 handleJumpToNextIncomplete - 跳转到下一个未完成任务（循环）

```typescript
const handleJumpToNextIncomplete = () => {
  // 防抖检查
  if (buttonCooldown) {
    console.log('[Webview] 下一个按钮防抖，跳过重复点击');
    return;
  }
  // 获取所有任务（未完成 + 未进行中）
  const allTasks = getAllTasks(tasks);
  const incompleteTasks = allTasks.filter(t => !t.completed && !t.processing);

  if (incompleteTasks.length === 0) {
    // 没有未完成的任务，提示用户
    console.log('[Webview] 没有未完成的任务');
    setButtonCooldown(true);
    setCooldownMessage('无');
    setTimeout(() => {
      setButtonCooldown(false);
      setCooldownMessage(null);
    }, BUTTON_COOLDOWN);
    return;
  }

  // 找到当前索引的下一个任务
  let nextIndex = 0;
  if (lastJumpIndex >= 0 && lastJumpIndex < incompleteTasks.length - 1) {
    // 从当前位置继续往后找
    nextIndex = lastJumpIndex + 1;
  } else if (lastJumpIndex >= incompleteTasks.length - 1) {
    // 已经到末尾了，循环回到开头
    nextIndex = 0;
  }

  const nextTask = incompleteTasks[nextIndex];
  if (nextTask) {
    // 确保任务展开
    const parentId = nextTask.id.split('.').slice(0, -1).join('.');
    if (parentId) {
      setExpandedTasks(prev => new Set([...prev, parentId]));
    }
    // 滚动到任务位置 - 顶对齐
    setTimeout(() => {
      const taskElement = document.querySelector(`[data-task-id="${nextTask.id}"]`);
      if (taskElement) {
        taskElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 50);
    // 更新索引记录
    setLastJumpIndex(nextIndex);
  }

  // 设置防抖状态
  setButtonCooldown(true);
  setCooldownMessage('下一个');
  setTimeout(() => {
    setButtonCooldown(false);
    setCooldownMessage(null);
  }, BUTTON_COOLDOWN);
};
```

### 3. 添加按钮图标

在 header-actions 区域添加了三个按钮：

1. **快速到顶部按钮**：使用向上箭头图标
2. **快速到底部按钮**：使用向下箭头图标
3. **跳转到下一个未完成任务按钮**：使用带有箭头的圆形图标，表示循环跳转

所有按钮都使用 SVG 图标，与现有工具栏按钮风格保持一致。

## 功能特点

1. **平滑滚动**：所有导航都使用 `scrollIntoView` 或 `scrollTo` 的 `behavior: 'smooth'` 参数，实现平滑滚动效果
2. **防抖保护**：所有按钮都继承了通用按钮防抖机制（500ms冷却时间）
3. **循环跳转**：跳转到下一个未完成任务时，如果已经到末尾会自动循环回到开头
4. **任务展开**：跳转时会自动展开父任务，确保目标任务可见
5. **顶对齐**：所有滚动都使用 `block: 'start'` 确保目标元素在顶部显示

## 文件修改

- `vscode-mdtodo/src/webview/components/TaskList.tsx`
  - 添加 `lastJumpIndex` 状态变量
  - 添加 `handleScrollToTop`、`handleScrollToBottom`、`handleJumpToNextIncomplete` 三个处理函数
  - 在工具栏区域添加三个新按钮的渲染

## 测试建议

1. 点击"快速到顶部"按钮，验证页面平滑滚动到顶部
2. 点击"快速到底部"按钮，验证页面平滑滚动到底部
3. 点击"跳转到下一个未完成任务"按钮，验证：
   - 能够跳转到第一个未完成任务
   - 再次点击跳转到下一个
   - 跳转到末尾后循环回到开头
   - 没有未完成任务时显示提示
