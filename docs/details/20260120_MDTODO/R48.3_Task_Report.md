# R48.3 任务报告：折叠模式下编辑时保持滚动位置

## 任务描述

折叠模式进入编辑后确实保持折叠模式了，但是总是会滚动到子任务的最下面，导致难以编辑前面的子任务。

## 问题分析

在 `src/webview/components/TaskList.tsx` 的第1451-1464行，存在一个 `useEffect`：

```javascript
// 【实现R48.1】收起状态切换时滚动到最后（显示最后2条）
React.useEffect(() => {
  if (!isExpanded && childrenRef.current && task.children && task.children.length > 2) {
    // 使用 setTimeout 确保DOM渲染完成后再滚动
    const timer = setTimeout(() => {
      if (childrenRef.current) {
        childrenRef.current.scrollTop = childrenRef.current.scrollHeight;
      }
    }, 50);
    return () => clearTimeout(timer);
  }
}, [isExpanded, showChildrenCount, task.children]);
```

### 问题原因

1. 当任务处于收起状态（`isExpanded` 为 `false`）时，该 `useEffect` 会在渲染时自动将子任务列表滚动到底部
2. 虽然 R48.2 修复了进入编辑模式时保持折叠状态的问题，但这个 `useEffect` 仍然会在编辑模式下触发
3. 当用户双击进入编辑模式时，组件重新渲染，触发 `useEffect`，导致滚动条自动跳转到最底部
4. 这使得用户难以编辑位于列表上方的子任务

### 根本原因分析

最初的修复尝试中，尝试使用 `isEditMode` 来判断，但发现这不能正确工作：
- 当子任务（如 R12.1）进入编辑模式时，父任务（R12）本身的 `isEditMode` 是 `false`
- 只有被编辑的任务（R12.1）才处于编辑模式
- 因此在父任务中检查 `isEditMode` 无法阻止自动滚动

## 修复方案

### 最终解决方案

通过引入 `editingTaskParentId` 状态来跟踪当前编辑任务的父任务ID：

1. **添加状态变量**（第82行）：
```typescript
// 【修复R48.3】跟踪当前编辑任务的父任务ID，用于控制滚动行为
const [editingTaskParentId, setEditingTaskParentId] = React.useState<string>('');
```

2. **修改 handleDoubleClick**（第415-426行）：
```typescript
const handleDoubleClick = (taskId: string) => {
  // 计算父任务ID（用于控制滚动）
  const parentId = taskId.split('.').slice(0, -1).join('.');
  console.log('[R48.3] handleDoubleClick: taskId=', taskId, ', parentId=', parentId);
  setEditingTaskParentId(parentId);
  // 关闭所有其他任务的编辑状态，只保留当前任务
  setEditModes({
    [taskId]: true,
  });
  // 标记该任务正在编辑，防止文件重载后丢失编辑状态
  setEditingTaskIds(new Set([taskId]));
};
```

3. **添加滚动位置保存/恢复逻辑**（第1434-1449行）：
```typescript
// 【修复R48.3】当有子任务进入编辑模式时保存当前滚动位置，退出时恢复
React.useEffect(() => {
  // 当 editingTaskParentId 等于当前任务ID时，说明当前任务有子任务正在编辑
  if (editingTaskParentId === task.id && childrenRef.current) {
    if (savedScrollRef.current === 0) {
      // 第一次检测到，进入编辑模式，保存滚动位置
      savedScrollRef.current = childrenRef.current.scrollTop;
      console.log('[R48.3] 有子任务进入编辑模式，保存滚动位置:', savedScrollRef.current, 'parentId:', task.id);
    }
  } else if (savedScrollRef.current > 0 && childrenRef.current && editingTaskParentId === '') {
    // 子任务退出编辑模式，恢复滚动位置
    console.log('[R48.3] 子任务退出编辑模式，恢复滚动位置:', savedScrollRef.current);
    childrenRef.current.scrollTop = savedScrollRef.current;
    savedScrollRef.current = 0;
  }
}, [editingTaskParentId, task.id]);
```

4. **修改自动滚动逻辑**（第1451-1467行）：
```typescript
// 【实现R48.1】收起状态切换时滚动到最后（显示最后2条）
// 【修复R48.3】当有子任务正在编辑时，不自动滚动
React.useEffect(() => {
  // 当有子任务正在编辑时（editingTaskParentId === task.id），不自动滚动
  const hasChildEditing = editingTaskParentId === task.id;
  if (!isExpanded && !hasChildEditing && childrenRef.current && task.children && task.children.length > 2) {
    // 使用 setTimeout 确保DOM渲染完成后再滚动
    const timer = setTimeout(() => {
      if (childrenRef.current && savedScrollRef.current === 0) {
        // 只有当没有保存滚动位置时才自动滚动
        console.log('[R48.3] 自动滚动到底部: scrollHeight=', childrenRef.current.scrollHeight);
        childrenRef.current.scrollTop = childrenRef.current.scrollHeight;
      }
    }, 50);
    return () => clearTimeout(timer);
  }
}, [isExpanded, showChildrenCount, task.children, editingTaskParentId, task.id]);
```

5. **传递 prop 到所有 TaskItem**：
- 在顶层 TaskItem 创建时添加 `editingTaskParentId` 属性
- 在子任务 TaskItem 创建时添加 `editingTaskParentId` 属性
- 在 TaskItem 接口定义中添加 `editingTaskParentId: string` 属性

## 验证方法

1. 确保插件以折叠模式启动（默认）
2. 展开一个有多于2个子任务的任务
3. 滚动到中间位置的子任务
4. 双击进入该子任务的编辑模式（保持在折叠状态）
5. 观察子任务列表的滚动位置 - 应该保持当前滚动位置而不是跳转到最底部
6. 完成编辑后退出，滚动位置应该恢复到进入编辑前的位置
7. 滚动到其他子任务位置进行编辑，验证滚动行为正确

## 修改文件

- `src/webview/components/TaskList.tsx`
  - 第82行：添加 `editingTaskParentId` 状态
  - 第415-426行：修改 `handleDoubleClick` 计算并设置父任务ID
  - 第1347-1390行：TaskItem 接口添加并解构 `editingTaskParentId` prop
  - 第1315-1336行：顶层 TaskItem 添加 `editingTaskParentId` 属性
  - 第1685-1707行：子任务 TaskItem 添加 `editingTaskParentId` 属性
  - 第1434-1449行：添加滚动位置保存/恢复 useEffect
  - 第1451-1467行：修改自动滚动 useEffect，添加 `editingTaskParentId` 判断

## 构建状态

- TypeScript 编译：成功
- Webpack 打包：成功

## 总结

R48.3 修复了折叠模式下进入编辑模式后自动滚动到底部的问题。通过引入 `editingTaskParentId` 状态来跟踪当前编辑任务的父任务ID，当有子任务正在编辑时，父任务的自动滚动行为被阻止。同时添加了滚动位置保存和恢复机制，确保用户可以在收起状态的子任务列表中自由滚动并选择要编辑的子任务，编辑时不会自动跳转到最底部，退出编辑模式后会恢复到之前的滚动位置，提升了编辑体验。
