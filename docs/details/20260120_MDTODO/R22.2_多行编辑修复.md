# R22.2 多行内容编辑问题修复

**日期**: 2026-01-21

## 问题描述

多行编辑问题仍然存在。当任务内容包含多行时，每次编辑和完成都会导致第2行到第n行的内容丢失或重复。

## 问题根源

编辑模式下使用了 `dangerouslySetInnerHTML` 渲染内容：

```typescript
dangerouslySetInnerHTML: { __html: isNewTask ? '' : renderContent() },
```

问题在于：
1. `escapeHtml()` 函数只进行 HTML 字符转义，但不会将换行符 `\n` 转换为 `<br>` 标签
2. 当使用 `dangerouslySetInnerHTML` 时，浏览器会将内容解析为 HTML
3. 在 HTML 中，换行符 `\n` 会被浏览器忽略（显示为空格或被合并）
4. CSS 的 `white-space: pre-wrap` 只对纯文本有效，对 `dangerouslySetInnerHTML` 设置的 HTML 内容无效

## 修复方案

编辑模式下使用子文本节点直接渲染，而不是 `dangerouslySetInnerHTML`：

```typescript
// 修改前
dangerouslySetInnerHTML: { __html: isNewTask ? '' : renderContent() },

// 修改后
children: isEditMode ? task.title : (isNewTask ? '' : renderContent())
```

**原理**：
- 编辑模式：使用 `children` 直接设置纯文本，保留原始换行符 `\n`
- 非编辑模式：继续使用 `dangerouslySetInnerHTML` 以渲染 Markdown 格式

## 修改文件

`vscode-mdtodo/src/webview/components/TaskList.tsx:903-912`

## 编译结果

```
webpack 5.104.1 compiled successfully in 2631 ms
bundle.js 已更新
```

## 验证步骤

1. 重新加载 VSCode 窗口
2. 创建一个包含多行内容的任务，例如：
   ```
   ## R22.2 [Test]

   这是第一行内容
   这是第二行内容
   这是第三行内容
   ```
3. 点击"编辑"进入编辑模式
4. 确认多行内容正确显示，每行独立一行
5. 点击"完成"保存
6. 确认多行内容正确保存，没有丢失行
7. 再次编辑，确认多行内容仍然正确

## 状态

**已完成** ✓
