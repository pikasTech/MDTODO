# R53.9 任务完成报告

## 任务目标

将 webview 渲染的缩进层级改为**仅由任务ID决定，和几个#无关**，并且渲染缩进层级不超过2级。

## 需求分析

| 任务ID示例 | 原缩进（基于#） | 新缩进（基于ID） |
|-----------|-----------------|------------------|
| ## R1 | 2级 | 1级 (depth=0) |
| ### R1.1 | 3级 | 2级 (depth=1) |
| # R1.1.1 | 1级 | 2级 (depth=1) |
| ## R1.2.3.4 | 2级 | 2级 (depth=1) |

**关键要求**：
- 缩进由任务ID中的点号数量决定
- 最大缩进层级为2级（depth最大为1）
- R1.1 和 R1.1.1 在渲染时是同级别

## 实现方案

### 1. 添加层级计算函数

在 `TaskList.tsx` 和 `TaskItem.tsx` 中添加 `calculateTaskDepth` 函数：

```typescript
// Maximum depth level for indentation (0 = level 1, 1 = level 2, max 2 levels total)
const MAX_DEPTH = 1;

const calculateTaskDepth = (taskId: string): number => {
  const dotCount = (taskId.match(/\./g) || []).length;
  return Math.min(dotCount, MAX_DEPTH);
};
```

### 2. 层级计算规则

| 任务ID | 点号数量 | depth 结果 | 缩进级别 | 左边距 |
|--------|----------|------------|----------|--------|
| R1 | 0 | 0 | 1级 | 24px |
| R1.1 | 1 | 1 | 2级 | 40px |
| R1.1.1 | 2 | 1 | 2级 | 40px (限制) |
| R2.3.5.7 | 3 | 1 | 2级 | 40px (限制) |

### 3. 修改 TaskList.tsx

**修改位置**：第 365-391 行

```typescript
// 修改前
depth: 0,

// 修改后
depth: calculateTaskDepth(task.id),
```

### 4. 修改 TaskItem.tsx

#### 4.1 添加层级计算函数（第5-17行）

#### 4.2 修改 childrenStyle（第189-194行）

```typescript
const childrenStyle = {
  maxHeight: isExpanded ? '10000px' : `${PREVIEW_MAX_HEIGHT}px`,
  marginLeft: `${24 + calculateTaskDepth(task.id) * 16}px`,
  // ...
};
```

#### 4.3 修改子任务传递（第376-403行）

```typescript
React.createElement(TaskItem, {
  key: child.id,
  task: child,
  depth: calculateTaskDepth(child.id),  // 修改前: depth + 1
  // ...
})
```

## 验证结果

### 编译成功

```
webpack 5.104.1 compiled successfully
- extension.js: 59.5 KiB
- bundle.js: 238 KiB
```

### 审查通过

R53.9.2 审查结果：[PASS]

所有审查标准均通过：
- 缩进由任务ID决定（基于点号数量）
- 最大缩进层级为2级（MAX_DEPTH = 1）
- R1.1 和 R1.1.1 在渲染时是同级别

## 影响说明

此修改**仅影响渲染显示效果**，不影响其他执行逻辑：
- 任务数据的层级结构保持不变
- 任务的展开/折叠、编辑、删除等操作逻辑不变
- 缩进样式根据任务ID动态计算，最大限制为2级

## 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `src/webview/components/TaskList.tsx` | 修改 | 添加层级计算函数，修改根任务depth传递 |
| `src/webview/components/TaskItem.tsx` | 修改 | 添加层级计算函数，修改childrenStyle和子任务depth传递 |
| `out/extension.js` | 生成 | TypeScript编译产物 |
| `resources/bundle.js` | 生成 | webpack打包产物 |

## 迭代记录

| 任务 | 状态 | 说明 |
|------|------|------|
| R53.9.1 | [completed] | 实现层级计算函数并修改相关文件 |
| R53.9.2 | [completed] | 审查通过 |
