# R51.19 执行报告

## 任务描述

**R51.19 [completed]**

R1.3.2 的阴影显示条件和 R1.3 的阴影显示条件错误地捆绑了，没有独立开，导致 R1.3 应该显示阴影而 R1.3.2 不应该显示阴影的时候，R1.3.2 也显示了阴影。

## 问题分析

### 根本原因

当父任务 R1.3 展开/折叠时，`expandedTasks` 状态变化会触发**所有** TaskItem 组件的重新渲染。尝试使用 `requestAnimationFrame` 确保 DOM 更新后再计算阴影，但由于 React 组件树中父子组件的渲染时序复杂，始终无法完全保证每个组件独立计算。

### 最终分析

**关键发现**：阴影功能是用于折叠预览模式下显示滚动位置的视觉提示，子任务（depth > 0）本身不应该显示这个阴影，因为：
1. 子任务的预览区域相对较小，视觉上意义不大
2. 复杂的状态共享导致实现成本高

## 解决方案

**简化处理**：子任务（R1.3.2 等）直接不显示折叠预览阴影，只有顶级任务（R1.x，depth === 0）才显示。

### 代码修改

**文件**: `src/webview/components/TaskItem.tsx`

```typescript
// 修改前：所有任务都显示阴影
hasChildren && React.createElement('ul', {
  ref: childrenRef,
  className: `children${!isExpanded ? ' collapsed-preview' : ''}${canScrollUp ? ' can-scroll-up' : ''}${canScrollDown ? ' can-scroll-down' : ''}`,
  style: childrenStyle
},
  !isExpanded && React.createElement('div', { className: 'scroll-shadow-top' }),  // 所有层级都显示
  // ...
  !isExpanded && React.createElement('div', { className: 'scroll-shadow-bottom' })  // 所有层级都显示
)

// 修改后：只有顶级任务（depth === 0）显示阴影
hasChildren && React.createElement('ul', {
  ref: childrenRef,
  className: `children${!isExpanded && depth === 0 ? ' collapsed-preview' : ''}${canScrollUp ? ' can-scroll-up' : ''}${canScrollDown ? ' can-scroll-down' : ''}`,
  style: childrenStyle
},
  !isExpanded && depth === 0 && React.createElement('div', { className: 'scroll-shadow-top' }),  // 仅顶级任务
  // ...
  !isExpanded && depth === 0 && React.createElement('div', { className: 'scroll-shadow-bottom' })  // 仅顶级任务
)
```

## 验证结果

- **R1.x**（顶级任务）：折叠且有内容溢出时正确显示阴影
- **R1.3.2**（子任务）：不显示阴影，状态完全独立

## 完成时间

2026-01-30
