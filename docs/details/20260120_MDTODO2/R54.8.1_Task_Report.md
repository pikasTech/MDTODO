# R54.8.1 任务报告

## 任务描述

在 webview 中覆盖 console.log/console.warn/console.error 方法，通过 vscodeApi.postMessage 将日志发送到扩展端，扩展端调用 logService 写入日志文件。

## 实现摘要

### 修改的文件

1. **`D:\Work\vscode-mdtodo\src\webview\index.tsx`**
2. **`D:\Work\vscode-mdtodo\src\providers\webviewProvider.ts`**

### 实现细节

#### 1. Webview 端 (index.tsx)

在 webview 入口文件中添加了 console 方法覆盖逻辑：

```typescript
// ============================================
// R54.8.1: 覆盖 console 方法，将日志发送到扩展端
// ============================================

const originalConsoleLog = console.log;
const originalConsoleWarn = console.warn;
const originalConsoleError = console.error;

/**
 * 发送日志到扩展端
 */
const sendLogToExtension = (level: string, args: any[]) => {
  if (vscodeApi) {
    const timestamp = new Date().toISOString();
    const message = args.map(arg => {
      if (typeof arg === 'object') {
        try {
          return JSON.stringify(arg);
        } catch {
          return String(arg);
        }
      }
      return String(arg);
    }).join(' ');

    vscodeApi.postMessage({
      type: 'webviewLog',
      level,
      message,
      timestamp,
      args: args.map(arg => {
        if (typeof arg === 'object') {
          try {
            return JSON.stringify(arg, null, 2);
          } catch {
            return String(arg);
          }
        }
        return arg;
      })
    });
  }
};

// 覆盖 console.log
console.log = (...args: any[]) => {
  sendLogToExtension('info', args);
  originalConsoleLog.apply(console, args);
};

// 覆盖 console.warn
console.warn = (...args: any[]) => {
  sendLogToExtension('warning', args);
  originalConsoleWarn.apply(console, args);
};

// 覆盖 console.error
console.error = (...args: any[]) => {
  sendLogToExtension('error', args);
  originalConsoleError.apply(console, args);
};
```

**关键设计点**：
- 保留原始 console 方法的实现，确保本地调试正常
- 对象类型参数会被序列化为 JSON 字符串
- 通过 `vscodeApi.postMessage` 发送消息到扩展端
- 消息包含 `type: 'webviewLog'` 和日志级别、消息内容、时间戳等信息

#### 2. 扩展端 (webviewProvider.ts)

在消息处理中添加了 `webviewLog` 消息类型处理：

```typescript
// 在 handleMessage 中添加 case
case 'webviewLog':
  await this.handleWebviewLog(message);
  break;

// 新增处理方法
private async handleWebviewLog(message: any): Promise<void> {
  const { level, message: logMessage, timestamp, args } = message;

  if (globalLogsDir && this.currentFilePath) {
    try {
      await writeUnifiedLogEntry(globalLogsDir, this.currentFilePath, {
        eventType: level === 'error' ? 'error' : 'lifecycle',
        event: 'webviewLog',
        details: {
          source: 'webview',
          level,
          message: logMessage,
          timestamp,
          rawArgs: args
        }
      });
    } catch (error) {
      console.error('[MDTODO] Failed to write webview log:', error);
    }
  }
}
```

**关键设计点**：
- 错误级别的日志使用 `eventType: 'error'`，其他使用 `lifecycle`
- 复用已有的 `writeUnifiedLogEntry` 函数，保持日志格式一致
- 日志写入当前生命周期的 .jsonl 文件

### 日志格式示例

写入日志文件的内容格式如下（JSONL）：

```json
{"timestamp":"2026-01-30T10:30:00.000Z","eventType":"lifecycle","event":"webviewLog","details":{"source":"webview","level":"info","message":"[Webview] VSCode API initialized successfully","timestamp":"2026-01-30T10:30:00.000Z","rawArgs":["[Webview] VSCode API initialized successfully"]}}
{"timestamp":"2026-01-30T10:30:01.000Z","eventType":"error","event":"webviewLog","details":{"source":"webview","level":"error","message":"Some error occurred","timestamp":"2026-01-30T10:30:01.000Z","rawArgs":["Some error occurred"]}}
```

## 验证结果

- 编译成功：`npm run compile` 通过
- 日志服务测试通过：`npm run test` 中 r54_5_logService.test.ts 全部通过

## 后续任务

R54.8.2 将审查此实现的正确性，验证：
1. console.log 被捕获并发送到扩展端
2. console.warn 被捕获并发送到扩展端
3. console.error 被捕获并发送到扩展端
4. 日志写入当前生命周期的 .jsonl 文件

## 完成时间

2026-01-30
