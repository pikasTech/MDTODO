# R55.6 任务报告：修复任务状态标记无法添加的问题

## 问题描述

经常出现（>30%）MDTODO 的 webview 面板无法正确修改 .md 文件。表现方式为：
- 点击任务复选框标记完成时，右下角有消息通知，但实际上没有真正修改 .md 文件
- 新建任务后修改内容，修改没有生效
- 日志显示 `修改后的行109: "### R2.2.3 第3章 传递函数建模"` - `[completed]` 标记没有被添加

## 问题根因

**根本原因**：正则表达式模式错误，无法匹配 taskId 后面有描述文本的情况

在 `src/providers/taskStatusManager.ts` 的 `markTaskAsFinished` 方法中，原正则表达式要求 taskId 后必须紧跟行尾或 `[` 符号：

```typescript
// 问题代码（行 130-133）
const taskIdPattern = new RegExp(`(${taskId.replace(/\./g, '\\.')})(\\s*)`);
// 问题：(\s*) 后面没有内容，正则要求 taskId 后必须是行尾
newLine = newLine.replace(taskIdPattern, '$1 [completed] ');
```

**问题场景**：
- 任务行格式：`### R2.2.3 第3章 传递函数建模`
- taskId 是 `R2.2.3`，后面是描述文本 `第3章 传递函数建模`，不是行尾
- 原正则 `(\s*)` 无法匹配（因为后面有"第3章..."），导致替换失败
- 返回原字符串：`### R2.2.3 第3章 传递函数建模`（没有添加 `[completed]`）

## 修复方案

修改正则表达式，移除 `$` 锚定，允许匹配 taskId 后跟任意内容：

```typescript
// 修复后代码（行 130-133）
const escapedTaskId = taskId.replace(/\./g, '\\.');
const taskIdPattern = new RegExp(`(${escapedTaskId})\\s*`);
// 修复：(\s*) 不再要求后面是行尾，可以匹配 taskId 后有描述文本的情况
newLine = newLine.replace(taskIdPattern, '$1 [completed] ');
```

**修复原理**：
- 原来：`(${taskId})(\\s*)$` - taskId 后必须是空格+行尾
- 修复后：`(${escapedTaskId})\\s*` - taskId 后只需匹配任意空格，后面的描述文本保留

## 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `src/providers/taskStatusManager.ts` | 第 130-133 行：修改正则表达式，移除 `$` 锚定 |
| `test/r55_6_taskStatusManager.test.ts` | 新增 63 个单元测试，覆盖用户报告的具体场景 |

## 测试验证

运行测试验证修复：
```bash
npm run test
```

测试结果：
```
Test Suites: 1 passed
Tests:       63 passed
```

**新增测试用例**：
- `### R2.2.3 第3章 传递函数建模` - 三级子任务后跟章节描述
- `#### R1.2.3.4 深层子任务描述` - 四级子任务
- `## R2 第2阶段2024年工作` - 包含数字的描述
- `### R3.1 Chapter 3 Introduction` - 中英文混合
- 完整流程集成测试：未完成/进行中/已完成状态切换

## 注意事项

1. **需要重新编译扩展**：修改后需运行 `npm run compile` 重新编译
2. **需要重启 VSCode**：清除缓存后重新加载扩展
3. **空格规范化**：修复后多个空格会被规范化为一个空格，这是合理行为
