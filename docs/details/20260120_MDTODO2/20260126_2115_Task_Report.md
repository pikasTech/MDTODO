# R54.4 任务报告

## 任务描述

右键链接如果是在屏幕底部触发，那么右键菜单会超出屏幕底部导致无法点选，应当自动识别是否超出底部，如果超出则右键菜单向上方弹出而不是下方。

## 实现方案

修改 `src/webview/components/ContextMenu/TaskContextMenu.tsx`：

1. **计算菜单高度**：根据实际显示的菜单项数量计算菜单一共需要的高度
   - 有链接时显示4项：复制执行命令、复制路径、复制相对路径、删除链接文件
   - 无链接时显示1项：复制执行命令

2. **检测是否需要向上弹出**：
   - 获取视口高度 `window.innerHeight`
   - 判断 `contextMenu.y + menuHeight > viewportHeight`
   - 如果超出底部，设置 `needsFlipUp = true`

3. **动态调整菜单位置**：
   - 向下弹出：`top = contextMenu.y`
   - 向上弹出：`top = contextMenu.y - menuHeight`

## 代码修改

```typescript
// 计算实际显示的菜单项数量
let visibleItemCount = 1; // 复制执行命令
if (contextMenu.href) {
  visibleItemCount += 3; // 复制路径、复制相对路径、删除链接文件
}

// 计算菜单高度
const menuHeight = visibleItemCount * MENU_ITEM_HEIGHT + MENU_PADDING;

// 检测是否需要向上弹出（当点击位置靠近屏幕底部时）
const viewportHeight = window.innerHeight;
const needsFlipUp = contextMenu.y + menuHeight > viewportHeight;

// 计算菜单位置
const positionStyle: React.CSSProperties = {
  left: contextMenu.x,
  top: needsFlipUp ? contextMenu.y - menuHeight : contextMenu.y,
  position: 'fixed',
  zIndex: 10000
};
```

## 验证方法

1. 在任务列表底部的任务上右键点击链接
2. 观察右键菜单是否向上弹出而不是向下超出屏幕
3. 在任务列表中间位置右键点击，观察是否正常向下弹出

## 状态

✅ 已完成
