## R53.6 代码块渲染问题深入分析（修订版）

### 问题描述
R53.5 修改后（在 `marked-katex-extension` 配置中添加 `output: 'html'` 选项），代码块和行内代码渲染仍然"一瞬间正常，但马上变得不正常"。

### 深入分析过程

#### 1. 搜索过滤机制

在 `src/parser/index.ts` 中发现以下代码（第 257-266 行）：

```typescript
let title = content
  .replace(/\[Finished\]/g, '')  // 移除 [completed]
  .replace(/\[Processing\]/g, '')  // 移除 [Processing]
  .replace(/(R\d+(?:\.\d+)*)/, '')  // 移除任务ID
  .replace(/^##?\s*/, '')  // 移除开头的 ##
  .replace(/`([^`]+)`/g, '$1')  // 移除行内代码标记  <-- 问题所在！
  .replace(/\*\*([^*]+)\*\*/g, '$1')  // 移除粗体
  .replace(/\*([^*]+)\*/g, '$1')  // 移除斜体
  .replace(/#{1,6}\s*/g, '')  // 移除所有等级的标题符号
  .trim();
```

#### 2. 根本原因确认

**第 262 行的正则表达式 `.replace(/`([^`]+)`/g, '$1')` 是导致代码块无法正常渲染的根本原因。**

这个 replace 操作会：
1. 将 `` `code` `` 转换成 `code`
2. 去除反引号后，marked 无法识别这是一个代码块
3. 导致代码块渲染失败或显示异常

**这是 R53 系列问题的真正根源！**

#### 3. 代码注释与实际行为的矛盾

查看第 256 行的注释：
```typescript
// 【修复R23.2】保留列表标记和其他markdown格式，在非编辑模式下使用marked渲染
```

这个注释说明开发者想要保留 markdown 格式，但第 262-265 行的代码却在移除代码块、粗体、斜体和标题格式。这几个 replace 操作与注释的意图相矛盾。

#### 4. 影响范围

这行代码会影响：
- 行内代码：`` `code` `` → `code`（无法渲染为代码格式）
- 粗体：`**text**` → `text`（无法渲染为粗体）
- 斜体：`*text*` → `text`（无法渲染为斜体）
- 标题符号：`#` 到 `######`（被移除）

### 解决方案

**删除第 262-265 行的代码**，让 marked 能够正确渲染这些 markdown 格式：

```typescript
let title = content
  .replace(/\[Finished\]/g, '')  // 移除 [completed]
  .replace(/\[Processing\]/g, '')  // 移除 [Processing]
  .replace(/(R\d+(?:\.\d+)*)/, '')  // 移除任务ID
  .replace(/^##?\s*/, '')  // 移除开头的 ##
  // 删除以下4行：
  // .replace(/`([^`]+)`/g, '$1')  // 移除行内代码标记
  // .replace(/\*\*([^*]+)\*\*/g, '$1')  // 移除粗体
  // .replace(/\*([^*]+)\*/g, '$1')  // 移除斜体
  // .replace(/#{1,6}\s*/g, '')  // 移除所有等级的标题符号
  .trim();
```

### 验证方式

1. 在任务块中添加行内代码：` ``code`` `
2. 在任务块中添加跨行代码块
3. 观察是否正确渲染为代码格式

### 结论

**根本原因**：parser/index.ts 中的 `.replace(/`([^`]+)`/g, '$1')` 正则表达式在解析阶段移除了行内代码标记，导致后续的 marked 渲染无法识别代码块。

**解决方案**：删除第 262-265 行的 markdown 格式移除代码，让这些格式能够被 marked 正确渲染。
