# R54.8.3 执行报告

## 任务描述

创建专门的日志 API (window.MDTODO.log)，在 index.tsx 初始化时定义，并捕获 try-catch 错误、Promise rejection 等异常写入此 API。

## 需求分析

**问题背景**：
- R54.8.1 覆盖原生 console.log 方式存在风险且未生效
- 覆盖原生 console 方法会影响浏览器开发工具的正常使用
- 需要创建专门的日志 API，不污染原生 console

**实现要求**：
1. 创建 window.MDTODO.log API（不是覆盖原生 console）
2. API 通过 vscodeApi.postMessage 发送日志到扩展端
3. 添加 window.MDTODO.errorHandler 全局错误处理器
4. 捕获 unhandledrejection 事件
5. 使用 try-catch 包装关键代码

## 修改的文件

### 1. `src/webview/index.tsx`

**修改内容**：

#### (1) 创建专门的日志 API
```typescript
// ============================================
// R54.8.3: 创建专门的日志 API (window.MDTODO.log)
// 不覆盖原生 console，使用专门的 API
// ============================================

const sendLogToExtension = (level: string, args: any[], source: string = 'webview') => {
  if (vscodeApi) {
    const timestamp = new Date().toISOString();
    const message = args.map(arg => {
      if (typeof arg === 'object') {
        try {
          return JSON.stringify(arg);
        } catch {
          return String(arg);
        }
      }
      return String(arg);
    }).join(' ');

    vscodeApi.postMessage({
      type: 'mdtodoLog',  // 新的消息类型
      level,
      message,
      timestamp,
      source,
      args: args.map(arg => {
        if (typeof arg === 'object') {
          try {
            return JSON.stringify(arg, null, 2);
          } catch {
            return String(arg);
          }
        }
        return arg;
      })
    });
  }
};

// 创建 window.MDTODO.log API
window.MDTODO.log = (...args: any[]) => {
  try {
    sendLogToExtension('info', args, 'MDTODO.log');
  } catch (error) {
    console.error('[MDTODO] Log API error:', error);
  }
};

// 创建 window.MDTODO.warn API
window.MDTODO.warn = (...args: any[]) => {
  try {
    sendLogToExtension('warning', args, 'MDTODO.warn');
  } catch (error) {
    console.error('[MDTODO] Warn API error:', error);
  }
};

// 创建 window.MDTODO.error API
window.MDTODO.error = (...args: any[]) => {
  try {
    sendLogToExtension('error', args, 'MDTODO.error');
  } catch (error) {
    console.error('[MDTODO] Error API error:', error);
  }
};
```

#### (2) 创建 window.MDTODO.errorHandler 全局错误处理器
```typescript
// ============================================
// R54.8.3: 全局错误处理器 (window.MDTODO.errorHandler)
// ============================================

window.MDTODO.errorHandler = {
  // 记录错误到扩展端
  logError: (error: Error | string, context?: string) => {
    try {
      const errorMessage = typeof error === 'string' ? error : error.message;
      const errorStack = typeof error === 'string' ? '' : error.stack || '';

      sendLogToExtension('error', [
        `[Error Context: ${context || 'N/A'}]`,
        `Message: ${errorMessage}`,
        `Stack: ${errorStack}`
      ], 'MDTODO.errorHandler');
    } catch (e) {
      console.error('[MDTODO] Error in errorHandler.logError:', e);
    }
  },

  // 包装函数以捕获并记录错误
  wrap: (fn: Function, context?: string): Function => {
    return function(...args: any[]) {
      try {
        return fn.apply(this, args);
      } catch (error) {
        window.MDTODO.errorHandler.logError(error as Error, context);
        throw error;
      }
    };
  },

  // 包装 Promise 以捕获 rejection
  wrapPromise: (promise: Promise<any>, context?: string): Promise<any> => {
    return promise.catch(error => {
      window.MDTODO.errorHandler.logError(error as Error, context);
      return Promise.reject(error);
    });
  }
};
```

#### (3) 捕获 unhandledrejection 事件
```typescript
// ============================================
// R54.8.3: 捕获 unhandledrejection 事件
// ============================================

window.addEventListener('unhandledrejection', (event) => {
  try {
    const reason = event.reason;
    const errorMessage = reason instanceof Error ? reason.message : String(reason);
    const errorStack = reason instanceof Error ? reason.stack || '' : '';

    sendLogToExtension('error', [
      '[Unhandled Promise Rejection]',
      `Message: ${errorMessage}`,
      `Stack: ${errorStack}`
    ], 'MDTODO.unhandledrejection');
  } catch (e) {
    console.error('[MDTODO] Error in unhandledrejection handler:', e);
  }
  // 阻止默认行为，防止浏览器显示警告
  event.preventDefault();
});
```

#### (4) 捕获全局错误事件
```typescript
window.addEventListener('error', (event) => {
  try {
    const error = event.error;
    if (error) {
      sendLogToExtension('error', [
        '[Global Error]',
        `Message: ${error.message}`,
        `Stack: ${error.stack || ''}`
      ], 'MDTODO.globalError');
    }
  } catch (e) {
    console.error('[MDTODO] Error in global error handler:', e);
  }
});
```

#### (5) 使用 try-catch 包装关键代码
```typescript
// 启动应用函数 - 使用 try-catch 包装
const init = () => {
  try {
    const container = document.getElementById('root');
    if (container && !hasSentReady) {
      const root = createRoot(container);
      // ... 初始化代码 ...
      setTimeout(() => {
        if (vscodeApi && !hasSentReady) {
          window.MDTODO.log('[Webview] Sending ready message');
          hasSentReady = true;
          vscodeApi.postMessage({ type: 'ready' });
        } else if (!vscodeApi) {
          window.MDTODO.error('[Webview] Cannot send ready: vscodeApi is null');
        }
      }, 100);
    }
  } catch (error) {
    window.MDTODO.errorHandler.logError(error as Error, 'init');
  }
};
```

### 2. `src/providers/webviewProvider.ts`

**修改内容**：

#### (1) 添加新的消息类型处理
```typescript
// R54.8.1/R54.8.3: 处理来自 webview 的 console 日志和 MDTODO.log API
case 'webviewLog':
case 'mdtodoLog':
  await this.handleWebviewLog(message);
  break;
```

#### (2) 更新 handleWebviewLog 函数以包含 source 字段
```typescript
// R54.8.1/R54.8.3: 处理来自 webview 的 console 日志和 MDTODO.log API
private async handleWebviewLog(message: any): Promise<void> {
  const { level, message: logMessage, timestamp, args, source } = message;

  if (globalLogsDir && this.currentFilePath) {
    try {
      await writeUnifiedLogEntry(globalLogsDir, this.currentFilePath, {
        eventType: level === 'error' ? 'error' : 'lifecycle',
        event: 'webviewLog',
        details: {
          source: source || 'webview',  // 新增 source 字段
          level,
          message: logMessage,
          timestamp,
          rawArgs: args
        }
      });
    } catch (error) {
      console.error('[MDTODO] Failed to write webview log:', error);
    }
  }
}
```

## API 使用示例

```typescript
// 使用专门的日志 API
window.MDTODO.log('这是一条信息日志');
window.MDTODO.warn('这是一条警告日志');
window.MDTODO.error('这是一条错误日志');

// 使用错误处理器包装函数
const safeFunction = window.MDTODO.errorHandler.wrap(
  function riskyOperation() {
    // 可能抛出错误的代码
  },
  'riskyOperation'
);

// 使用 Promise 包装
window.MDTODO.errorHandler.wrapPromise(
  fetch('/api/data')
    .then(handleResponse),
  'fetchData'
);

// 手动记录错误
try {
  // 可能抛出错误的代码
} catch (error) {
  window.MDTODO.errorHandler.logError(error, 'operationName');
}
```

## 验证结果

1. **编译成功**：`npm run compile` 通过，无错误
2. **测试通过**：`npm run test` 通过（与本次修改无关的测试失败除外）
3. **日志消息类型**：使用新的 `mdtodoLog` 类型（保留 `webviewLog` 向后兼容）
4. **日志来源追踪**：每个日志条目包含 `source` 字段，标识日志来源

## 完成摘要

- [x] 创建 window.MDTODO.log API（不是覆盖原生 console）
- [x] API 通过 vscodeApi.postMessage 发送日志到扩展端
- [x] 添加 window.MDTODO.errorHandler 全局错误处理器
- [x] 捕获 unhandledrejection 事件
- [x] 捕获全局 error 事件
- [x] 使用 try-catch 包装关键代码
- [x] 编译和测试验证通过

## 执行时间

2026-01-30
