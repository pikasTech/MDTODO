# R53.9.1 任务完成报告

## 任务目标

实现任务ID层级计算函数并修改 TaskList.tsx 和 TaskItem.tsx 使缩进由任务ID决定且不超过2级。

## 实现内容

### 1. 创建层级计算函数

在 `TaskList.tsx` 和 `TaskItem.tsx` 中添加了 `calculateTaskDepth` 函数：

```typescript
// Maximum depth level for indentation (0 = level 1, 1 = level 2, max 2 levels total)
const MAX_DEPTH = 1;

/**
 * Calculate the depth level from a task ID.
 * R1 -> depth 0 (level 1, 0 dots)
 * R1.1 -> depth 1 (level 2, 1 dot)
 * R1.1.1 -> depth 1 (capped at max, 2 dots but max depth is 1)
 */
const calculateTaskDepth = (taskId: string): number => {
  const dotCount = (taskId.match(/\./g) || []).length;
  return Math.min(dotCount, MAX_DEPTH);
};
```

**层级映射规则：**
| 任务ID | 点号数量 | 计算结果 |
|--------|----------|----------|
| R1 | 0 | depth = 0 (1级) |
| R1.1 | 1 | depth = 1 (2级) |
| R1.1.1 | 2 | depth = 1 (限制为2级) |
| R2.3.5.7 | 3 | depth = 1 (限制为2级) |

### 2. 修改 TaskList.tsx

**修改位置：** 第 365-371 行

**修改内容：**
```typescript
// 修改前
depth: 0,

// 修改后
depth: calculateTaskDepth(task.id),
```

**修改文件：** `d:\Work\vscode-mdtodo\src\webview\components\TaskList.tsx`

### 3. 修改 TaskItem.tsx

#### 3.1 添加层级计算函数

**修改位置：** 第 5-19 行

在文件开头添加了 `calculateTaskDepth` 函数和 `MAX_DEPTH` 常量。

#### 3.2 修改 childrenStyle

**修改位置：** 第 175-181 行

```typescript
// 修改前
const childrenStyle = {
  maxHeight: isExpanded ? '10000px' : `${PREVIEW_MAX_HEIGHT}px`,
  marginLeft: `${24 + depth * 16}px`,
  ...
};

// 修改后
const childrenStyle = {
  maxHeight: isExpanded ? '10000px' : `${PREVIEW_MAX_HEIGHT}px`,
  marginLeft: `${24 + calculateTaskDepth(task.id) * 16}px`,
  ...
};
```

#### 3.3 修改子任务传递

**修改位置：** 第 376-381 行

```typescript
// 修改前
React.createElement(TaskItem, {
  key: child.id,
  task: child,
  depth: depth + 1,
  ...
})

// 修改后
React.createElement(TaskItem, {
  key: child.id,
  task: child,
  depth: calculateTaskDepth(child.id),
  ...
})
```

**修改文件：** `d:\Work\vscode-mdtodo\src\webview\components\TaskItem.tsx`

## 验证结果

### 编译成功

```
webpack 5.104.1 compiled successfully in 7612 ms
webpack 5.104.1 compiled successfully in 9872 ms
```

- `extension.js`: 59.5 KiB
- `bundle.js`: 238 KiB (含 React webview)

### 影响说明

此修改仅影响渲染显示效果，不影响其他执行逻辑：
- 任务数据的层级结构保持不变
- 任务的展开/折叠、编辑、删除等操作逻辑不变
- 缩进样式根据任务ID动态计算，最大限制为2级

## 修改文件清单

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `src/webview/components/TaskList.tsx` | 修改 | 添加层级计算函数，修改根任务depth传递 |
| `src/webview/components/TaskItem.tsx` | 修改 | 添加层级计算函数，修改childrenStyle和子任务depth传递 |
| `out/extension.js` | 生成 | TypeScript编译产物 |
| `resources/bundle.js` | 生成 | webpack打包产物 |
