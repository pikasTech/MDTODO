# R55.5 任务报告：修复重复触发任务执行问题

## 问题描述

点击一次执行任务按钮后，任务被重复执行了两次，导致打开两个终端窗口。

## 问题原因

**根本原因**：消息监听器被重复注册

在 `src/providers/webviewProvider.ts` 的 `showPanel` 方法中（第 76-80 行），每次调用 `showPanel` 都会注册新的消息监听器：

```typescript
// 问题代码
showPanel(filePath?: string, tasks?: TodoTask[]): void {
  // ...
  this.panelManager.showPanel(this.currentFilePath, tasks);

  // 每次调用都会注册新的监听器！
  this.panelManager.getPanel()?.webview.onDidReceiveMessage(
    this.handleMessage.bind(this),
    undefined,
    this.context.subscriptions
  );

  // ...
}
```

**问题发生流程**：
1. 当 `showPanel()` 被调用时（无论面板是否存在），都会执行 `onDidReceiveMessage` 注册消息监听器
2. 如果面板已存在 (`this.panel` 存在)，面板只是 `reveal()` 不会重新创建，但消息监听器仍会被重复注册
3. 由于 `this.context.subscriptions` 不断累积监听器，导致同一个 webview 消息被多个监听器处理
4. 当用户点击执行按钮时，`claudeExecute` 消息被发送多次
5. `handleClaudeExecute` 方法被调用多次，导致任务被重复执行

## 修复方案

在 `src/providers/webviewProvider.ts` 中添加 `messageListenerRegistered` 标志位，确保消息监听器只注册一次：

```typescript
export class TodoWebviewProvider {
  // ... 其他成员变量
  private messageListenerRegistered = false;

  showPanel(filePath?: string, tasks?: TodoTask[]): void {
    // ...
    this.panelManager.showPanel(this.currentFilePath, tasks);

    // 只注册一次消息监听器，避免重复触发
    if (!this.messageListenerRegistered) {
      this.panelManager.getPanel()?.webview.onDidReceiveMessage(
        this.handleMessage.bind(this),
        undefined,
        this.context.subscriptions
      );
      this.messageListenerRegistered = true;
    }
    // ...
  }
}
```

## 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `src/providers/webviewProvider.ts` | 添加 `messageListenerRegistered` 标志位，修改 `showPanel` 方法确保只注册一次监听器 |
| `test/r55_5_message_listener.test.ts` | 新增单元测试，验证修复逻辑 |

## 测试验证

运行测试验证修复：
```
npm run test -- --testPathPatterns="r55_5"
```

测试结果：
- `消息监听器应该只注册一次，即使 showPanel 被调用多次` - PASS
- `验证修复后的 TodoWebviewProvider 标志位行为` - PASS
- `如果没有面板，不应该注册消息监听器` - PASS

编译验证：
```
npm run compile
```
编译成功，无错误。

## 结论

R55.5 问题已修复。通过添加 `messageListenerRegistered` 标志位，确保消息监听器在 `showPanel` 方法中只注册一次，避免了重复触发任务执行的问题。
