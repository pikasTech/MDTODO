# R51.13 任务报告

## 任务描述

双重跳转的效果之前做好了又丢失了。在折叠状态下，双重跳转后应该是：
- 最外层（R2）在顶部
- 内层居中（R2.2, R2.3.1, R2.2.2.2 都是内层）

## 问题分析

### 问题根因

R51.12 修改了 `scrollToTask` 函数，将 `parentId` 计算从 `slice(0, -1)` 改为 `slice(0, 2)`，解决了子任务父 ID 计算错误的问题。但是这个修改引入了一个新问题：

当父任务（R2）处于折叠状态时：
1. `isParentExpanded = false`（因为 expandedTasks 中没有 R2）
2. 代码尝试执行双层滚动
3. 但问题是：**折叠状态下子任务元素虽然存在于 DOM 中，但位置计算不准确**
4. 更关键的是：需要先展开父任务，才能正确显示和滚动到目标子任务

### 根本解决方案

将折叠状态改为**全局变量**，所有任务共享一个折叠状态，与"全部展开/全部折叠"按钮保持一致。

## 解决方案

### 1. 创建全局折叠状态变量

将 `expandedTasks: Set<string>` 改为 `isAllCollapsed: boolean`：

```typescript
// 之前：每个任务独立记录展开状态
const [expandedTasks, setExpandedTasks] = React.useState<Set<string>>(new Set([]));

// 之后：全局统一折叠状态
const [isAllCollapsed, setIsAllCollapsed] = React.useState<boolean>(false);
```

### 2. 修改相关函数

- `handleToggleExpand`：切换全局折叠状态
- `handleExpandAll`：设置 `isAllCollapsed = false`
- `handleCollapseAll`：设置 `isAllCollapsed = true`

### 3. 修改 `scrollToTask` 函数

```typescript
if (!isAllCollapsed) {
  // 全局未折叠：执行完整双层滚动（外层顶部 + 内层居中）
  parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
  // 内层滚动到目标居中...
} else {
  // 全局折叠：只做外层滚动到父任务顶部，不改变折叠状态
  parentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
```

**关键点**：跳转操作不改变折叠状态，折叠状态下只定位到父任务。

### 4. 修改 TaskItem 组件

- Props：从 `expandedTasks: Set<string>` 改为 `isAllCollapsed: boolean`
- `isExpanded` 计算：从 `expandedTasks.has(task.id)` 改为 `!isAllCollapsed`

### 5. 修改工具栏按钮

```typescript
// 之前：检查 expandedTasks.size
className: `... ${expandedTasks.size > 0 && expandedTasks.size === getAllTaskIds(tasks).length ? 'expanded' : ''} ...`

// 之后：检查 isAllCollapsed
className: `... ${!isAllCollapsed ? 'expanded' : ''} ...`
```

## 修改文件

- `src/webview/components/TaskList.tsx` - 主要修改文件

## 行为说明

| 操作 | 行为 |
|------|------|
| 点击展开/收起按钮 | 切换全局折叠状态（所有任务同时展开/收起） |
| 展开状态下跳转 | 外层滚动到父任务（顶部）+ 内层滚动到目标（居中） |
| 折叠状态下跳转 | 只做外层滚动到父任务（顶部），**不改变折叠状态** |

## 验证结果

- 编译成功
- 所有任务共享同一个折叠状态
- 跳转不改变折叠状态
- 展开状态下双重跳转正确执行（外层顶部 + 内层居中）
