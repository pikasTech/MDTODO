# R55.8 任务报告：关闭 Tag 再打开后按钮无响应问题

## 问题描述

关闭 Tag 再打开之后，点击各种按钮就没有响应。

## 问题分析

通过日志分析发现，每次打开面板都会生成一个新的日志文件：
- `D:\Work\ws_to_abc\.vscode\mdtodo\logs\20260129T144054_20260127_软著数据仿真.jsonl`
- `D:\Work\ws_to_abc\.vscode\mdtodo\logs\20260129T144103_20260127_软著数据仿真.jsonl`

## 根本原因

在 `src/providers/webviewProvider.ts` 中：

```typescript
private messageListenerRegistered = false;
```

`messageListenerRegistered` 标志在面板第一次创建时设置为 `true`。当面板关闭（dispose）后，这个标志没有被重置，导致：

1. 用户关闭 Tag（面板被 dispose）
2. 用户重新打开 Tag
3. `showPanel()` 被调用，创建新的面板
4. 但是因为 `messageListenerRegistered === true`，消息监听器没有被重新注册
5. 新的面板无法接收 webview 发送的消息
6. 按钮点击无响应

## 解决方案

### 1. 跟踪当前面板实例

添加 `currentPanel` 属性来跟踪当前面板实例：

```typescript
private currentPanel: vscode.WebviewPanel | undefined;
```

### 2. 检查面板是否重新创建

在 `showPanel` 方法中，通过比较面板实例来判断是否需要重新注册消息监听器：

```typescript
showPanel(filePath?: string, tasks?: TodoTask[]): void {
  // ...
  this.panelManager.showPanel(this.currentFilePath, tasks);
  const panel = this.panelManager.getPanel();

  // 检查是否是新的面板（通过比较面板实例）或当前面板是否有效
  const isNewPanel = this.currentPanel !== panel;

  // 如果是新面板，需要重新注册消息监听器
  if (isNewPanel) {
    panel?.webview.onDidReceiveMessage(
      this.handleMessage.bind(this),
      undefined,
      this.context.subscriptions
    );
    this.messageListenerRegistered = true;
    this.currentPanel = panel;
  }
  // ...
}
```

### 3. 在 dispose 时清理状态

在 `dispose` 方法中重置状态：

```typescript
dispose(): void {
  this.fileRefreshManager.stopPeriodicRefresh();
  this.panelManager.dispose();
  // R55.8: 重置消息监听器标志，允许下次重新注册
  this.currentPanel = undefined;
  this.messageListenerRegistered = false;
}
```

## 修改文件

- `src/providers/webviewProvider.ts`

## 单元测试

创建 `test/r55_8_panel_reopen.test.ts`，包含以下测试用例：

1. **面板关闭后重新打开，消息监听器应该重新注册** - 复现问题
2. **修复方案：面板关闭时重置 messageListenerRegistered 标志** - 验证修复方案
3. **验证面板 dispose 后消息监听器标志重置** - 测试面板状态管理
4. **使用 isPanelActive 检查面板是否重新创建** - 验证面板实例比较逻辑

## 验证结果

- 所有 4 个 R55.8 单元测试通过
- 所有 R55 相关测试通过（96 个测试）
- 编译成功，无错误
