## R54.3 任务报告

### 任务目标
将实际执行的命令拆分为命令生成和命令执行两部分，复制命令功能复用拆分后的命令生成函数，确保复制的命令与实际执行的命令完全一致。

### 问题分析

**原实现存在的问题：**

1. **实际执行命令** (`claudeService.ts`)：
   - 使用 `generateClaudeExecuteArgs` 函数生成参数字符串：`execute "${relativePath} 中的 ${taskId} 任务"`
   - 通过 spawn 调用执行，命令参数分开传递

2. **复制命令** (`TaskList.tsx:879`)：
   - 独立构造命令字符串，未复用命令生成逻辑
   - 路径处理方式不同（直接取文件名，而非相对路径）

**命令格式差异：**
- 实际执行：`claude --dangerously-skip-permissions execute "path 中的 R1 任务"`
- 复制命令：格式可能不一致，取决于 webview 中的路径处理逻辑

### 解决方案

#### 1. 提取命令生成函数 (`claudeService.ts:37-51`)

```typescript
/**
 * 【R54.3】生成 Claude 执行命令的参数字符串
 * 返回格式化的任务描述字符串，用于 --dangerously-skip-permissions 参数
 */
export function generateClaudeExecuteArgs(todoFilePath: string, taskId: string): string {
  const workspacePath = getWorkspaceFolderPath();
  let relativePath = todoFilePath;

  if (workspacePath) {
    relativePath = toRelativePath(todoFilePath, workspacePath);
  }

  // 返回 execute 命令的参数部分（不包含 claude 和 --dangerously-skip-permissions）
  return `execute "${relativePath} 中的 ${taskId} 任务"`;
}
```

#### 2. 修改实际执行方法使用命令生成函数

- `executeTask()` 方法：使用 `generateClaudeExecuteArgs` 获取参数字符串
- `executeTaskInTerminal()` 方法：同样使用该函数确保命令格式一致

#### 3. 添加 webview 消息处理 (`webviewProvider.ts`)

- 导入 `generateClaudeExecuteArgs` 函数
- 新增 `handleGenerateExecuteCommand()` 方法处理 `generateExecuteCommand` 消息
- 生成完整命令并通过 `executeCommandGenerated` 消息发送回 webview

#### 4. 修改复制命令逻辑 (`TaskList.tsx`)

- `handleCopyExecuteCommand()`：改为发送消息给 extension，请求生成执行命令
- 添加 `executeCommandGenerated` 消息处理：接收命令并复制到剪贴板

### 修改的文件

1. `src/services/claudeService.ts`
   - 导出 `generateClaudeExecuteArgs` 函数
   - `executeTask()` 和 `executeTaskInTerminal()` 方法复用该函数

2. `src/providers/webviewProvider.ts`
   - 导入 `generateClaudeExecuteArgs`
   - 添加 `generateExecuteCommand` 消息处理
   - 添加 `handleGenerateExecuteCommand()` 方法

3. `src/webview/components/TaskList.tsx`
   - 简化 `handleCopyExecuteCommand()` 函数
   - 添加 `executeCommandGenerated` 消息处理

### 命令流程

```
用户右键选择"复制执行命令"
    ↓
webview 发送 { type: 'generateExecuteCommand', taskId: 'R1' }
    ↓
extension 接收消息，调用 generateClaudeExecuteArgs 生成参数字符串
    ↓
组合完整命令: claude --dangerously-skip-permissions execute "path 中的 R1 任务"
    ↓
extension 发送 { type: 'executeCommandGenerated', command: '...' }
    ↓
webview 接收消息，复制命令到剪贴板
```

### 验证结果

编译成功，命令生成逻辑统一由 `generateClaudeExecuteArgs` 函数处理，复制命令与实际执行命令格式完全一致。
