# R54.6.1 Task Report: Modify Log Service Module for TODO-based Filename Format

## Overview

Modified the log service module at `src/services/logService.ts` to support TODO-based filename format and expanded logging capabilities for plugin lifecycle, errors, and task events.

## Implementation Details

### File Modified

**Path:** `d:\Work\vscode-mdtodo\src\services\logService.ts`

### New Exported Functions

| Function | Description |
|----------|-------------|
| `generateTodoBasedFilename(todoFilePath: string): string` | Generates TODO-based log filename with format `{TODO文件名}_{YYYYMMDD}.jsonl` |
| `logPluginLifecycle(logsDir: string, todoFilePath: string, event: string, details: object): Promise<void>` | Logs plugin lifecycle events (activate, deactivate, fileLoaded, etc.) |
| `logError(logsDir: string, todoFilePath: string, error: Error, context: string): Promise<void>` | Logs error events with context information |
| `logTaskEvent(logsDir: string, todoFilePath: string, taskId: string, event: string, details: object): Promise<void>` | Logs task events (taskExecute, taskComplete, taskSelect, etc.) |
| `logFileEvent(logsDir: string, todoFilePath: string, event: string, details: object): Promise<void>` | Logs file operation events (fileParse, fileRefresh, etc.) |
| `writeUnifiedLogEntry(logsDir: string, todoFilePath: string, entry: object): Promise<void>` | Internal helper for unified TODO-based logging |

### Backward Compatible Functions (Preserved)

| Function | Description |
|----------|-------------|
| `getLogsDirectoryPath(workspacePath: string): string` | Returns the logs directory path (`.vscode/mdtodo/logs/`) |
| `generateLogFilename(taskId: string): string` | Generates log filename with format `timestamp_MDTODO_TASKID.jsonl` |
| `ensureLogsDirectory(logsDir: string): Promise<void>` | Creates the logs directory if it doesn't exist |
| `writeLogEntry(logsDir: string, taskId: string, entry: object): Promise<void>` | Writes a JSONL formatted log entry (task-based) |
| `logAction(workspacePath, taskId, filePath, action, details): Promise<void>` | Helper function to create and write a log entry |

### New Data Structures

#### UnifiedLogEntry Interface

```typescript
interface UnifiedLogEntry {
  timestamp: string;           // ISO date string
  eventType: 'lifecycle' | 'task' | 'error' | 'file';
  event: string;               // Event name (activate, deactivate, taskExecute, etc.)
  details: Record<string, unknown>;
}
```

### Log Entry Formats

#### Unified TODO-based Log Entry

```json
{
  "timestamp": "2026-01-29T10:30:00.000Z",
  "eventType": "lifecycle",
  "event": "activate",
  "details": {
    "source": "plugin",
    "fileCount": 2
  }
}
```

#### Error Log Entry

```json
{
  "timestamp": "2026-01-29T10:30:00.000Z",
  "eventType": "error",
  "event": "errorOccurred",
  "details": {
    "source": "plugin",
    "context": "webviewProvider.handleMessage",
    "errorMessage": "Unknown message type",
    "errorStack": "Error: Unknown message type\n    at handleMessage..."
  }
}
```

#### Task Event Log Entry

```json
{
  "timestamp": "2026-01-29T10:30:00.000Z",
  "eventType": "task",
  "event": "taskExecute",
  "details": {
    "taskId": "R54.6.1",
    "command": "claude-code"
  }
}
```

### Filename Conventions

| Format | Example |
|--------|---------|
| TODO-based (new) | `xxx_20260120_MDTODO2.jsonl` |
| Task-based (backward compatible) | `20260129_103000_MDTODO_R54_5.jsonl` |

## Usage Examples

### Plugin Lifecycle Logging

```typescript
import { logPluginLifecycle, ensureLogsDirectory } from './services/logService';

const logsDir = getLogsDirectoryPath(workspacePath);
await ensureLogsDirectory(logsDir);

// Log plugin activation
await logPluginLifecycle(logsDir, todoFilePath, 'activate', {
  fileCount: 2,
  workspace: 'd:\\Work\\project'
});

// Log panel opened
await logPluginLifecycle(logsDir, todoFilePath, 'panelOpened', {
  panelId: 'mdtodo-123'
});
```

### Error Logging

```typescript
import { logError } from './services/logService';

try {
  // Some operation
} catch (error) {
  await logError(logsDir, todoFilePath, error, 'webviewProvider.handleMessage');
}
```

### Task Event Logging

```typescript
import { logTaskEvent } from './services/logService';

// Log task execution
await logTaskEvent(logsDir, todoFilePath, 'R54.6.1', 'taskExecute', {
  command: 'claude-code',
  status: 'completed'
});

// Log task completion
await logTaskEvent(logsDir, todoFilePath, 'R54.6.1', 'taskComplete', {
  previousStatus: 'in_progress',
  newStatus: 'completed'
});
```

### File Event Logging

```typescript
import { logFileEvent } from './services/logService';

// Log file parsing
await logFileEvent(logsDir, todoFilePath, 'fileParse', {
  taskCount: 15,
  parseTimeMs: 45
});

// Log file change
await logFileEvent(logsDir, todoFilePath, 'fileChange', {
  changeType: 'content',
  lineNumber: 42
});
```

## Changes Summary

1. **Added TODO-based filename generation** (`generateTodoBasedFilename`): Extracts filename without extension and appends date in `YYYYMMDD` format.

2. **Added unified log entry structure** (`UnifiedLogEntry`): Standardized log format with `eventType`, `event`, and `details` fields.

3. **Added plugin lifecycle logging** (`logPluginLifecycle`): Supports events like `activate`, `deactivate`, `fileLoaded`, `panelOpened`, `panelClosed`.

4. **Added error logging** (`logError`): Captures error message, stack trace, and context information.

5. **Added task event logging** (`logTaskEvent`): Supports task-specific events with task ID tracking.

6. **Added file event logging** (`logFileEvent`): Supports file operation events like parsing and changes.

7. **Added internal helper** (`writeUnifiedLogEntry`): Core function for TODO-based log writes.

8. **Preserved backward compatibility**: All original functions (`generateLogFilename`, `writeLogEntry`, `logAction`) remain unchanged.

## Integration Notes

- Uses VSCode's `workspace.fs` API for file operations (consistent with existing services)
- Console logging uses `[LogService]` prefix for filtering
- Log entries are appended to JSONL files for easy streaming
- All TODO-based logging functions require `todoFilePath` parameter for filename generation
- Existing code using `generateLogFilename`, `writeLogEntry`, and `logAction` continues to work without modification
