# R54.6.6 任务执行报告

## 任务描述

**问题**：日志系统生成了多个日志文件，没有写到同一个生命周期内的 jsonl 中。

**错误日志文件**：
- `.vscode\mdtodo\logs\20260129T145830_20250121-自噪声2修-TODO.jsonl`
- `.vscode\mdtodo\logs\20260129070444_MDTODO_R6_1.jsonl`
- `.vscode\mdtodo\logs\20260129070617_MDTODO_R6_1.jsonl`

**期望行为**：一次插件生命周期内只应当存在一个 `.jsonl` 日志文件。

## 问题分析

根本原因：`claudeService.ts` 使用了旧的 `logAction` 函数，该函数调用 `writeLogEntry` 生成独立的文件名（如 `YYYYMMDDHHmmss_MDTODO_Rx_x.jsonl`），而不是使用 R54.6.5 实现的统一会话日志系统。

## 解决方案

修改 `claudeService.ts` 使用新的 `logTaskEvent` 函数替代旧的 `logAction` 函数：

### 修改文件

**`src/services/claudeService.ts`**

1. 更新导入语句：
   ```typescript
   // 旧
   import { logAction } from './logService';
   // 新
   import { logTaskEvent, getSessionTodoFilePath, getLogsDirectoryPath, ensureLogsDirectory } from './logService';
   ```

2. 修改 `executeTask` 方法：
   ```typescript
   // 旧
   await logAction(workspacePath, taskId, todoFilePath, 'execute_start', {...});
   // 新
   const logsDir = getLogsDirectoryPath(workspacePath);
   await ensureLogsDirectory(logsDir);
   await logTaskEvent(logsDir, todoFilePath, taskId, 'taskExecute', {...});
   ```

3. 修改 `executeTaskInTerminal` 方法（同样的修改模式）

4. 添加了适当的 null 检查以处理 `workspacePath` 可能为 `undefined` 的情况

### 更新 Mock

**`test/__mocks__/vscode.ts`**
- 添加了 `window` 对象的 mock
- 添加了 `workspace.workspaceFolders` 的 mock
- 初始化 `readFile` 和 `writeFile` 的默认返回值

## 单元测试

创建了新的测试文件 `test/r54_6_6_claudeService_unifiedLogging.test.ts`，包含以下测试用例：

1. `executeTask logs to session file` - 验证任务执行使用会话日志文件名
2. `executeTaskInTerminal logs to session file` - 验证终端执行使用会话日志文件名
3. `Multiple task executions write to same session file` - 验证多次任务执行写入同一文件
4. `ClaudeService log entries have correct structure` - 验证日志条目结构正确
5. `No duplicate log files generated for same session` - 验证不会生成重复日志文件

## 测试结果

```
PASS test/r54_6_6_claudeService_unifiedLogging.test.ts
  R54.6.6 - ClaudeService Unified Logging Tests
    √ R54.6.6: executeTask logs to session file (not separate MDTODO_Rx_x.jsonl)
    √ R54.6.6: executeTaskInTerminal logs to session file
    √ R54.6.6: Multiple task executions write to same session file
    √ R54.6.6: ClaudeService log entries have correct structure
    √ R54.6.6: No duplicate log files generated for same session
```

同时验证了所有现有的 R54.5 和 R54.6 相关测试仍然通过。

## 日志格式

修复后，所有日志事件将写入统一格式的文件：

- **文件名**：`YYYYMMDDTHHMMss_{TODO文件名}.jsonl`
- **日志位置**：`.vscode/mdtodo/logs/`
- **日志结构**（统一日志条目）：
  ```json
  {
    "timestamp": "2026-01-29T15:30:00.000Z",
    "eventType": "task",
    "event": "taskExecute",
    "details": {
      "taskId": "R54.6.6",
      "command": "claude --dangerously-skip-permissions execute ...",
      "mode": "new_terminal",
      "platform": "win32"
    }
  }
  ```

## 总结

R54.6.6 修复完成：
- 解决了日志系统生成多个独立文件的问题
- 所有任务执行日志现在写入统一的会话日志文件
- 新增单元测试确保修复正确性
- 所有相关测试全部通过
