# R56.1 代码拆分实施计划

## 目标

将 `src/webview/components/TaskList.tsx` 拆分为更小的模块：
- `TaskItem.tsx` - 单个任务渲染组件
- `TaskBlock.tsx` - 文本块编辑组件
- `types.ts` - 共享类型和常量
- `index.ts` - 统一导出

## 详细步骤

### 步骤 1: 创建 types.ts

**文件**: `src/webview/components/types.ts`

**内容**:
```typescript
// Task 接口
export interface Task {
  id: string;
  title: string;
  rawContent: string;
  completed: boolean;
  processing: boolean;
  children?: Task[];
  lineNumber?: number;
  linkCount: number;
  linkExists: number;
}

// TextBlock 接口
export interface TextBlock {
  id: string;
  content: string;
  rawContent: string;
  lineNumber: number;
}

// FilterType 接口
export interface FilterType {
  type: 'all' | 'active' | 'hide-completed' | 'processing';
  label: string;
}

// BUTTON_IDS 常量
export const BUTTON_IDS = {
  EXPAND_ALL: 'expandAll',
  COLLAPSE_ALL: 'collapseAll',
  TOGGLE_COMPLETE: 'toggleComplete',
  REFRESH: 'refresh',
  OPEN_FILE: 'openFile',
  OPEN_SOURCE_FILE: 'openSourceFile',
  ADD_TASK: 'addTask',
  DELETE_TASK: 'deleteTask',
  ADD_SUB_TASK: 'addSubTask',
  CONTINUE_TASK: 'continueTask',
  SCROLL_TO_TOP: 'scrollToTop',
  SCROLL_TO_BOTTOM: 'scrollToBottom',
  JUMP_TO_NEXT: 'jumpToNext',
} as const;
```

### 步骤 2: 创建 TaskItem.tsx

**文件**: `src/webview/components/TaskItem.tsx`

**内容**: 从 TaskList.tsx 移入 TaskItem 组件（第 1615-2075 行）

**依赖**:
- 从 `types.ts` 导入 `Task` 和 `BUTTON_IDS`
- 从 `marked` 导入 `marked`

**需要调整**:
- 添加 React 导入
- 添加 `marked` 导入

### 步骤 3: 创建 TaskBlock.tsx

**文件**: `src/webview/components/TaskBlock.tsx`

**内容**: 从 TaskList.tsx 移入 `EditableContentBlock` 组件和 `renderTextBlocks` 函数

**依赖**:
- 从 `types.ts` 导入 `TextBlock`
- 从 `marked` 导入 `marked`

**需要调整**:
- 将组件重命名为 `TaskBlock`
- 将 renderTextBlocks 作为内部函数或导出
- 添加 props 类型定义

### 步骤 4: 修改 TaskList.tsx

**修改内容**:
1. 从 `types.ts` 导入共享类型和常量
2. 从 `TaskItem.tsx` 导入 `TaskItem` 组件
3. 从 `TaskBlock.tsx` 导入 `TaskBlock` 相关组件/函数
4. 移除 TaskItem 组件定义（第 1615-2075 行）
5. 移除 `EditableContentBlock` 组件定义（第 1137-1244 行）
6. 保留主组件和所有共享逻辑

### 步骤 5: 创建 index.ts

**文件**: `src/webview/components/index.ts`

**内容**:
```typescript
export { TaskList } from './TaskList';
export { TaskItem } from './TaskItem';
export { TaskBlock, TaskBlockProps } from './TaskBlock';
export * from './types';
```

### 步骤 6: 验证编译

运行 `npm.cmd run compile` 验证拆分后代码编译正常。

## 风险点

1. **导入路径**: 确保各文件的导入路径正确
2. **类型依赖**: TaskItem 和 TaskBlock 依赖 TaskList 中的部分类型，需要正确提取到 types.ts
3. **marked 导入**: 两个子组件都需要 marked，需要保持导入一致性

## 预期结果

- `TaskList.tsx`: 从 2077 行减少到约 1500 行
- `TaskItem.tsx`: 约 460 行
- `TaskBlock.tsx`: 约 150 行（含 renderTextBlocks）
- `types.ts`: 约 80 行
- `index.ts`: 约 10 行
- `TaskList.css`: 保持 1244 行（不变）

总文件数: 6 个（原来是 2 个）
